<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Harbor共享存储高可用 | 严千屹博客</title><meta name="author" content="严千屹"><meta name="copyright" content="严千屹"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="NFS+postgresql+Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Harbor共享存储高可用">
<meta property="og:url" content="https://blog.qianyios.top/posts/40301/index.html">
<meta property="og:site_name" content="严千屹博客">
<meta property="og:description" content="NFS+postgresql+Redis">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.qianyios.top/img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/Snipaste_2024-04-30_18-31-45.png">
<meta property="article:published_time" content="2024-04-30T10:52:40.000Z">
<meta property="article:modified_time" content="2025-07-12T11:05:14.220Z">
<meta property="article:author" content="严千屹">
<meta property="article:tag" content="OpenEuler">
<meta property="article:tag" content="Harbor">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.qianyios.top/img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/Snipaste_2024-04-30_18-31-45.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Harbor共享存储高可用",
  "url": "https://blog.qianyios.top/posts/40301/",
  "image": "https://blog.qianyios.top/img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/Snipaste_2024-04-30_18-31-45.png",
  "datePublished": "2024-04-30T10:52:40.000Z",
  "dateModified": "2025-07-12T11:05:14.220Z",
  "author": [
    {
      "@type": "Person",
      "name": "严千屹",
      "url": "https://blog.qianyios.top"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.qianyios.top/posts/40301/index.html"><link rel="preconnect"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 严千屹","link":"链接: ","source":"来源: 严千屹博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Harbor共享存储高可用',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1232762_lfyb6ri0kug.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/><link rel="stylesheet" type="text/css" href="/css/my.css"><meta name="referrer" content="no-referrer"/><meta name="baidu-site-verification" content="codeva-zscxkbTWf7" /><meta name="google-site-verification" content="1zGJFCeeGb41mMQ8kA5KXdLo4_mLIecUtqm5MCX61ZM" /><script defer src="https://cloud.umami.is/script.js" data-website-id="83039d8f-bd3d-4637-bcfa-22c3a2fc0ac1"></script><link rel="stylesheet" href="https://portb.kbai.cc/hexo&amp;kbai/mousezhizhen.css"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/bg.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/fluid.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">47</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://yw.qianyios.top"><i class="fa-fw fas fa-cloud"></i><span> 运维笔记</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.qianyios.top/posts/22484/"><i class="fa-fw iconfont icon-liuyan"></i><span> 公共留言板</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">严千屹博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Harbor共享存储高可用</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://yw.qianyios.top"><i class="fa-fw fas fa-cloud"></i><span> 运维笔记</span></a></div><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.qianyios.top/posts/22484/"><i class="fa-fw iconfont icon-liuyan"></i><span> 公共留言板</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Harbor共享存储高可用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-30T10:52:40.000Z" title="发表于 2024-04-30 18:52:40">2024-04-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-12T11:05:14.220Z" title="更新于 2025-07-12 19:05:14">2025-07-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;已经过了&quot;,&quot;messageNext&quot;:&quot;天自上次更新，文章内容可能已过时。&quot;,&quot;postUpdate&quot;:&quot;2025-07-12 19:05:14&quot;}" hidden></div><meta name="referrer" content="no-referrer"/>
<h1 id="Harbor共享存储高可用">Harbor共享存储高可用</h1>
<h2 id="主机拓扑">主机拓扑</h2>
<table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>ip</th>
<th>系统</th>
<th>资源最低要求</th>
</tr>
</thead>
<tbody>
<tr>
<td>Harbor1<br />nginx<br />Keepalived1</td>
<td>harbor1</td>
<td>192.168.48.106</td>
<td>OpenEuler22.03LTS</td>
<td>CPU：4核 <br />内存：2G <br />硬盘：40G</td>
</tr>
<tr>
<td>Harbor2<br />nginx<br />Keepalived2</td>
<td>harbor2</td>
<td>192.168.48.107</td>
<td>OpenEuler22.03LTS</td>
<td>CPU：4核 <br />内存：2G <br />硬盘：40G</td>
</tr>
<tr>
<td>postgresql<br />Redis<br />NFS共享</td>
<td>zujian</td>
<td>192.168.48.108</td>
<td>OpenEuler22.03LTS</td>
<td>CPU：4核 <br />内存：2G <br />硬盘：40G</td>
</tr>
<tr>
<td>高可用ip</td>
<td>192.168.48.100</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><code>系统架构图</code></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/bbbf97d46f5255a4d83e886388f87b33697559838.png" alt="image-20240430185108978"></p>
<h2 id="基本配置">基本配置</h2>
<p>操作节点：[harbor1，harbour2，zujian]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi jichu_init.sh</span><br></pre></td></tr></table></figure>
<p>将以下脚本内容添加进去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">if [ $# -eq 2 ];then</span><br><span class="line">  echo &quot;设置主机名为：$1&quot;</span><br><span class="line">  echo &quot;ens160设置IP地址为：192.168.48.$2&quot;</span><br><span class="line">else</span><br><span class="line">  echo  &quot;使用方法：sh $0 主机名 主机位&quot;</span><br><span class="line">  exit 2</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;--------------------------------------&quot;</span><br><span class="line">echo &quot;1.正在设置主机名：$1&quot;</span><br><span class="line">hostnamectl set-hostname $1</span><br><span class="line"></span><br><span class="line">echo &quot;2.正在关闭firewalld、dnsmasq、selinux&quot;</span><br><span class="line">systemctl disable firewalld &amp;&gt; /dev/null</span><br><span class="line">systemctl disable dnsmasq &amp;&gt; /dev/null</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl stop dnsmasq</span><br><span class="line">sed -i &quot;s#SELINUX=enforcing#SELINUX=disabled#g&quot; /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;3.正在设置ens160：192.168.48.$2&quot;</span><br><span class="line">cat &gt; /etc/sysconfig/network-scripts/ifcfg-ens160 &lt;&lt;EOF</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">NAME=ens160</span><br><span class="line">UUID=53b402ff-5865-47dd-a853-7afcd6521738</span><br><span class="line">DEVICE=ens160</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.48.$2</span><br><span class="line">GATEWAY=192.168.48.2</span><br><span class="line">PREFIX=24</span><br><span class="line">DNS1=192.168.48.2</span><br><span class="line">DNS2=114.114.114.114</span><br><span class="line"></span><br><span class="line">nmcli c reload</span><br><span class="line">nmcli c up ens 160</span><br><span class="line"></span><br><span class="line">echo &quot;4.优化ssh&quot;</span><br><span class="line">sed -i &quot;s#\#UseDNS yes#UseDNS no#g&quot; /etc/ssh/sshd_config</span><br><span class="line">sed -i &quot;s#GSSAPIAuthentication yes#GSSAPIAuthentication no#g&quot; /etc/ssh/sshd_config</span><br><span class="line">systemctl restart sshd</span><br><span class="line"></span><br><span class="line">echo &quot;5.更改欧拉源为华为云源，速度快一点&quot;</span><br><span class="line">sed -i &#x27;s/\$basearch/x86_64/g&#x27; /etc/yum.repos.d/openEuler.repo</span><br><span class="line">sed -i &#x27;s/http\:\/\/repo.openeuler.org/https\:\/\/mirrors.huaweicloud.com\/openeuler/g&#x27; /etc/yum.repos.d/openEuler.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;6.更新yum源软件包缓存&quot;</span><br><span class="line">yum clean all &amp;&amp; yum makecache</span><br><span class="line">dnf update -y</span><br><span class="line"></span><br><span class="line">echo &quot;7.修改history格式及记录数&quot;</span><br><span class="line">sed -i &quot;s#HISTSIZE=1000##g&quot; /etc/profile</span><br><span class="line">cat &gt;&gt; /etc/profile &lt;&lt;EOF</span><br><span class="line">shopt -s histappend</span><br><span class="line">USER_IP=`who -u am i 2&gt;/dev/null| awk &#x27;&#123;print $NF&#125;&#x27;|sed -e &#x27;s/[()]//g&#x27;`</span><br><span class="line">export HISTFILE=~/.commandline_warrior</span><br><span class="line">export HISTTIMEFORMAT=&quot;%Y-%m-%d %H:%M:%S  `whoami`@$&#123;USER_IP&#125;: &quot;</span><br><span class="line">export HISTSIZE=200000</span><br><span class="line">export HISTFILESIZE=1000000</span><br><span class="line">export PROMPT_COMMAND=&quot;history -a&quot;</span><br><span class="line">EOF</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;8.添加hosts解析&quot;</span><br><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.48.106 harbor1</span><br><span class="line">192.168.48.107 harbor2</span><br><span class="line">192.168.48.108 zujian</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;10.安装chrony服务，并同步时间&quot;</span><br><span class="line">dnf install chrony -y</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line">chronyc sources</span><br><span class="line">chronyc sources</span><br><span class="line"></span><br><span class="line">echo &quot;11、安装依赖包&quot;</span><br><span class="line">dnf install -y cmake gcc gcc-c++ perl readline readline-devel openssl openssl-devel zlib zlib-devel ncurses-devel readline readline-devel zlib zlib-devel</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">执行脚本命令格式：sh jichu_init.sh 主机名 主机位</span><br><span class="line">[harbor1] sh jichu_init.sh harbor1 106</span><br><span class="line"></span><br><span class="line">[harbor2] sh jichu_init.sh harbor2 107</span><br><span class="line"></span><br><span class="line">[zujian] sh jichu_init.sh zujian 108</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>配置ssh免密</p>
<p>操作节点：[harbor1，harbour2，zujian]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y sshpass </span><br><span class="line">cat &gt; sshmianmi.sh &lt;&lt; &quot;EOF&quot;</span><br><span class="line">#!/bin/bash</span><br><span class="line"># 目标主机列表</span><br><span class="line">hosts=(&quot;harbor1&quot; &quot;harbor2&quot; &quot;zujian&quot;)</span><br><span class="line"># 密码</span><br><span class="line">password=&quot;Lj201840.&quot;</span><br><span class="line"># 生成 SSH 密钥对</span><br><span class="line">ssh-keygen -t rsa -N &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"># 循环遍历目标主机</span><br><span class="line">for host in &quot;$&#123;hosts[@]&#125;&quot;</span><br><span class="line">do</span><br><span class="line">    # 复制公钥到目标主机</span><br><span class="line">    sshpass -p &quot;$password&quot; ssh-copy-id -o StrictHostKeyChecking=no &quot;$host&quot;</span><br><span class="line">    </span><br><span class="line">    # 验证免密登录</span><br><span class="line">    sshpass -p &quot;$password&quot; ssh -o StrictHostKeyChecking=no &quot;$host&quot; &quot;echo &#x27;免密登录成功&#x27;&quot;</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sh sshmianmi.sh</span><br></pre></td></tr></table></figure>
<h2 id="安装高可用组件">安装高可用组件</h2>
<p>操作节点:[harbor1，harbour2]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y keepalived nginx</span><br></pre></td></tr></table></figure>
<h3 id="安装nginx">安装nginx</h3>
<p>操作节点:[harbor1，harbour2]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/nginx.conf &lt;&lt;&quot;EOF&quot;</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log notice;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    log_format  main  &#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;;</span><br><span class="line">    access_log  /var/log/nginx/harbor-access.log  main;</span><br><span class="line">    upstream harbor&#123;</span><br><span class="line">       server 192.168.48.106:8081;   #harbor1</span><br><span class="line">       server 192.168.48.107:8081;   #harbor2</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">       listen  80;</span><br><span class="line">       proxy_pass harbor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line">    </span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8888 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl enable --now nginx</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<h3 id="安装安装keepalived">安装安装keepalived</h3>
<p>操作节点:[harbor1]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/keepalived/keepalived.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     qianyios@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   router_id harbor1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance zh &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.48.106</span><br><span class="line">    virtual_router_id 107</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.48.100/24</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>操作节点:[harbor2]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/keepalived/keepalived.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     qianyios@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   router_id harbor2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance zh &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens160</span><br><span class="line">    mcast_src_ip 192.168.48.107</span><br><span class="line">    virtual_router_id 107</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.48.100/24</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>配置检查脚本</p>
<p>操作节点:[harbor1，harbour2]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/keepalived/check_nginx.sh &lt;&lt;&quot;EOF&quot;</span><br><span class="line">#!/bin/bash</span><br><span class="line">counter=`ps -C nginx --no-header | wc -l`</span><br><span class="line">if [ $counter -eq 0 ]; then</span><br><span class="line">    systemctl start nginx</span><br><span class="line">    sleep 2</span><br><span class="line">    counter=`ps -C nginx --no-header | wc -l`</span><br><span class="line">    if [ $counter -eq 0 ]; then</span><br><span class="line">        systemctl stop keepalived</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now nginx keepalived</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<p>查看VIP虚拟ip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor1 ~]# ip a</span><br><span class="line">.............</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:af:76:8c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.48.106/24 brd 192.168.48.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.48.100/24 scope global secondary ens160   ###192.168.48.100/24就是刚刚设置的高可用ip</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:feaf:768c/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="安装postgresql">安装postgresql</h2>
<p>操作节点：[zujian]</p>
<h3 id="安装">安装</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">#创建postgres用户</span><br><span class="line">useradd postgres</span><br><span class="line">passwd postgres</span><br><span class="line">#设置密码123456</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#编译安装postgresql</span><br><span class="line">wget https://ftp.postgresql.org/pub/source/v16.2/postgresql-16.2.tar.gz</span><br><span class="line">tar zxvf postgresql-16.2.tar.gz -C /usr/local/bin/</span><br><span class="line">cd /usr/local/bin/postgresql-16.2/</span><br><span class="line">./configure --prefix=/usr/local/postgresql</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">#建立数据目录</span><br><span class="line">mkdir -p /data/postgresql/data</span><br><span class="line">#创建日志目录</span><br><span class="line">mkdir -p /data/postgresql/log</span><br><span class="line">#创建socket目录</span><br><span class="line">mkdir -p /data/postgresql/tmp</span><br><span class="line">#授权</span><br><span class="line">chown -R postgres:postgres /usr/local/postgresql/</span><br><span class="line">chown -R postgres:postgres /data/postgresql</span><br><span class="line"></span><br><span class="line">#设置postgres环境</span><br><span class="line">su - postgres</span><br><span class="line">cd</span><br><span class="line">cat &lt;&lt; &quot;EOF&quot; &gt;&gt; ~/.bash_profile</span><br><span class="line">PGHOME=/usr/local/postgresql</span><br><span class="line">export PGHOME</span><br><span class="line">PGDATA=/data/postgresql/data</span><br><span class="line">export PGDATA</span><br><span class="line">PATH=$PATH:$HOME/bin:$HOME/.local/bin:$PGHOME/bin</span><br><span class="line">export PATH</span><br><span class="line">EOF</span><br><span class="line">source ~/.bash_profile</span><br><span class="line">psql -V</span><br><span class="line"></span><br><span class="line">#初始化数据库</span><br><span class="line">initdb --username=postgres -D /data/postgresql/data</span><br><span class="line">#会有Success. You can now start the database server using:      #表示初始化成功</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#修改初始化的配置文件</span><br><span class="line">cat &gt; /data/postgresql/data/postgresql.conf &lt;&lt; &quot;EOF&quot;</span><br><span class="line">max_connections = 100                   # 允许最大连接数</span><br><span class="line">shared_buffers = 128MB                  # 内存大小</span><br><span class="line">dynamic_shared_memory_type = posix      # the default is usually the first option</span><br><span class="line">max_wal_size = 1GB</span><br><span class="line">min_wal_size = 80MB</span><br><span class="line">log_timezone = &#x27;Asia/Shanghai&#x27;</span><br><span class="line">datestyle = &#x27;iso, mdy&#x27;</span><br><span class="line">timezone = &#x27;Asia/Shanghai&#x27;</span><br><span class="line">lc_messages = &#x27;en_US.UTF-8&#x27;             # locale for system error message</span><br><span class="line">lc_monetary = &#x27;en_US.UTF-8&#x27;             # locale for monetary formatting</span><br><span class="line">lc_numeric = &#x27;en_US.UTF-8&#x27;              # locale for number formatting</span><br><span class="line">lc_time = &#x27;en_US.UTF-8&#x27;                 # locale for time formatting</span><br><span class="line">default_text_search_config = &#x27;pg_catalog.english&#x27;</span><br><span class="line">listen_addresses = &#x27;*&#x27; #监听所有地址</span><br><span class="line">data_directory = &#x27;/data/postgresql/data&#x27;  # 数据目录指定</span><br><span class="line">port = 5432</span><br><span class="line">unix_socket_directories = &#x27;/data/postgresql/tmp&#x27;</span><br><span class="line">unix_socket_group = &#x27;&#x27;</span><br><span class="line">unix_socket_permissions = 0777</span><br><span class="line">logging_collector = on</span><br><span class="line">log_directory = &#x27;/data/postgresql/log&#x27;</span><br><span class="line">log_rotation_size = 1GB</span><br><span class="line">log_timezone = &#x27;Asia/Shanghai&#x27;</span><br><span class="line">log_min_duration_statement = 100</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line">#设置远程连接</span><br><span class="line">cat &gt;&gt; /data/postgresql/data/pg_hba.conf &lt;&lt; EOF</span><br><span class="line">local   all             all                                     trust</span><br><span class="line">host    all             all             0.0.0.0/0               password</span><br><span class="line">host    all             all             ::1/128                 password</span><br><span class="line">host    all             postgres             0.0.0.0/0           trust</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动PostgreSQL</span><br><span class="line">pg_ctl -D /data/postgresql/data -l logfile start</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="进入数据库">进入数据库</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">psql -h 127.0.0.1 -p 5432 -U postgres</span><br><span class="line"></span><br><span class="line">postgres=# \password</span><br><span class="line">Enter new password for user &quot;postgres&quot;:</span><br><span class="line">Enter it again:</span><br><span class="line">#输入密码123456</span><br><span class="line">postgres=# exit</span><br><span class="line"></span><br><span class="line">#重新启动</span><br><span class="line">pg_ctl -D /data/postgresql/data -l /data/postgresql/data/postgresql.log restart</span><br><span class="line"></span><br><span class="line">#提示一下信息成功（不是命令哈，不要去运行）</span><br><span class="line">pg_ctl: old server process (PID: 25461) seems to be gone</span><br><span class="line">starting server anyway</span><br><span class="line">waiting for server to start.... done</span><br><span class="line">server started</span><br><span class="line"></span><br><span class="line">psql -h 127.0.0.1 -p 5432 -U postgres</span><br><span class="line">#输入密码123456</span><br><span class="line"></span><br><span class="line">CREATE DATABASE registry;</span><br><span class="line">CREATE DATABASE notary_signer;</span><br><span class="line">CREATE DATABASE notary_servers;</span><br><span class="line">\l</span><br><span class="line">create user server with password &#x27;123456&#x27;;</span><br><span class="line">create user signer with password &#x27;123456&#x27;;</span><br><span class="line">\du</span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE registry to postgres;   </span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE notary_signer to postgres;   </span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE notary_servers to postgres;   </span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/7c0a0a771ab21ffe0c5347b8e7bc0739697559838.png" alt="image-20240421010122073"></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/9716f9bd02ccfaf957d1da80f1ed6b71697559838.png" alt="image-20240421010045648"></p>
<h3 id="设置启动服务">设置启动服务</h3>
<p>操作节点[zujian]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#回到root用户下执行</span><br><span class="line">su - root</span><br><span class="line">cat &gt;/etc/init.d/PG-start.sh&lt;&lt; &quot;EOF&quot;</span><br><span class="line">sudo -u postgres /usr/local/postgresql/bin/pg_ctl -D /data/postgresql/data start</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/init.d/PG-stop.sh&lt;&lt; &quot;EOF&quot;</span><br><span class="line">sudo -u postgres /usr/local/postgresql/bin/pg_ctl -D /data/postgresql/data stop</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/init.d/PG-restart.sh&lt;&lt;&quot;EOF&quot;</span><br><span class="line">sudo -u postgres /usr/local/postgresql/bin/pg_ctl -D /data/postgresql/data restart</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo chmod +x /etc/init.d/PG-start.sh</span><br><span class="line">sudo chmod +x /etc/init.d/PG-stop.sh</span><br><span class="line">sudo chmod +x /etc/init.d/PG-restart.sh</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/systemd/system/postgresql.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=postgresql Service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">user=root</span><br><span class="line">RemainAfterExit=true</span><br><span class="line">ExecStart=/usr/bin/sudo /etc/init.d/PG-start.sh</span><br><span class="line">ExecStop=/usr/bin/sudo /etc/init.d/PG-stop.sh</span><br><span class="line">ExecRestart=/usr/bin/sudo /etc/init.d/PG-restart.sh</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now postgresql</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>错误积累</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#每次我启动pgsql的时候就有这个东西</span><br><span class="line"></span><br><span class="line">2024-09-14 14:34:03.196 CST [17746] HINT:  Is another postmaster (PID 16042) running in data directory &quot;/data/postgresql/data&quot;?</span><br><span class="line"> stopped waiting</span><br><span class="line">pg_ctl: could not start server</span><br><span class="line"></span><br><span class="line">#意思是有个pid进程在运行，杀掉它就行了</span><br><span class="line">sudo kill -9 16042</span><br></pre></td></tr></table></figure>
<h2 id="安装redis">安装redis</h2>
<p>操作节点：[zujian]</p>
<h3 id="安装redis-2">安装redis</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.redis.io/releases/redis-7.2.4.tar.gz</span><br><span class="line">tar zxvf redis-7.2.4.tar.gz </span><br><span class="line">mv redis-7.2.4 /usr/local/bin/</span><br><span class="line">cd /usr/local/bin/redis-7.2.4</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h3 id="修改配置文件">修改配置文件</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/bin/redis-7.2.4/redis.conf</span><br><span class="line"></span><br><span class="line">#bind 127.0.0.1 -::1  #注释掉bind的行，允许任何主机连接；</span><br><span class="line">daemonize yes       #将no修改为yes，使redis可以使用守护进程方式启动；</span><br><span class="line">requirepass 123456   #添加这行，设置redis连接的auth密码（123456）</span><br><span class="line">protected-mode no  #禁用保护模式</span><br><span class="line"></span><br><span class="line">以下是一步到位将以上四个命令全部实现</span><br><span class="line">sed -i &#x27;s/^bind 127.0.0.1 -::1/#bind 127.0.0.1 -::1/&#x27; /usr/local/bin/redis-7.2.4/redis.conf</span><br><span class="line">sed -i &#x27;s/^daemonize no/daemonize yes/&#x27; /usr/local/bin/redis-7.2.4/redis.conf</span><br><span class="line">echo -e &quot;\nrequirepass 123456&quot; &gt;&gt; /usr/local/bin/redis-7.2.4/redis.conf</span><br><span class="line">sed -i &#x27;s/^protected-mode yes/protected-mode no/&#x27; /usr/local/bin/redis-7.2.4/redis.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="启动服务">启动服务</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zujian redis-7.2.4]# redis-server redis.conf</span><br><span class="line">2226:C 20 Apr 2024 17:10:45.039 # WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.</span><br></pre></td></tr></table></figure>
<p>Redis在启动时可能会出现这样的日志：在分析这个问题之前， 首先要弄清楚什么是overcommit？ <code>Linux操作系统对大部分申请内存的请求都回复yes</code>，<code> 以便能运行更多的程序</code>。 因为申请内存后， 并不会马上使用内存， 这种技术叫做<code>overcommit</code>。如果Redis在启动时有上面的日志， 说明vm.overcommit_memory=0， Redis提示把它设置为1。<br>
vm.overcommit_memory用来设置内存分配策略， 有三个可选值， 如表：可用内存代表物理内存与swap之和</p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/de0356ab6f8115130d1a379524ade373697559838.png" alt="image-20240420171525086"></p>
<p>解决办法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;vm.overcommit_memory=1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl vm.overcommit_memory=1</span><br><span class="line">redis-server redis.conf</span><br></pre></td></tr></table></figure>
<p>再重新启动就可以查看版本和端口号了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@zujian redis-7.2.4]# redis-cli -v</span><br><span class="line">redis-cli 7.2.4</span><br><span class="line">[root@zujian redis-7.2.4]# ps aux |grep 6379</span><br><span class="line">root        2227  0.0  0.3  68412 10888 ?        Ssl  17:10   0:00 redis-server *:6379</span><br><span class="line">root        5427  0.0  0.0  22096  2300 pts/0    S+   17:19   0:00 grep --color=auto 6379</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">redis-server有这个就行</span></span><br></pre></td></tr></table></figure>
<p>关闭服务（只是普及知识，测试可用，不要随意关闭）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli shutdown</span><br></pre></td></tr></table></figure>
<h3 id="客户端连接redis">客户端连接redis</h3>
<p>操作节点：[zujian]</p>
<p>将redis-cli的工具复制到Harbor1，harbor2</p>
<p>查看redis-cli工具位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zujian]# which redis-cli</span><br><span class="line">/usr/local/bin/redis-cli</span><br></pre></td></tr></table></figure>
<p>复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">which redis-cli</span><br><span class="line">scp /usr/local/bin/redis-cli harbor1:/usr/local/bin/</span><br><span class="line">scp /usr/local/bin/redis-cli harbor2:/usr/local/bin/</span><br></pre></td></tr></table></figure>
<p>操作节点：[harbor1,harbor2]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.48.108 -p 6379 -a 123456</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/f6e078d51551d5805c25eaf9282418c9697559838.png" alt="image-20240420232245510"></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/b51dc2d41ba515a7cbe4b11f86158148697559838.png" alt="image-20240420232257725"></p>
<p>到此redis安装成功</p>
<h3 id="设置启动服务-2">设置启动服务</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/init.d/redis-start.sh&lt;&lt; &quot;EOF&quot;</span><br><span class="line">/usr/local/bin/redis-server /usr/local/bin/redis-7.2.4/redis.conf</span><br><span class="line">EOF</span><br><span class="line">cat &gt;/etc/init.d/redis-stop.sh&lt;&lt; &quot;EOF&quot;</span><br><span class="line">/usr/local/bin/redis-cli -a 123456 shutdown</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo chmod +x /etc/init.d/redis-start.sh</span><br><span class="line">sudo chmod +x /etc/init.d/redis-stop.sh</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/systemd/system/redis.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=redis Service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">user=root</span><br><span class="line">RemainAfterExit=true</span><br><span class="line">ExecStart=/usr/bin/sudo /etc/init.d/redis-start.sh</span><br><span class="line">ExecStop=/usr/bin/sudo /etc/init.d/redis-stop.sh</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now redis</span><br></pre></td></tr></table></figure>
<h2 id="NFS共享存储安装">NFS共享存储安装</h2>
<p>操作节点：[zujian]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y nfs-utils</span><br><span class="line">systemctl enable --now nfs</span><br><span class="line">#创建远程共享目录</span><br><span class="line">mkdir -p /data/harbor_data</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/exports &lt;&lt; &quot;EOF&quot;</span><br><span class="line">/data/harbor_data 192.168.48.0/24(rw,no_root_squash)</span><br><span class="line">EOF</span><br><span class="line">#使配置生效</span><br><span class="line">exportfs -arv</span><br><span class="line"></span><br><span class="line">#生效结果</span><br><span class="line">[root@zujian ~]# showmount -e</span><br><span class="line">Export list for zujian:</span><br><span class="line">/data/harbor_data 192.168.48.0/24</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>操作节点：[harbor1,harbor2]</p>
<p>Harbor1、harbor2机器上安装nfs-utils客户端并挂载共享存储</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y nfs-utils</span><br><span class="line">systemctl enable --now nfs</span><br><span class="line">mkdir -p /data/harbor_data</span><br><span class="line">cat &gt;&gt;/etc/fstab&lt;&lt;&quot;EOF&quot;</span><br><span class="line">192.168.48.108:/data/harbor_data /data/harbor_data nfs defaults 0 0</span><br><span class="line">EOF</span><br><span class="line">mount -a</span><br><span class="line">df -h | grep harbor</span><br><span class="line">#以下是挂载成功</span><br><span class="line">[root@harbor1 ~]# df -h | grep harbor</span><br><span class="line">192.168.48.108:/data/harbor_data   63G  3.0G   57G   6% /data/harbor_data</span><br><span class="line"></span><br><span class="line">[root@harbor2 ~]# df -h | grep harbor</span><br><span class="line">192.168.48.108:/data/harbor_data   63G  3.0G   57G   6% /data/harbor_data</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="harbor仓库安装">harbor仓库安装</h2>
<p>操作节点：[harbor1,harbor2]</p>
<h3 id="安装docker">安装docker</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.docker.com/linux/static/stable/x86_64/docker-26.0.1.tgz</span><br><span class="line">tar xf docker-*.tgz</span><br><span class="line">cp docker/* /usr/bin/</span><br><span class="line">#创建containerd的service文件,并且启动</span><br><span class="line">cat &gt;/etc/systemd/system/containerd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target local-fs.target</span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/bin/containerd</span><br><span class="line">Type=notify</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">TasksMax=infinity</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl enable --now containerd.service</span><br><span class="line"></span><br><span class="line">#准备docker的service文件</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/systemd/system/docker.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket containerd.service</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">OOMScoreAdjust=-500</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#准备docker的socket文件</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/systemd/system/docker.socket &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Socket for the API</span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=/var/run/docker.sock</span><br><span class="line">SocketMode=0660</span><br><span class="line">SocketUser=root</span><br><span class="line">SocketGroup=docker</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br><span class="line">EOF</span><br><span class="line">groupadd docker</span><br><span class="line"></span><br><span class="line">systemctl enable --now docker.socket  &amp;&amp; systemctl enable --now docker.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#验证</span><br><span class="line">mkdir /etc/docker</span><br><span class="line">cat &gt;/etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">    &quot;http://hub-mirror.c.163.com&quot;,</span><br><span class="line">    &quot;https://pw860av8.mirror.aliyuncs.com&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;max-concurrent-downloads&quot;: 10,</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-level&quot;: &quot;warn&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;500m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">  &quot;data-root&quot;: &quot;/var/lib/docker&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart docker</span><br><span class="line">docker -v</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="安装docker-compose">安装docker-compose</h3>
<p>操作节点：[harbor1,harbor2]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/docker/compose/releases/download/v2.26.1/docker-compose-linux-x86_64</span><br><span class="line">mv docker-compose-linux-x86_64 /usr/local/bin/docker-compose</span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br><span class="line">docker-compose version</span><br></pre></td></tr></table></figure>
<h3 id="配置内核参数并使之生效">配置内核参数并使之生效</h3>
<p>操作节点：[harbor1,harbor2]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1 #路由转发</span><br><span class="line">EOF</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h3 id="下载harbor包并配置文件">下载harbor包并配置文件</h3>
<p>操作节点：[harbor1,harbor2]</p>
<p>下载离线包offline字样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.9.4/harbor-offline-installer-v2.9.4.tgz</span><br><span class="line">tar zxvf harbor-offline-installer-v2.9.4.tgz</span><br><span class="line">mv harbor /var/</span><br><span class="line">cd /var/harbor/</span><br><span class="line"></span><br><span class="line">[root@harbor1 harbor]# ls</span><br><span class="line">common.sh  harbor.v2.9.4.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare</span><br><span class="line"></span><br><span class="line">cp harbor.yml.tmpl harbor.yml</span><br></pre></td></tr></table></figure>
<p>配置harbor文件</p>
<p><font color='red'>操作节点：[harbor1]</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /var/harbor/harbor.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostname:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.106</span>  <span class="comment">#harbor1</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#https:       #先注释https协议，后面再实现</span></span><br><span class="line"> <span class="comment"># port: 443</span></span><br><span class="line"> <span class="comment"># certificate: /your/certificate/path</span></span><br><span class="line"> <span class="comment"># private_key: /your/private/key/path</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 启用外部代理，启用后hostname将不再使用</span></span><br><span class="line"><span class="attr">external_url:</span> <span class="string">https://192.168.48.100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#harbor页面密码</span></span><br><span class="line"><span class="attr">harbor_admin_password:</span> <span class="string">Harbor12345</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置NFS共享存储</span></span><br><span class="line"><span class="attr">data_volume:</span> <span class="string">/data/harbor_data</span></span><br><span class="line"><span class="attr">_version:</span> <span class="number">2.9</span><span class="number">.0</span></span><br><span class="line"><span class="comment">#配置数据库</span></span><br><span class="line"><span class="attr">external_database:</span></span><br><span class="line">  <span class="attr">harbor:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span>  <span class="comment"># 数据库主机地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span>              <span class="comment"># 数据库端口</span></span><br><span class="line">    <span class="attr">db_name:</span> <span class="string">registry</span>    <span class="comment"># 数据库名称</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">postgres</span>        <span class="comment"># 连接该数据库的用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span>    <span class="comment"># 连接数据库的密码</span></span><br><span class="line">    <span class="attr">ssl_mode:</span> <span class="string">disable</span></span><br><span class="line">    <span class="attr">max_idle_conns:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">max_open_conns:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">notary_server:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">    <span class="attr">db_name:</span> <span class="string">notary_server</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">ssl_mode:</span> <span class="string">disable</span></span><br><span class="line">  <span class="attr">notary_signer:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">    <span class="attr">db_name:</span> <span class="string">notary_signer</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">ssl_mode:</span> <span class="string">disable</span> </span><br><span class="line"><span class="comment">#配置redis</span></span><br><span class="line"><span class="attr">external_redis:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span><span class="string">:6379</span> <span class="comment">#redis服务IP地址和端口号</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span>   <span class="comment">#连接外部redis服务的密码</span></span><br><span class="line">  <span class="attr">registry_db_index:</span> <span class="number">1</span>  </span><br><span class="line">  <span class="attr">jobservice_db_index:</span> <span class="number">2</span> <span class="comment">#job服务的数据库索引</span></span><br><span class="line">  <span class="attr">chartmuseum_db_index:</span> <span class="number">3</span>  <span class="comment">#chartmuseum插件的Redis索引</span></span><br><span class="line">  <span class="attr">trivy_db_index:</span> <span class="number">5</span>   <span class="comment">#Trivy扫描器的数据索引</span></span><br><span class="line">  <span class="attr">idle_timeout_seconds:</span> <span class="number">30</span>  <span class="comment">#超时时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启用metrics数据采集插件</span></span><br><span class="line"><span class="attr">metric:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/metrics</span></span><br><span class="line"></span><br><span class="line"><span class="attr">trivy:</span></span><br><span class="line">  <span class="attr">ignore_unfixed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">skip_update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">skip_java_db_update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">offline_scan:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">security_check:</span> <span class="string">vuln</span></span><br><span class="line">  <span class="attr">insecure:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">jobservice:</span></span><br><span class="line">  <span class="attr">max_job_workers:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">job_loggers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">STD_OUTPUT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FILE</span></span><br><span class="line">  <span class="attr">logger_sweeper_duration:</span> <span class="number">1</span> <span class="comment">#days</span></span><br><span class="line"><span class="attr">notification:</span></span><br><span class="line">  <span class="attr">webhook_job_max_retry:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">webhook_job_http_client_timeout:</span> <span class="number">3</span> <span class="comment">#seconds</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">rotate_count:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">rotate_size:</span> <span class="string">200M</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">/var/log/harbor</span></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line">  <span class="attr">http_proxy:</span></span><br><span class="line">  <span class="attr">https_proxy:</span></span><br><span class="line">  <span class="attr">no_proxy:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">core</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">jobservice</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">trivy</span></span><br><span class="line"><span class="attr">upload_purging:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">age:</span> <span class="string">168h</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">24h</span></span><br><span class="line">  <span class="attr">dryrun:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">expire_hours:</span> <span class="number">24</span></span><br></pre></td></tr></table></figure>
<p><font color='red'>操作节点：[harbor2]</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /var/harbor/harbor.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostname:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.107</span>  <span class="comment">#harbor2</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#https:       #先注释https协议，后面再实现</span></span><br><span class="line"> <span class="comment"># port: 443</span></span><br><span class="line"> <span class="comment"># certificate: /your/certificate/path</span></span><br><span class="line"> <span class="comment"># private_key: /your/private/key/path</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 启用外部代理，启用后hostname将不再使用</span></span><br><span class="line"><span class="attr">external_url:</span> <span class="string">https://192.168.48.100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#harbor页面密码</span></span><br><span class="line"><span class="attr">harbor_admin_password:</span> <span class="string">Harbor12345</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置NFS共享存储</span></span><br><span class="line"><span class="attr">data_volume:</span> <span class="string">/data/harbor_data</span></span><br><span class="line"><span class="attr">_version:</span> <span class="number">2.9</span><span class="number">.0</span></span><br><span class="line"><span class="comment">#配置数据库</span></span><br><span class="line"><span class="attr">external_database:</span></span><br><span class="line">  <span class="attr">harbor:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span>  <span class="comment"># 数据库主机地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span>              <span class="comment"># 数据库端口</span></span><br><span class="line">    <span class="attr">db_name:</span> <span class="string">registry</span>    <span class="comment"># 数据库名称</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">postgres</span>        <span class="comment"># 连接该数据库的用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span>    <span class="comment"># 连接数据库的密码</span></span><br><span class="line">    <span class="attr">ssl_mode:</span> <span class="string">disable</span></span><br><span class="line">    <span class="attr">max_idle_conns:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">max_open_conns:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">notary_server:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">  <span class="attr">db_name:</span> <span class="string">notary_server</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">ssl_mode:</span> <span class="string">disable</span></span><br><span class="line"><span class="attr">notary_signer:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">  <span class="attr">db_name:</span> <span class="string">notary_signer</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">ssl_mode:</span> <span class="string">disable</span> </span><br><span class="line"><span class="comment">#配置redis</span></span><br><span class="line"><span class="attr">external_redis:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.108</span><span class="string">:6379</span> <span class="comment">#redis服务IP地址和端口号</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span>   <span class="comment">#连接外部redis服务的密码</span></span><br><span class="line">  <span class="attr">registry_db_index:</span> <span class="number">1</span>  </span><br><span class="line">  <span class="attr">jobservice_db_index:</span> <span class="number">2</span> <span class="comment">#job服务的数据库索引</span></span><br><span class="line">  <span class="attr">chartmuseum_db_index:</span> <span class="number">3</span>  <span class="comment">#chartmuseum插件的Redis索引</span></span><br><span class="line">  <span class="attr">trivy_db_index:</span> <span class="number">5</span>   <span class="comment">#Trivy扫描器的数据索引</span></span><br><span class="line">  <span class="attr">idle_timeout_seconds:</span> <span class="number">30</span>  <span class="comment">#超时时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启用metrics数据采集插件</span></span><br><span class="line"><span class="attr">metric:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/metrics</span></span><br><span class="line"></span><br><span class="line"><span class="attr">trivy:</span></span><br><span class="line">  <span class="attr">ignore_unfixed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">skip_update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">skip_java_db_update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">offline_scan:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">security_check:</span> <span class="string">vuln</span></span><br><span class="line">  <span class="attr">insecure:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">jobservice:</span></span><br><span class="line">  <span class="attr">max_job_workers:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">job_loggers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">STD_OUTPUT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FILE</span></span><br><span class="line">  <span class="attr">logger_sweeper_duration:</span> <span class="number">1</span> <span class="comment">#days</span></span><br><span class="line"><span class="attr">notification:</span></span><br><span class="line">  <span class="attr">webhook_job_max_retry:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">webhook_job_http_client_timeout:</span> <span class="number">3</span> <span class="comment">#seconds</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">rotate_count:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">rotate_size:</span> <span class="string">200M</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">/var/log/harbor</span></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line">  <span class="attr">http_proxy:</span></span><br><span class="line">  <span class="attr">https_proxy:</span></span><br><span class="line">  <span class="attr">no_proxy:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">core</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">jobservice</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">trivy</span></span><br><span class="line"><span class="attr">upload_purging:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">age:</span> <span class="string">168h</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">24h</span></span><br><span class="line">  <span class="attr">dryrun:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">expire_hours:</span> <span class="number">24</span></span><br></pre></td></tr></table></figure>
<h3 id="将配置文件注入到各级件中并安装">将配置文件注入到各级件中并安装</h3>
<p>先提前下载镜像吧，这里用博主构建的镜像速度会快一点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/qianyios/prepare:v2.9.4</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/qianyios/prepare:v2.9.4 goharbor/prepare:v2.9.4</span><br></pre></td></tr></table></figure>
<p>开始注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/harbor/</span><br><span class="line">./prepare</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/a93d124f3f2f71fe2c608ef2859ee748697559838.png" alt="image-20240420230001756"></p>
<p>开始安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/harbor/</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/7f5f1281ed43826bd2b9f0176373f41d697559838.png" alt="image-20240420230138644"></p>
<h3 id="配置自启动">配置自启动</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/harbor.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Harbor</span><br><span class="line">After=docker.service systemd-networkd.service systemd-resolved.service nfs-server.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">Documentation=http://github.com/vmware/harbor</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">ExecStart=/usr/local/bin/docker-compose -f /var/harbor/docker-compose.yml up</span><br><span class="line">ExecStop=/usr/local/bin/docker-compose -f /var/harbor/docker-compose.yml down</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable harbor --now</span><br></pre></td></tr></table></figure>
<p><code>大坑来了，之前找了两个星期都没解决的</code></p>
<p>到此，harbor安装完成，<code>但是你在网页可能会出现不能用admin登入，会显示密码错误</code>你需要进行下一步安装证书</p>
<p>原因：首先pg数据库在安装harbor时创建的admin是用sha256协议加密的</p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/cfdab591f116133f0e3db41a0992bd9f697559838.png" alt="image-20240430182121148"></p>
<p>而在我们harbor页面，我们并没有配置ssl证书，是http方式访问并没有sha256加密协议，意味着harbor再登入的时候，会出现密码错误，就是：网页登入验证<code>===/===</code>pg数据库验证，配置openssl证书，可以解决此问题,openssl包含sha256协议，这样就可以登入了。</p>
<p>OpenSSL是一个<code>强大的加密库</code>，广泛应用于互联网的各个角落，用于保护数据传输的安全。它实现了SSL和TLS协议，这些协议是现代网络安全的基石。</p>
<h2 id="配置ssl证书">配置ssl证书</h2>
<p>操作节点：[harbor1,harbor2]</p>
<h3 id="生成ca证书">生成ca证书</h3>
<p>创建一个放置证书相关的目录，并使用cd进入该目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/harbor/cert&amp;&amp; cd  /var/harbor/cert</span><br><span class="line">## 1. 生成CA证书私钥</span><br><span class="line">openssl genrsa -out ca.key 4096</span><br><span class="line">## 2. 生成CA证书，可调整 -subj 选项来表明域名名称等信息</span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line"> -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=192.168.48.100&quot; \</span><br><span class="line"> -key ca.key \</span><br><span class="line"> -out ca.crt</span><br></pre></td></tr></table></figure>
<h3 id="生成服务器证书">生成服务器证书</h3>
<p>认证证书通常包含证书请求<code>.csr</code>文件、签名证书<code>.crt</code>文件及私钥<code>.key</code>文件，我这里harbor配置的hostname是192.168.48.100，所以最终需要生成<code>192.168.48.100.crt、192.168.48.100.csr、192.168.48.100.key</code>三个文件。</p>
<ul>
<li>key：证书私钥，一般利用rsa等算法生成</li>
<li>csr：证书请求文件，利用证书私钥生成证书请求文件，该文件包含了服务器和地址等信息，申请人将该文件提交给CA机构，CA机构会根据该文件所携带的私钥信息来进行签名生成证书</li>
<li>crt：证书文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">## 1. 生成私钥</span><br><span class="line">openssl genrsa -out 192.168.48.100.key 4096</span><br><span class="line">## 2. 生成csr文件</span><br><span class="line">openssl req -sha512 -new \</span><br><span class="line">    -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=192.168.48.100&quot; \</span><br><span class="line">    -key 192.168.48.100.key \</span><br><span class="line">    -out 192.168.48.100.csr</span><br><span class="line">## 3. 生成ssl匹配多域名文，例如既想使用域名又需要通过127.0.0.1本地地址登陆测试，可使用subjectAltName参数来进行配置</span><br><span class="line">cat &gt; v3.ext &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1=192.168.48.100</span><br><span class="line">DNS.2=127.0.0.1</span><br><span class="line">IP.1=192.168.48.100</span><br><span class="line">EOF</span><br><span class="line">## 4. 根据v3.ext及csr文件请求生成crt证书文件</span><br><span class="line">openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">    -extfile v3.ext \</span><br><span class="line">    -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -in 192.168.48.100.csr \</span><br><span class="line">    -out 192.168.48.100.crt</span><br></pre></td></tr></table></figure>
<h3 id="修改harbor配置文件">修改harbor配置文件</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;&gt;</span> <span class="string">/var/harbor/harbor.yml</span> <span class="string">&lt;&lt;</span> <span class="string">&quot;EOF&quot;</span></span><br><span class="line"><span class="attr">https:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">certificate:</span> <span class="string">/var/harbor/cert/192.168.48.100.crt</span></span><br><span class="line">  <span class="attr">private_key:</span> <span class="string">/var/harbor/cert/192.168.48.100.key</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<p>重新启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /var/harbor</span><br><span class="line">docker-compose down -v</span><br><span class="line">./prepare</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<h2 id="镜像上传及拉取测试">镜像上传及拉取测试</h2>
<p>操作节点：[harbor1,harbor2,zujian,qianyios（测试客户端）]</p>
<p>找一台客户端装好<code>docker</code>进行测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@qianyios ~]# docker -v</span><br><span class="line">Docker version 26.0.1, build d260a54</span><br></pre></td></tr></table></figure>
<h3 id="新建私有镜像仓库">新建私有镜像仓库</h3>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/4fb7f4c6485f304c8148230cdd17cb5e697559838.png" alt="image-20240429225926063"></p>
<h3 id="客户端免https登陆">客户端免https登陆</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此时直接使用docker login登陆到harbor中，会报错，下面hostname和port是harbor的配置文件中设置的名称及端口</span></span><br><span class="line"><span class="comment">#以下是格式</span></span><br><span class="line">[root@xxxx harbor]# docker login [hostname]:[port]</span><br><span class="line"></span><br><span class="line">可能会出现以下情况</span><br><span class="line"><span class="comment">#192.168.48.100是高可用vip</span></span><br><span class="line">[root@harbor1 ~]# docker login 192.168.48.100</span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">Error response from daemon: Get <span class="string">&quot;https://192.168.48.100/v2/&quot;</span>: tls: failed to verify certificate: x509: certificate signed by unknown authority</span><br><span class="line"></span><br><span class="line">[root@qianyios ~]# docker login 192.168.48.106:8081</span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">Error response from daemon: Get <span class="string">&quot;https://192.168.48.106:8081/v2/&quot;</span>: http: server gave HTTP response to HTTPS client</span><br><span class="line">[root@qianyios ~]#</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端默认使用的是https协议，所以需要对docker做以下修改,在文件末尾添加insecure-registries</span></span><br><span class="line">[root@qianyios ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">   ................</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [],#无关紧要，不用看,</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [ <span class="string">&quot;192.168.48.100&quot;</span> ],#重要加这行，别忘了如果他不是最后一行一定要在末尾加逗号</span><br><span class="line"> ................</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后，重启docker使其生效</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用docker info查看是否添加上</span></span><br><span class="line">[root@qianyios ~]# docker info</span><br><span class="line">Containers: 10</span><br><span class="line"> Running: 1</span><br><span class="line"> Paused: 0</span><br><span class="line"> Stopped: 9</span><br><span class="line">Images: 37</span><br><span class="line">...</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  192.168.48.100   <span class="comment">###要确保有这个才行</span></span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Registry Mirrors:</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="扩展知识-containerd私有仓库配置（可略过）">扩展知识-containerd私有仓库配置（可略过）</h3>
<p>在今后的K8s版本可能也会用containerd做为k8s的容器运行时，那么配置私有仓库也是一个头疼的事情。</p>
<p>在/etc/containerd/config.toml会有以下两个信息，可以定位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]</span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br></pre></td></tr></table></figure>
<p>要在以上两个信息下配置东西如下：（理解，我下面有一步到位命令，不用手动加）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]</span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.48.100&quot;.tls]</span><br><span class="line">    insecure_skip_verify = true  # 是否跳过安全认证</span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.48.100&quot;.auth]</span><br><span class="line">    username = &quot;admin&quot;</span><br><span class="line">    password = &quot;Harbor12345&quot;</span><br><span class="line"></span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">    endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;192.168.48.100&quot;]</span><br><span class="line">    endpoint = [&quot;http://192.168.48.100&quot;]</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/e7d8228511bde2282b1d458025a5170f697559838.png" alt="image-20241009163343160"></p>
<p>添加Harbor信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;/\[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs\]/a \</span></span><br><span class="line"><span class="string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.48.100&quot;.tls]\</span></span><br><span class="line"><span class="string">          insecure_skip_verify = true  # 是否跳过安全认证\</span></span><br><span class="line"><span class="string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.48.100&quot;.auth]\</span></span><br><span class="line"><span class="string">          username = &quot;admin&quot;\</span></span><br><span class="line"><span class="string">          password = &quot;Harbor12345&quot;&#x27;</span> /etc/containerd/config.toml</span><br><span class="line">sed -i <span class="string">&#x27;/\[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors\]/a \</span></span><br><span class="line"><span class="string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]\</span></span><br><span class="line"><span class="string">          endpoint = [&quot;https://registry-1.docker.io&quot;]\</span></span><br><span class="line"><span class="string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;192.168.48.100&quot;]\</span></span><br><span class="line"><span class="string">          endpoint = [&quot;http://192.168.48.100&quot;]&#x27;</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>
<p>最后尝试下载镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl pull 192.168.48.100/cicd/jenkins:latest</span><br></pre></td></tr></table></figure>
<p>这个是我自己上传的镜像，已经在harbor仓库了，我现在在有containerd的客户端进行拉取看看能不能成功</p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/d2038f19baeadc7ad16d1028310d4b5f697559838.png" alt="image-20241009164535687"></p>
<p>显然已经成功</p>
<h3 id="进行登入测试">进行登入测试</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">docker login 192.168.48.100</span><br><span class="line"></span><br><span class="line">[root@harbor1 ~]# docker login 192.168.48.100</span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">[root@qianyios ~]# docker login 192.168.48.100</span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"><span class="comment">##经过测试，通过添加&quot;insecure-registries&quot;: [ &quot;192.168.48.100&quot; ]可以免除https登入</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="上传镜像测试">上传镜像测试</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载一个nginx镜像，然后tag，再上传</span></span><br><span class="line">[root@qianyios ~]# docker pull nginx</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">a2abf6c4d29d: Pull complete</span><br><span class="line">a9edb18cadd1: Pull complete</span><br><span class="line">589b7251471a: Pull complete</span><br><span class="line">186b1aaa4aa6: Pull complete</span><br><span class="line">b4df32aa5a72: Pull complete</span><br><span class="line">a0bcbecc962e: Pull complete</span><br><span class="line">Digest: sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br><span class="line"><span class="comment">#在此下载了最新版的nginx镜像tag为lastest</span></span><br></pre></td></tr></table></figure>
<p>我们进入当刚刚创建的仓库，点推送指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#推送镜像命令格式</span><br><span class="line">#docker tag 源镜像名[:TAG] 192.168.48.100/qianyios/新镜像名[:TAG]</span><br><span class="line">docker tag SOURCE_IMAGE[:TAG] 192.168.48.100/qianyios/REPOSITORY[:TAG]</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/c1a6a7b6fecf5f740f5be385ab2efc19697559838.png" alt="image-20240430180549537"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#我们将nginx镜像打上tag   </span><br><span class="line">[root@qianyios ~]# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">nginx        latest    605c77e624dd   2 years ago   141MB</span><br><span class="line">#605的意思是镜像id的前三位数字，我们指定为V1标签，相当于版本号。</span><br><span class="line">[root@qianyios ~]# docker tag 605 192.168.48.100/qianyios/nginx:V1</span><br><span class="line">[root@qianyios ~]# docker images</span><br><span class="line">REPOSITORY                      TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">192.168.48.100/qianyios/nginx   V1        605c77e624dd   2 years ago   141MB</span><br><span class="line">nginx                           latest    605c77e624dd   2 years ago   141MB</span><br><span class="line">#开始上传</span><br><span class="line">[root@qianyios ~]# docker push 192.168.48.100/qianyios/nginx:V1</span><br><span class="line">The push refers to repository [192.168.48.100/qianyios/nginx]</span><br><span class="line">d874fd2bc83b: Pushed</span><br><span class="line">32ce5f6a5106: Pushed</span><br><span class="line">f1db227348d0: Pushed</span><br><span class="line">b8d6e692a25e: Pushed</span><br><span class="line">e379e8aedd4d: Pushed</span><br><span class="line">2edcec3590a4: Pushed</span><br><span class="line">V1: digest: sha256:ee89b00528ff4f02f2405e4ee221743ebc3f8e8dd0bfd5c4c20a2fa2aaa7ede3 size: 1570</span><br><span class="line">#去页面查看</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/b1a7eca729d06f4371d5234181428e20697559838.png" alt="image-20240430181509733"></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/d161a1df048d0256c3c33f9b5289ac05697559838.png" alt="image-20240430181528902"></p>
<p>我们去harbor1测试拉取镜像，会发现下载数变成了<code>1</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor1 ~]# docker pull 192.168.48.100/qianyios/nginx:V1</span><br><span class="line">V1: Pulling from qianyios/nginx</span><br><span class="line">a2abf6c4d29d: Pull complete</span><br><span class="line">a9edb18cadd1: Pull complete</span><br><span class="line">589b7251471a: Pull complete</span><br><span class="line">186b1aaa4aa6: Pull complete</span><br><span class="line">b4df32aa5a72: Pull complete</span><br><span class="line">a0bcbecc962e: Pull complete</span><br><span class="line">Digest: sha256:ee89b00528ff4f02f2405e4ee221743ebc3f8e8dd0bfd5c4c20a2fa2aaa7ede3</span><br><span class="line">Status: Downloaded newer image for 192.168.48.100/qianyios/nginx:V1</span><br><span class="line">192.168.48.100/qianyios/nginx:V1</span><br><span class="line">[root@harbor1 ~]#</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/fc75695e91827f976cf7cc6c74abeabe697559838.png" alt="image-20240430181626605"></p>
<div class="tbsm" style="margin-top:54px;">
<div class="tbsm-top"><span><svg t="1674654360507" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="987" data-spm-anchor-id="a313x.7781069.0.i0" width="35" height="35"><path d="M410.49 97.74H155.08a56.74 56.74 0 0 0-56.84 56.73V410a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 410V154.58a56.83 56.83 0 0 0-56.83-56.84zM410.49 558.74H155.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#66EEFF" p-id="988"></path><path d="M410.49 558.74h-4.14A475 475 0 0 0 299.52 859.6a481.16 481.16 0 0 0 4.84 68.22h106.13A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#C2F8FF" p-id="989"></path></svg></span><span style="font-size:30px;"> 特别声明</span></div>
<div class="tbsm-wz">千屹博客旗下的所有文章，是通过本人课堂学习和课外自学所精心整理的知识巨著<br/>难免会有出错的地方<br/>如果细心的你发现了小失误，可以在下方评论区告诉我，或者私信我！<br />非常感谢大家的热烈支持！</div>
</div>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.qianyios.top">严千屹</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.qianyios.top/posts/40301/">https://blog.qianyios.top/posts/40301/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.qianyios.top" target="_blank">严千屹博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/OpenEuler/">OpenEuler</a><a class="post-meta__tags" href="/tags/Harbor/">Harbor</a></div><div class="post-share"><div class="social-share" data-image="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/Snipaste_2024-04-30_18-31-45.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxzf.png" target="_blank"><img class="post-qr-code-img" src="/img/wxzf.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/zfb.png" target="_blank"><img class="post-qr-code-img" src="/img/zfb.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/40462/" title="基于K8S的CICD系统实现"><img class="cover" src="/../img/%E5%9F%BA%E4%BA%8EK8S%E7%9A%84CICD%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0/2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">基于K8S的CICD系统实现</div></div><div class="info-2"><div class="info-item-1">K8S高可用+[rook-ceph+jenkins+gitlab](../img/K8S部署)+harbor高可用(独立集群)<br>毕设项目</div></div></div></a><a class="pagination-related" href="/posts/2459/" title="OpenEuler-K8S高可用集群（外部etcd）"><img class="cover" src="/../img/OpenEuler-%E9%83%A8%E7%BD%B2K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%A4%96%E9%83%A8etcd%EF%BC%89/Snipaste_2024-04-14_15-02-09.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">OpenEuler-K8S高可用集群（外部etcd）</div></div><div class="info-2"><div class="info-item-1">基于华为欧拉系统的K8s高可用集群</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Harbor共享存储高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E6%8B%93%E6%89%91"><span class="toc-number">1.1.</span> <span class="toc-text">主机拓扑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">基本配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8%E7%BB%84%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">安装高可用组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85nginx"><span class="toc-number">1.3.1.</span> <span class="toc-text">安装nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%AE%89%E8%A3%85keepalived"><span class="toc-number">1.3.2.</span> <span class="toc-text">安装安装keepalived</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85postgresql"><span class="toc-number">1.4.</span> <span class="toc-text">安装postgresql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.4.2.</span> <span class="toc-text">进入数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.3.</span> <span class="toc-text">设置启动服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85redis"><span class="toc-number">1.5.</span> <span class="toc-text">安装redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85redis-2"><span class="toc-number">1.5.1.</span> <span class="toc-text">安装redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.3.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5redis"><span class="toc-number">1.5.4.</span> <span class="toc-text">客户端连接redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-2"><span class="toc-number">1.5.5.</span> <span class="toc-text">设置启动服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E5%AE%89%E8%A3%85"><span class="toc-number">1.6.</span> <span class="toc-text">NFS共享存储安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#harbor%E4%BB%93%E5%BA%93%E5%AE%89%E8%A3%85"><span class="toc-number">1.7.</span> <span class="toc-text">harbor仓库安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker"><span class="toc-number">1.7.1.</span> <span class="toc-text">安装docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker-compose"><span class="toc-number">1.7.2.</span> <span class="toc-text">安装docker-compose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E5%B9%B6%E4%BD%BF%E4%B9%8B%E7%94%9F%E6%95%88"><span class="toc-number">1.7.3.</span> <span class="toc-text">配置内核参数并使之生效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDharbor%E5%8C%85%E5%B9%B6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.4.</span> <span class="toc-text">下载harbor包并配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%B3%A8%E5%85%A5%E5%88%B0%E5%90%84%E7%BA%A7%E4%BB%B6%E4%B8%AD%E5%B9%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.7.5.</span> <span class="toc-text">将配置文件注入到各级件中并安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">1.7.6.</span> <span class="toc-text">配置自启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEssl%E8%AF%81%E4%B9%A6"><span class="toc-number">1.8.</span> <span class="toc-text">配置ssl证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90ca%E8%AF%81%E4%B9%A6"><span class="toc-number">1.8.1.</span> <span class="toc-text">生成ca证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%81%E4%B9%A6"><span class="toc-number">1.8.2.</span> <span class="toc-text">生成服务器证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9harbor%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.8.3.</span> <span class="toc-text">修改harbor配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E4%B8%8A%E4%BC%A0%E5%8F%8A%E6%8B%89%E5%8F%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.</span> <span class="toc-text">镜像上传及拉取测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="toc-number">1.9.1.</span> <span class="toc-text">新建私有镜像仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%8Dhttps%E7%99%BB%E9%99%86"><span class="toc-number">1.9.2.</span> <span class="toc-text">客户端免https登陆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86-containerd%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%85%8D%E7%BD%AE%EF%BC%88%E5%8F%AF%E7%95%A5%E8%BF%87%EF%BC%89"><span class="toc-number">1.9.3.</span> <span class="toc-text">扩展知识-containerd私有仓库配置（可略过）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E7%99%BB%E5%85%A5%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.4.</span> <span class="toc-text">进行登入测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E6%B5%8B%E8%AF%95"><span class="toc-number">1.9.5.</span> <span class="toc-text">上传镜像测试</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"></div><div class="footer_custom_text"><span style="display: block; text-align: center; color: white;">严千屹博客</span>
<a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener" style="display: block; text-align: center; color: white; text-decoration: none; ">
  ICP备案号:粤ICP备2024250479号
</a>
<span style="display: block; text-align: center; color: white;white-space: nowrap;">本站已加入：十年之约👇
    <a href="https://www.foreverblog.cn/" target="_blank" style="display: block; text-align: center; text-decoration: none; "> <img src="https://img.foreverblog.cn/logo_en_default.png" alt="" style="width:auto;height:16px;"> </a>
</span>
<div class="post-reward" style="margin-top:11px;margin-bottom:20px"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxzf.png" target="_blank"><img class="post-qr-code-img" src="/img/wxzf.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/zfb.png" target="_blank"><img class="post-qr-code-img" src="/img/zfb.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/instant.page/instantpage.js" type="module"></script><script src="/pluginsSrc/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.qianyios.top',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.qianyios.top',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://s4.zstatic.net/ajax/libs/twikoo/1.6.39/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="/pluginsSrc/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/pluginsSrc/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>