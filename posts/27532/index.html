<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Ansible-总手册 | 严千屹博客</title><meta name="author" content="严千屹"><meta name="copyright" content="严千屹"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ansible总手册">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible-总手册">
<meta property="og:url" content="https://blog.qianyios.top/posts/27532/index.html">
<meta property="og:site_name" content="严千屹博客">
<meta property="og:description" content="Ansible总手册">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://article.biliimg.com/bfs/article/ac1131395d7a2b36ca5fb6d28c8017662fb8697a.png">
<meta property="article:published_time" content="2023-11-09T16:02:40.000Z">
<meta property="article:modified_time" content="2025-07-12T09:26:40.115Z">
<meta property="article:author" content="严千屹">
<meta property="article:tag" content="Centos 7">
<meta property="article:tag" content="Ansible">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://article.biliimg.com/bfs/article/ac1131395d7a2b36ca5fb6d28c8017662fb8697a.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ansible-总手册",
  "url": "https://blog.qianyios.top/posts/27532/",
  "image": "https://article.biliimg.com/bfs/article/ac1131395d7a2b36ca5fb6d28c8017662fb8697a.png",
  "datePublished": "2023-11-09T16:02:40.000Z",
  "dateModified": "2025-07-12T09:26:40.115Z",
  "author": [
    {
      "@type": "Person",
      "name": "严千屹",
      "url": "https://blog.qianyios.top"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.qianyios.top/posts/27532/index.html"><link rel="preconnect"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 严千屹","link":"链接: ","source":"来源: 严千屹博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ansible-总手册',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1232762_lfyb6ri0kug.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/><link rel="stylesheet" type="text/css" href="/css/my.css"><meta name="referrer" content="no-referrer"/><meta name="baidu-site-verification" content="codeva-zscxkbTWf7" /><meta name="google-site-verification" content="1zGJFCeeGb41mMQ8kA5KXdLo4_mLIecUtqm5MCX61ZM" /><script defer src="https://cloud.umami.is/script.js" data-website-id="83039d8f-bd3d-4637-bcfa-22c3a2fc0ac1"></script><link rel="stylesheet" href="https://portb.kbai.cc/hexo&amp;kbai/mousezhizhen.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/bg.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/fluid.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.qianyios.top/posts/22484/"><i class="fa-fw iconfont icon-liuyan"></i><span> 公共留言板</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">严千屹博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Ansible-总手册</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.qianyios.top/posts/22484/"><i class="fa-fw iconfont icon-liuyan"></i><span> 公共留言板</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Ansible-总手册</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-09T16:02:40.000Z" title="发表于 2023-11-10 00:02:40">2023-11-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-12T09:26:40.115Z" title="更新于 2025-07-12 17:26:40">2025-07-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">18.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>77分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;已经过了&quot;,&quot;messageNext&quot;:&quot;天自上次更新，文章内容可能已过时。&quot;,&quot;postUpdate&quot;:&quot;2025-07-12 17:26:40&quot;}" hidden></div><meta name="referrer" content="no-referrer"/>
<h1 id="Ansible-总手册">Ansible-总手册</h1>
<ol>
<li><a href="#Ansible%E4%B8%89%E6%9C%BA%E9%83%A8%E7%BD%B2">Ansible三机部署</a></li>
<li><a href="#Ansible%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4">Ansible配置及相关指令</a></li>
<li><a href="#%E7%94%A8%E6%88%B7%E7%BA%A7ansible%E7%8E%AF%E5%A2%83%E6%9E%84%E5%BB%BA">用户级ansible环境构建（小练习）</a></li>
<li><a href="#Ansible-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97">Ansible-常用模块</a></li>
<li><a href="#Ansible-Playbook">Ansible-playblock</a></li>
<li><a href="#Ansible-templates">Ansible-templates</a></li>
<li><a href="#Roles">Ansible-Roles</a></li>
<li><a href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%EF%BC%9A%E5%AE%89%E8%A3%85httpd%E6%9C%8D%E5%8A%A1">实验任务：安装httpd服务</a></li>
</ol>
<h1 id="Ansible三机部署">Ansible三机部署</h1>
<h2 id="关于">关于</h2>
<p>ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。<br>
　　ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。ansible不需要在远程主机上安装client/agents，因为它们是基于ssh来和远<br>
程主机通讯的。ansible目前已经已经被红帽官方收购，是自动化运维工具中大家认可度最高的，并且上手容易，学习简单。是每位运维工程师必须掌握的技能之一。</p>
<h2 id="主机分布">主机分布</h2>
<table>
<thead>
<tr>
<th>主机名</th>
<th>ip</th>
<th>系统</th>
<th>内存</th>
<th>硬盘</th>
</tr>
</thead>
<tbody>
<tr>
<td>controller</td>
<td>192.168.48.100</td>
<td>Centos7.9</td>
<td>4G</td>
<td>100G</td>
</tr>
<tr>
<td>node01</td>
<td>192.168.48.101</td>
<td>Centos7.9</td>
<td>4G</td>
<td>100G</td>
</tr>
<tr>
<td>node02</td>
<td>192.168.48.102</td>
<td>Centos7.9</td>
<td>4G</td>
<td>100G</td>
</tr>
</tbody>
</table>
<h2 id="修改主机名">修改主机名</h2>
<p><code>controlle</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname controller &amp;&amp; bash</span><br></pre></td></tr></table></figure>
<p><code>node01</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node01 &amp;&amp; bash</span><br></pre></td></tr></table></figure>
<p><code>node02</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node02 &amp;&amp; bash</span><br></pre></td></tr></table></figure>
<p><code>三台机加入hosts</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.48.100 controller</span><br><span class="line">192.168.48.101 node01</span><br><span class="line">192.168.48.102 node02</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="设置阿里yum">设置阿里yum</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir repo.bak</span><br><span class="line">mv /etc/yum.repos.d/* repo.bak/</span><br><span class="line">wget -O /etc/yum.repos.d/CentOSBase.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">yum clean all &amp;&amp; yum makecache</span><br><span class="line">systemctl disable firewalld --now</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/sysconfig/selinux</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure>
<h2 id="安装python">安装python</h2>
<p><code>已安装可以忽略。</code></p>
<p><code>确保python版本&gt;=2.6</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install epel-release</span><br><span class="line">sudo yum install https://centos7.iuscommunity.org/ius-release.rpm</span><br><span class="line">sudo yum install python27</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ~]# python --version</span><br><span class="line">Python 2.7.5</span><br><span class="line">#有显示说明python安装成功</span><br></pre></td></tr></table></figure>
<h2 id="安装Ansible">安装Ansible</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install epel-release ansible openssh</span><br><span class="line"></span><br><span class="line">[root@controller ~]# ansible --version</span><br><span class="line">ansible 2.9.27</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u&#x27;/root/.ansible/plugins/modules&#x27;, u&#x27;/usr/share/ansible/plugins/modules&#x27;]</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Oct 14 2020, 14:45:30) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="测试">测试</h2>
<h3 id="测试主机是否存活">测试主机是否存活</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ansible/hosts</span><br><span class="line"></span><br><span class="line">#在末尾添加ip</span><br><span class="line">192.168.48.101</span><br><span class="line">192.168.48.102</span><br><span class="line">-----------------------</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m ping -k</span><br><span class="line">ansible 192.168.48.102 -m ping -k</span><br></pre></td></tr></table></figure>
<p>如果controller没有首次进行ssh至node01-02节点，则ansible会出错，如下图：</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/d532cd4e257c3d44938697760ad2984a697559838-1726155218419-20.png" alt="image-20230909230311692"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/17b123269de38e723b5fadf4bb900190697559838-1726155218419-21.png" alt="image-20230909230328295"></p>
<p>所以我们必须先ssh至各节点，让其生成缓存信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@controller ~]# ssh 192.168.48.101</span><br><span class="line">##输入密码</span><br><span class="line"></span><br><span class="line">[root@node01 ~]# exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@controller ~]# ssh 192.168.48.102</span><br><span class="line">##输入密码</span><br><span class="line"></span><br><span class="line">[root@node02 ~]# exit</span><br></pre></td></tr></table></figure>
<p>这时我们在进行测试</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/8f2e0efd9625bb551134c558141fb934697559838-1726155218420-22.png" alt="image-20230909230535153"></p>
<h2 id="SSH免密配置">SSH免密配置</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen   （一路回车，三次）</span><br><span class="line">[root@controller ~]# ls -al ~/.ssh</span><br><span class="line">total 12</span><br><span class="line">drwx------  2 root root   57 Sep  6 00:43 .</span><br><span class="line">dr-xr-x---. 8 root root  236 Sep  9 23:05 ..</span><br><span class="line">-rw-------  1 root root 1675 Sep  6 00:42 id_rsa</span><br><span class="line">-rw-r--r--  1 root root  397 Sep  6 00:42 id_rsa.pub</span><br><span class="line">-rw-r--r--  1 root root  352 Sep  6 00:35 known_hosts</span><br><span class="line">#有密钥文件了</span><br><span class="line"></span><br><span class="line">#将密钥文件复制到node01-02节点，实现ssh免密登入</span><br><span class="line">(先yes 然后输入密码即可)</span><br><span class="line">ssh-copy-id root@192.168.48.101</span><br><span class="line"></span><br><span class="line">ssh-copy-id root@192.168.48.102</span><br></pre></td></tr></table></figure>
<p>最后我们在进行测试</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/83de0f2327321a1b510793c35eb218cb697559838-1726155218420-23.png" alt="image-20230909231047461"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/f7125008aaa709e1106fa073483995bc697559838-1726155218420-24.png" alt="image-20230909231103976"></p>
<h1 id="Ansible配置及相关指令">Ansible配置及相关指令</h1>
<h2 id="ansible-程序结构">ansible 程序结构</h2>
<p>安装目录如下(yum安装)：<br>
　　配置文件目录：/etc/ansible/<br>
　　执行文件目录：/usr/bin/<br>
　　Lib库依赖目录：/usr/lib/pythonX.X/site-packages/ansible/<br>
　　Help文档目录：/usr/share/doc/ansible-X.X.X/<br>
　　Man文档目录：/usr/share/man/man1/</p>
<h2 id="ansible配置文件查找顺序">ansible配置文件查找顺序</h2>
<p>ansible与我们其他的服务在这一点上有很大不同，这里的配置文件查找是从多个地方找的，顺序如下：</p>
<ol>
<li>
<p>检查环境变量<code>ANSIBLE_CONFIG</code>指向的路径文件<br>
(export ANSIBLE_CONFIG=/etc/ansible.cfg)；</p>
</li>
<li>
<p><code>~/.ansible.cfg</code>，检查当前目录下的ansible.cfg配置文件；</p>
</li>
<li>
<p><code>/etc/ansible.cfg</code>检查etc目录的配置文件。</p>
</li>
</ol>
<h2 id="ansible配置文件">ansible配置文件</h2>
<p>ansible 的配置文件为<code>/etc/ansible/ansible.cfg</code>，ansible 有许多参数，下面我们列出一些常见的参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line"> </span><br><span class="line">#inventory      = /etc/ansible/hosts   //定义Inventory</span><br><span class="line">#library        = /usr/share/my_modules/  //自定义lib库存放目录 </span><br><span class="line">#remote_tmp     = ~/.ansible/tmp       //零时文件远程主机存放目录</span><br><span class="line">#local_tmp      = ~/.ansible/tmp       //零时文件本地存放目录</span><br><span class="line">#forks          = 5                    //默认开启的并发数</span><br><span class="line">#poll_interval  = 15                   //默认轮询时间间隔</span><br><span class="line">#sudo_user      = root                 //默认sudo用户</span><br><span class="line">#ask_sudo_pass = True                  //是否需要sudo密码</span><br><span class="line">#ask_pass      = True                  //是否需要密码</span><br><span class="line">#host_key_checking = False             //首次连接是否检查key认证</span><br><span class="line">#roles_path    = /etc/ansible/roles    //默认下载的Roles存放的目录</span><br><span class="line">#log_path = /var/log/ansible.log       //执行日志存放目录</span><br><span class="line">#module_name = command                 //默认执行的模块</span><br><span class="line">#action_plugins     = /usr/share/ansible/plugins/action //action插件存放目录</span><br><span class="line">#callback_plugins   = /usr/share/ansible/plugins/callback //callback插件存放目录</span><br><span class="line">#connection_plugins = /usr/share/ansible/plugins/connection  //connection插件存放目录</span><br><span class="line">#lookup_plugins     = /usr/share/ansible/plugins/lookup //lookup插件存放目录</span><br><span class="line">#vars_plugins       = /usr/share/ansible/plugins/vars //vars插件存放目录</span><br><span class="line">#filter_plugins     = /usr/share/ansible/plugins/filter //filter插件存放目录</span><br><span class="line">#test_plugins       = /usr/share/ansible/plugins/test //test插件存放目录</span><br><span class="line">#strategy_plugins   = /usr/share/ansible/plugins/strategy //strategy插件存放目录</span><br><span class="line">#fact_caching = memory                 //getfact缓存的主机信息存放方式</span><br><span class="line">#retry_files_enabled = False              </span><br><span class="line">#retry_files_save_path = ~/.ansible-retry  //错误重启文件存放目录</span><br></pre></td></tr></table></figure>
<h3 id="配置文件的分类与优先级">配置文件的分类与优先级</h3>
<p>Ansible只有一个配置文件ansible.cfg，但配置文件可以存在不同的位置，并且只有一个可用 (数字代表优先级，数字越小代表优先级越高) :</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/bf211db73aea2394ac38fa2bb217ca34697559838.png" alt="image-20230912232830688"></p>
<h3 id="配置文件选项">配置文件选项</h3>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/3ddb17ad5a833513f53be5cf483f51a5697559838.png" alt="image-20230912232950364"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/c4e994cdce2311a90a1f20272421ff40697559838.png" alt="image-20230912233003740"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/6ce1bdfe949bd22740329bf08f66d443697559838.png" alt="image-20230912233019308"></p>
<p>官网配置参考网址</p>
<p><a href="../img/https://docs.ansible.com/ansible/2.9/reference_appendices/config.html">Ansible Configuration Settings — Ansible Documentation</a></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/aadcbffa6a3f0cd1d2da9f4ee3a9d950697559838.png" alt="image-20230912233124916"></p>
<h2 id="ansuble主机清单">ansuble主机清单</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1、 定义单独主机：</span><br><span class="line">	## green.example.com#</span><br><span class="line">	# blue.example.com#</span><br><span class="line">	# 192.168.100.1</span><br><span class="line">	# 192.168.100.10</span><br><span class="line">2、 定义一个主机组[组名]把地址或主机名加进去</span><br><span class="line">	[mysql_test]</span><br><span class="line">	192.168.253.159</span><br><span class="line">	192.168.253.160</span><br><span class="line">	192.168.253.153</span><br></pre></td></tr></table></figure>
<p>需要注意的是，这里的<code>组成员可以使用通配符来匹配</code>，这样对于一些标准化的管理来说就很轻松方便了。<br>
　　我们可以根据实际情况来配置我们的主机列表，具体操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]# vim /etc/ansible/hosts</span><br><span class="line">	[web]</span><br><span class="line">	192.168.37.122</span><br><span class="line">	192.168.37.133</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">3、 定义嵌套组</span><br><span class="line">    [web-mysql]</span><br><span class="line">       mysql_test</span><br><span class="line">       web</span><br><span class="line">4、 定义范围化ip</span><br><span class="line">    172.16.[0:4].[2:254]  </span><br></pre></td></tr></table></figure>
<h2 id="ansible-常用命令">ansible 常用命令</h2>
<blockquote>
<p><code>/usr/bin/ansible</code>　　Ansibe AD-Hoc 临时命令执行工具，常用于临时命令的执行<br>
<code>/usr/bin/ansible-doc</code> 　Ansible 模块功能查看工具<br>
<code>/usr/bin/ansible-galaxy</code>　　下载/上传优秀代码或Roles模块 的官网平台，基于网络的<br>
<code>/usr/bin/ansible-playbook</code>　　Ansible 定制自动化的任务集编排工具<br>
<code>/usr/bin/ansible-pull</code>　　Ansible远程执行命令的工具，拉取配置而非推送配置（使用较少，海量机器时使用，对运维的架构能力要求较高）<br>
<code>/usr/bin/ansible-vault</code>　　Ansible 文件加密工具<br>
<code>/usr/bin/ansible-console</code>　　Ansible基于Linux Consoble界面可与用户交互的命令执行工具</p>
</blockquote>
<p>其中，我们比较常用的是<code>/usr/bin/ansible</code>和<code>/usr/bin/ansible-playbook</code>。</p>
<h3 id="ansible-命令详解">ansible 命令详解</h3>
<p>命令的具体格式如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;host-<span class="selector-tag">pattern</span>&gt; <span class="selector-attr">[-f forks]</span> <span class="selector-attr">[-m module_name]</span> <span class="selector-attr">[-a args]</span></span><br></pre></td></tr></table></figure>
<p>也可以通过<code>ansible -h</code>来查看帮助，下面我们列出一些比较常用的选项，并解释其含义：</p>
<blockquote>
<p><code>-a MODULE_ARGS</code>　　　#模块的参数，如果执行默认COMMAND的模块，即是命令参数，如： “date”，“pwd”等等<br>
<code>-k</code>，<code>--ask-pass</code> #ask for SSH password。登录密码，提示输入SSH密码而不是假设基于密钥的验证<br>
<code>--ask-su-pass</code> #ask for su password。su切换密码<br>
<code>-K</code>，<code>--ask-sudo-pass</code> #ask for sudo password。提示密码使用sudo，sudo表示提权操作<br>
<code>--ask-vault-pass</code> #ask for vault password。假设我们设定了加密的密码，则用该选项进行访问<br>
<code>-B SECONDS</code> #后台运行超时时间<br>
<code>-C</code> #模拟运行环境并进行预运行，可以进行查错测试<br>
<code>-c CONNECTION</code> #连接类型使用<br>
<code>-f FORKS</code> #并行任务数，默认为5<br>
<code>-i INVENTORY</code> #指定主机清单的路径，默认为<code>/etc/ansible/hosts</code><br>
<code>--list-hosts</code> #查看有哪些主机组<br>
<code>-m MODULE_NAME</code> #执行模块的名字，默认使用 command 模块，所以如果是只执行单一命令可以不用 -m参数<br>
<code>-o</code> #压缩输出，尝试将所有结果在一行输出，一般针对收集工具使用<br>
<code>-S</code> #用 su 命令<br>
<code>-R SU_USER</code> #指定 su 的用户，默认为 root 用户<br>
<code>-s</code> #用 sudo 命令<br>
<code>-U SUDO_USER</code> #指定 sudo 到哪个用户，默认为 root 用户<br>
<code>-T TIMEOUT</code> #指定 ssh 默认超时时间，默认为10s，也可在配置文件中修改<br>
<code>-u REMOTE_USER</code> #远程用户，默认为 root 用户<br>
<code>-v</code> #查看详细信息，同时支持<code>-vvv</code>，<code>-vvvv</code>可查看更详细信息</p>
</blockquote>
<h2 id="ansible-配置公私钥">ansible 配置公私钥</h2>
<p>上面我们已经提到过 ansible 是基于 ssh 协议实现的，所以其配置公私钥的方式与 ssh 协议的方式相同，具体操作步骤如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#1.生成私钥</span></span><br><span class="line">[<span class="meta">root@server ~</span>]<span class="meta"># ssh-keygen </span></span><br><span class="line"><span class="meta">#2.向主机分发私钥</span></span><br><span class="line">[<span class="meta">root@server ~</span>]<span class="meta"># ssh-copy-id root@192.168.48.101</span></span><br><span class="line">[<span class="meta">root@server ~</span>]<span class="meta"># ssh-copy-id root@192.168.48.102</span></span><br></pre></td></tr></table></figure>
<p><code>192.168.48.101为node01的ip地址</code></p>
<p>这样的话，就可以实现无密码登录，我们的实验过程也会顺畅很多。<br>
　　注意，如果出现了一下报错：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-bash: ssh-<span class="keyword">copy</span><span class="language-bash">-<span class="built_in">id</span>: <span class="built_in">command</span> not found</span></span><br></pre></td></tr></table></figure>
<p>那么就证明我们需要安装一个包：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install openssh</span><br></pre></td></tr></table></figure>
<p>把包安装上即可。</p>
<p>注意：先ssh 192.168.48.101和ssh 192.168.48.102各节点，生成缓存信息，才能进行<code>主机连通性测试</code></p>
<h2 id="ansible-ping模块">ansible ping模块</h2>
<h3 id="主机连通性测试">主机连通性测试</h3>
<p>我们使用<code>ansible web -m ping</code>命令来进行主机连通性测试，效果如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@server</span> ~]<span class="comment"># ansible web -m ping</span></span><br><span class="line"><span class="meta prompt_">192.168.48.101 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">192.168.48.102 | SUCCESS =&gt;</span> &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;ping&quot;</span>: <span class="string">&quot;pong&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就说明我们的主机是连通状态的。接下来的操作才可以正常进行。</p>
<h1 id="用户级ansible环境构建">用户级ansible环境构建</h1>
<h2 id="主机分布-2">主机分布</h2>
<table>
<thead>
<tr>
<th>主机名</th>
<th>ip</th>
<th>系统</th>
<th>内存</th>
<th>硬盘</th>
</tr>
</thead>
<tbody>
<tr>
<td>controller</td>
<td>192.168.48.100</td>
<td>Centos7.9</td>
<td>4G</td>
<td>100G</td>
</tr>
<tr>
<td>node01</td>
<td>192.168.48.101</td>
<td>Centos7.9</td>
<td>4G</td>
<td>100G</td>
</tr>
<tr>
<td>node02</td>
<td>192.168.48.102</td>
<td>Centos7.9</td>
<td>4G</td>
<td>100G</td>
</tr>
</tbody>
</table>
<h2 id="创建student用户">创建student用户</h2>
<p><font color='red'>三台机创建student用户</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#创建student用户</span><br><span class="line">useradd student</span><br><span class="line">passwd student</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>
<h2 id="controller创建student用户工作目录">controller创建student用户工作目录</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#切换student用户，创建工作目录，新建ansible.cfg配置文件，验证配置文件生效。</span><br><span class="line">su student</span><br><span class="line">cd </span><br><span class="line">#创建资产清单 </span><br><span class="line">mkdir ansible</span><br><span class="line">cat &gt;&gt; /home/student/ansible/inventory &lt;&lt;EOF</span><br><span class="line">[servers]</span><br><span class="line">192.168.48.101</span><br><span class="line">192.168.48.102</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="controller编辑配置文件ansible-cfg">controller编辑配置文件ansible.cfg</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd ansible</span><br><span class="line">cat &gt;&gt; /home/student/ansible/ansible.cfg &lt;&lt;EOF</span><br><span class="line">[defaults]</span><br><span class="line">inventory=/home/student/ansible/inventory</span><br><span class="line">remote_port=22</span><br><span class="line">remote_user=root</span><br><span class="line">#指定远程用户为root</span><br><span class="line">ask_pass=True</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="验证清单主机存活（指定root）">验证清单主机存活（指定root）</h2>
<p>验证清单主机存活 ,执行命令进行测试，可以看到在每次执行ansible时都会询问连接用户的密码（相 当于-K参数）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ansible all --list</span><br><span class="line"></span><br><span class="line">[student@controller ansible]$ ansible all --list</span><br><span class="line">SSH password:</span><br><span class="line">  hosts (2):</span><br><span class="line">    192.168.48.101</span><br><span class="line">    192.168.48.102</span><br><span class="line">[student@controller ansible]$</span><br><span class="line">#成功</span><br></pre></td></tr></table></figure>
<p>如果不想输入密码，那需要修改配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /home/student/ansible/ansible.cfg</span><br><span class="line">······</span><br><span class="line">ask_pass=False</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/e1d902512d1ed9c395ad0dc927a3211e04e28fba-1726155218420-25.png" alt="image-20230912224807001"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[student@controller ansible]$ ansible all --list</span><br><span class="line">  hosts (2):</span><br><span class="line">    192.168.48.101</span><br><span class="line">    192.168.48.102</span><br><span class="line">[student@controller ansible]$</span><br><span class="line">#无输入密码选项</span><br></pre></td></tr></table></figure>
<h2 id="实例（指定student）">实例（指定student）</h2>
<p><font color='red'>远程用户指定为普通用户（student）</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[student@controller ansible]$ vim ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">inventory=/home/student/ansible/inventory</span><br><span class="line">remote_port=22</span><br><span class="line">remote_user=student</span><br><span class="line">#指定远程用户为student</span><br><span class="line">ask_pass=False</span><br></pre></td></tr></table></figure>
<p>这时候执行ping会报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m ping</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/36030bdebb9cbe2cb9cf85a57f527991fc70eba3-1726155218420-26.png" alt="image-20230912225310702"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/093cb2bedadf9dacdf83186c216de62efbbea1bb-1726155218420-27.png" alt="image-20230912225331509"></p>
<p>这时候我们要配置免密登入（这里的密钥是student用户的，和root不一样，不会覆盖root用户的，这是在student用户下执行的命令）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[student@controller ansible]$ ssh-keygen</span><br><span class="line">#回车三次</span><br><span class="line">[student@controller ansible]$ ssh-copy-id student@192.168.48.101</span><br><span class="line">#输入yes和node1的root密码</span><br><span class="line"></span><br><span class="line">[student@controller ansible]$ ssh-copy-id student@192.168.48.102</span><br><span class="line">#输入yes和node2的root密码</span><br></pre></td></tr></table></figure>
<p>这是执行ping命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m ping</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/fbfb0421bf54c003e1a9cc2e28ffd60fea8755cf-1726155218420-28.png" alt="image-20230912230245638"></p>
<h2 id="测试提取文件">测试提取文件</h2>
<p>这个普通用户（student）并不能执行所有的操作，比如ansible以student身份登录，执行（ls /root）发普通用户没有权限，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a &quot;ls /root&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/dcc6b723a386323cf562bade58b2cf2a8957be6f-1726155218420-29.png" alt="image-20230912230504092"></p>
<p>解决这个问题就需要提权：sudo 提权</p>
<p>在受控主机(<font color='red'>node01、node02</font>)上执行visudo（配置 /etc/sudoers）</p>
<p><font color='red'>node01机子</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# visudo</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/91e2a38e7ef071a3cb51f5b89dc133df750e339c-1726155218420-30.png" alt="image-20230912230747742"></p>
<p><font color='red'>node02机子</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node02 ~]# visudo</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/645d2da0ea2f30c86fe3f4719053de461825fd10-1726155218420-31.png" alt="image-20230912230906568"></p>
<p>或者(<font color='red'>node01和node02执行以下指令</font>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/etc/sudoers.d/student &lt;&lt; EOF </span><br><span class="line">student          ALL=(ALL)        NOPASSWD: ALL</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>在<font color='red'>控制主机（controller）</font>上(<font color='red'>student用户</font>)修改ansible.cfg配置文件提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[student@controller ansible]$ vim ansible.cfg</span><br><span class="line">[defaults]</span><br><span class="line">inventory=/home/student/ansible/inventory</span><br><span class="line">remote_port=22</span><br><span class="line">remote_user=student</span><br><span class="line">ask_pass=False</span><br><span class="line">[privilege_escalation]</span><br><span class="line">become=True</span><br><span class="line">become_method=sudo</span><br><span class="line">become_user=root</span><br><span class="line">become_ask_pass=False</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/0575ae46b3b79b6f7beffd757fd79427cee52b0e-1726155218420-32.png" alt="image-20230912231556770"></p>
<p>验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a &quot;ls /root&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/5e66812c14fd8690a9025e8436b5d6d3edd08ccf-1726155218420-33.png" alt="image-20230912231635877"></p>
<p><font color='red'>#在控制节点的student经过sudo提权之后可以读取/root目录了</font></p>
<h1 id="Ansible-常用模块">Ansible-常用模块</h1>
<h2 id="command模块">command模块</h2>
<p>linux命令，不支持管道、重定向等，不建议使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m command -a &quot;pwd&quot;</span><br><span class="line">ansible all -m command -a &quot;ls&quot;</span><br><span class="line">ansible all -m command -a &quot;cat /etc/passwd |grep student&quot; #这个不能正常使用 ansible all -m command -a &quot;echo bb &gt;&gt;/tmp/testansible&quot;</span><br><span class="line">ansible all -m command -a &quot;cat /tmp/testansible&quot;</span><br></pre></td></tr></table></figure>
<p>#重定向也无法正常使用</p>
<p>课堂练习：</p>
<p>使用command命令查询各主机磁盘状态、查询内存状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m command -a &quot;df -h&quot;</span><br><span class="line">ansible all -m command -a &quot;free -m&quot;</span><br></pre></td></tr></table></figure>
<h2 id="shell模块">shell模块</h2>
<p>支持管道、重定向等，常用模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a &quot;cat /etc/passwd | grep student&quot; #支持管道</span><br><span class="line">ansible all -m shell -a &quot;echo bb &gt;&gt;/tmp/testansible&quot;</span><br><span class="line">ansible all -m shell -a &quot;cat /tmp/testansible&quot;</span><br></pre></td></tr></table></figure>
<p>#支持重定向</p>
<p>课堂练习：</p>
<p>使用shell模块查看selinux状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a &quot;getenforce&quot;</span><br></pre></td></tr></table></figure>
<p>通过shell模块批量关闭selinux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">临时关闭：</span><br><span class="line"></span><br><span class="line">ansible all -m shell -a &quot;setenforce 0&quot;</span><br><span class="line"></span><br><span class="line">永久关闭：</span><br><span class="line"></span><br><span class="line">ansible all -m shell -a &quot;sed -ri &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config&quot;</span><br><span class="line"></span><br><span class="line">ansible all -m shell -a &quot;reboot&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="文件模块">文件模块</h2>
<h3 id="copy模块">copy模块</h3>
<p>从主控端复制文件到远程主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc copy</span><br></pre></td></tr></table></figure>
<p><font color='red'>常用参数</font></p>
<p><font color='red'>src</font>：source源路径文件/目录。即要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是 相对路径。如果路径是一个目录，它将递归复制。在这种情况下，<font color='red'>如果路径使用&quot;/“来结尾，则只复制目录里的内容，如果没有使用”/&quot;来结尾，则包含目录在内的整个内容全部复制。</font></p>
<p><font color='red'>dest</font>：destnation受管主机上的一个目标路径，即要将源文件复制到的远程主机的绝对路径，<font color='red'>如果源文件是一个目录，那么该路径也必须是个目录（必须）</font></p>
<p><font color='red'>content</font>：代替src，将本机指定内容传至远程主机并生成目标文件，相当于 echo 重定向内容到文件</p>
<p><font color='red'>mode</font>：文件权限（chmod）</p>
<p>linux权限回顾</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/52827ecf0f65ab744206c34f261d3a9a697559838.png" alt="image-20230919103608153"></p>
<p>owner：文件属主（chown）<br>
group：文件属组（chgrp）<br>
backup：在覆盖之前将原文件备份，备份文件包含时间信息。<br>
directory_mode： 递归地设定目录的权限，默认为系统默认权限<br>
force： 若目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当目标 主机的存放位置不存在该文件时，才复制。默认为yes</p>
<h4 id="使用案例">使用案例</h4>
<hr>
<ol>
<li>复制dir1目录及其文件到受控主机/tmp/下（无斜杠-操作整个目录）</li>
</ol>
<p>注：关于src目录加不加/的演示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#复制dir1目录及其文件到受控主机/tmp/下</span><br><span class="line">su student</span><br><span class="line">cd ~</span><br><span class="line">ll</span><br><span class="line">mkdir ansible</span><br><span class="line">cd ansible/</span><br><span class="line">mkdir dir1</span><br><span class="line">echo &quot;123&quot; &gt;dir1/file1</span><br><span class="line">ansible 192.168.48.101 -m copy -a &quot;src=&#x27;dir1&#x27; dest=/tmp/&quot; </span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/26297293d1c6d55d60a07ba276b8f34d697559838.png" alt="image-20230919104532341"></p>
<p>查看受控主机是否复制成功</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/8ac7e84618a6a21b32f22fd0ddd6293c697559838.png" alt="image-20230919104230231"></p>
<p>成功</p>
<hr>
<p>2.仅复制dir1目录下的文件（有斜杠-操作目录下的文件，不复制目录）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m copy -a&quot;src=&#x27;dir1/&#x27; dest=/tmp/&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/aeb91a6fcfd4c46cab9b2f1753021736697559838.png" alt="image-20230919104627377"></p>
<hr>
<h4 id="练习">练习</h4>
<ol>
<li>将控制主机的copyfile<font color='red'>文件</font>复制到受管主机的 /tmp 目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;123&#x27; &gt; copyfile</span><br><span class="line">ansible 192.168.48.101 -m copy -a &#x27;src=copyfile dest=/tmp&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/5f44b73d5f3a76ac330e4c548dd2a4a4697559838.png" alt="image-20230919104938353"></p>
<ol start="2">
<li>直接在受管主机上生成一个指定内容的文件文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m copy -a &quot;content=&#x27;test copy\n&#x27; dest=/tmp/f1&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/a3c76e0b0aec925240c70f4cb5eee82a697559838.png" alt="image-20230919105205728"></p>
<ol start="3">
<li>在受管主机上生成指定属性和内容的文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m copy -a &quot;content=&#x27;test copy 2\n&#x27; dest=/tmp/f2 mode=0644 owner=student group=student&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/fb9ee5353f0251d1948b1c0c4c231262697559838.png" alt="image-20230919105358641"></p>
<ol start="4">
<li>在文件覆盖前生成备份文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m copy -a &quot;content=&#x27;test copy 1\n&#x27; dest=/tmp/f1 backup=yes&quot;</span><br><span class="line"></span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;ls -l /tmp/f1*&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/b5e4b14ac0ca160bde8ddf210cb96ab7697559838.png" alt="image-20230919105648041"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/70416fb0306aabae0a84614e1dd8616c697559838.png" alt="image-20230919105803096"></p>
<h3 id="script模块">script模块</h3>
<p>在远程主机上运行ansible服务器上的脚本，优点是不需手动传送脚本至每个服务器。</p>
<p>其实是ansible自动传到远程主机、执行然后再删除脚本：copy+shell+delete</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; tesh.sh &lt;&lt; EOF</span><br><span class="line">#！/bin/bash </span><br><span class="line">echo hello</span><br><span class="line">EOF</span><br><span class="line">ansible all -m script -a tesh.sh</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/982643f18a7e268bacd57c50e218c612697559838.png" alt="image-20230919110133298"></p>
<p>执行结果显示了每台主机的执行情况。</p>
<p><code>CHANGED</code> 表示执行过程中发生了变化，即脚本被成功执行。</p>
<p><code>rc</code> 字段显示返回码为 0，表示执行成功。</p>
<p><code>stderr</code> 字段显示了标准错误输出，其中包含了连接关闭的信息。</p>
<p><code>stdout</code> 字段显示了标准输出，其中包含了脚本执行的结果，即 “hello”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;  ansible_ntp.sh &lt;&lt; EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">systemctl status ntpd &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">if [ \$? == 0 ]; then</span><br><span class="line">	echo &quot;ntp service has been installed&quot;</span><br><span class="line">	exit</span><br><span class="line">fi</span><br><span class="line">yum install -y ntp &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">if [ \$? == 0 ]; then</span><br><span class="line">	systemctl start ntpd</span><br><span class="line">	systemctl enabled ntpd &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">	sleep 5</span><br><span class="line">	ntpq -p</span><br><span class="line">else</span><br><span class="line">	echo &quot;ntp service install failed,check network or yum&quot;</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">这条命令的意思就是在后台执行这个程序,并将错误输出2重定向到标准输出1,然后将标准输出1全部放 到/dev/null文件,也就是清空.</span><br><span class="line">所以可以看出&quot; &gt;/dev/null 2&gt;&amp;1 &quot;常用来避免shell命令或者程序等运行中有内容输出。</span><br><span class="line"></span><br><span class="line">chmod 777 ansible_ntp.sh</span><br><span class="line"></span><br><span class="line">ansible all -m script -a &quot;ansible_ntp.sh&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/9fbb36b86b4fd085fa37a09953f27fd7697559838.png" alt="image-20230919112000710"></p>
<h3 id="fetch模块">fetch模块</h3>
<p>从受管主机上，拉取文件到控制节点（目前不支持目录,可以先打包,再提取文件）</p>
<p>常见参数</p>
<p><font color='red'>dest</font>：控制节点的保存路径</p>
<p><font color='red'>src</font>：受管节点要拉取文件的路径（必须是文件，不能是目录）</p>
<p><font color='red'>flat</font>：直接保存到目标指定位置，而不是在受管主机名下的文件路径中。</p>
<p><font color='cornflowerblue'>使用案例</font></p>
<ol>
<li>从受管主机拉取指定文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m fetch -a &quot;src=/etc/hosts dest=/home/student/ansible&quot;</span><br></pre></td></tr></table></figure>
<p>索取到本地目录下的文件会<font color='red'>自动生成与目标主机的域名或IP地址的目录</font>存放索取的文件</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/4fdb0ca42f7652416648856e326af850697559838.png" alt="image-20230919122430880"></p>
<ol start="2">
<li>直接拉取受管主机文件到控制节点指定位置</li>
</ol>
<p><font color='red'>flat</font>：直接保存到目标指定位置，而不是在受管主机名下的文件路径中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m fetch -a &quot;src=/etc/hosts dest=/home/student/ansible/file1 flat=yes&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/945aaa435a8d0362f4d908f5f76ffea0697559838.png" alt="image-20230919124219445"></p>
<ol start="3">
<li>打包目录并所有内容到控制节点指定位置</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m shell -a &#x27;pwd&#x27;</span><br><span class="line"></span><br><span class="line">ansible 192.168.48.101 -m shell -a &#x27;tar cf test.tar.gz /var/log&#x27;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &#x27;ls -l /home/student/&#x27;</span><br><span class="line">ansible 192.168.48.101 -m fetch -a &quot;src=/home/student/test.tar.gz dest=/home/student/ansible/ flat=yes&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/32d69277b0e420ee14c86f38bbf177f7697559838.png" alt="image-20230919124935075"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/896d2a405049a0e8f4dcf8bcd147ef62697559838.png" alt="image-20230919125130417"></p>
<h3 id="file模块">file模块</h3>
<p>file 模块可以帮助我们完成一些对文件的基本操作。比如，创建文件或目录、删除文件或目录、修改文 件权限等。</p>
<p><font color='red'>常用参数</font></p>
<p><font color='red'>mode</font>： 定义文件/目录的权限,比如，如果想要将文件权限设置为&quot;rw-r-x—&quot;，则可以使用mode=650进行 设置，或者使用mode=0650，效果也是相同的。<br>
<font color='red'>owner</font>： 定义文件/目录的所有者,属主对应的用户必须在远程主机中存在,否则会报错。<br>
<font color='red'>group</font>： 定义文件/目录的属组,属组对应的组必须在远程主机中存在，否则会报错。<br>
<font color='red'>path</font>： 必选项，定义受管主机的文件/目录的路径<br>
<font color='red'>recurse</font>： 递归地设置文件的属性，只对目录有效<br>
<font color='red'>src</font>： 要被链接的源文件的路径，只应用于state=hard/link的情况<br>
<font color='red'>dest</font>： 被链接到的路径，只应用于state=hard/link的情况。<br>
<font color='red'>state</font>： 操作方法<br>
<font color='red'>directory</font>：如果目录不存在，创建目录<br>
<font color='red'>file</font>：即使文件不存在，也不会被创建（只能指定已存在的文件）<br>
<font color='red'>touch</font>：如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间<br>
<font color='red'>link</font>：创建软链接<br>
<font color='red'>hard</font>：创建硬链接<br>
<font color='red'>absent</font>：删除目录、文件或者取消链接文件，相当于rm -rf<br>
<font color='red'>force</font>： 只应用于state=hard/link的情况，若需要在两种情况下<font color='red'>强制创建软链接</font>，一种是源文件不存在但 之后会建立的情况下；另一种是目标软链接已存在，需要先取消之前的软链，然后创建新的软链，有两个选 项：yes|no</p>
<p><font color='cornflowerblue'>使用案例</font></p>
<ol>
<li>创建指定文件属性的空目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;path=/tmp/dir2 state=directory owner=student group=student mode=0755&quot;</span><br><span class="line"></span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;ls -l /tmp/&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/d119b1a6c075c04724ea0b5d18b24ff6697559838.png" alt="image-20230919130328712"></p>
<ol start="2">
<li>创建指定文件属性的空文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;path=/tmp/file2 state=touch owner=student group=student mode=0755&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;ls -l /tmp/&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/f919f4d5b5a8b68e20e4f95ccb967700697559838.png" alt="image-20230919130652157"></p>
<p><font color='red'>注意：为何不能用state=file</font></p>
<p><font color='red'>file</font>：即使文件不存在，也不会被创建（只能指定已存在的文件）</p>
<p>file3不存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;path=/tmp/file3 state=file owner=student group=student mode=0755&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/1619642d3c6cc025192515591e26ace8697559838.png" alt="image-20230919131409780"></p>
<p>如果指定file1（已存在）呢（将root用户属组改成student）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;path=/tmp/file1 state=file owner=student group=student mode=0755&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/e5f778ea43b30d28fd675e0a6a864038697559838.png" alt="image-20230919131653294"></p>
<ol start="3">
<li>删除目录、删除文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;path=/tmp/dir1 state=absent&quot;</span><br><span class="line">ansible 192.168.48.101 -m file -a &quot;path=/tmp/file1 state=absent&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;ls -l /tmp/&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/c3c6450ce672a745e0d7d65a0a3bd3ac697559838.png" alt="image-20230919131825229"></p>
<ol start="4">
<li>创建链接文件</li>
</ol>
<p>软链接：快捷方式<br>
file2→file1（link）</p>
<p>生成file1（<font color='red'>如果已存在就忽略这步</font>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m copy -a &quot;content=&#x27;123 \n&#x27; dest=/tmp/file1&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/35c2e36d03caece46fbd21381a3800a7697559838.png" alt="image-20230919132425256"></p>
<p>生成软链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;src=/tmp/file1 path=/tmp/file2 state=link force=true&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/ac380dd1f6da597ec6270ef6ca593bf9697559838.png" alt="image-20230919132542883"></p>
<p>取消软连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;path=/tmp/file2 state=absent&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/98bf109db0eb83ac92dc76a4cddb0777697559838.png" alt="image-20230919132733624"></p>
<p>硬链接：指向同一个inode</p>
<p>file3→file1（hard）</p>
<p>file3不存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &quot;src=/tmp/file1 path=/tmp/file3 state=hard&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/3e287d7e0e2660964cd890ef1adc3c72697559838.png" alt="image-20230919132952435"></p>
<h4 id="课堂练习">课堂练习</h4>
<p>1、在/tmp/下创建目录ansiblefile,并在该文件夹下创建test.txt文件，指定属主student,赋予权限0700</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a &quot;useradd student&quot;	#创建一个用户与组</span><br><span class="line">ansible 192.168.48.101 -m file -a &#x27;path=/tmp/ansiblefile state=directory&#x27;</span><br><span class="line">ansible 192.168.48.101 -m file -a &#x27;path=/tmp/ansiblefile/test.txt state=touch owner=student mode=0700&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/cdef89811e66ad695a1c99667c0c89b2697559838.png" alt="image-20230919133407177"></p>
<p>2、删除远程机器上的指定文件或目录(删除远程主机上的文件：/tmp/ansiblefile/test.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m file -a &#x27;path=/tmp/ansiblefile/test.txt state=absent&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/e93984ad9e575561dbec75452154899b697559838.png" alt="image-20230919133445932"></p>
<h3 id="lineinfile模块">lineinfile模块</h3>
<p>增加或修改文件内容（以行为单位做流式处理），该模块在自动化运维中非常重要,他可以通过正则表达 式替换指定文本;例如开启一些配置选项等可以新加一行文本,或者是删除指定的行,本命令一定认真掌握 下来.</p>
<p><em><strong>*常见参数*</strong></em></p>
<p><font color='red'>path</font>：必须参数，远端文件路径</p>
<p><font color='red'>line</font>：必须参数，修改后的内容（按行写入），追加</p>
<p><font color='red'>regexp</font>：（定位）匹配正则语句,与要过滤的关键字</p>
<p><font color='red'>state</font>：文件修改状态（present 添加生效 / absent 删除）</p>
<p><font color='red'>replace</font>：替换文件内容</p>
<p><font color='red'>create</font>：当文件不存在时，是否创建对应文件</p>
<p><font color='red'>backup</font>：若文件更新时创建备份副本</p>
<p><font color='red'>insertafter</font>：在指定位置的下一行插入（定位）</p>
<p><font color='red'>insertbefore</font>：在指定位置的上一行插入（定位）</p>
<p><font color='orange'>使用案例</font></p>
<p>假设前提：将控制节点的/etc/selinux/config文件复制到受管主机192.168.48.101，另存为/tmp/selinux文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m copy -a &quot;src=/etc/selinux/config dest=/tmp/selinux&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;cat /tmp/selinux&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/756073d3a371c5ad80ed9d2b96cc0735697559838.png" alt="image-20230919134240077"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/3fbdf2b0b76d46ef1cbd8df403861593697559838.png" alt="image-20230919134251941"></p>
<ol>
<li>修改文件内容：考虑两个问题，修改哪个部分，修改成什么内容</li>
</ol>
<p>修改SELINUX开头的行，更新内容为：SELINUX=disabled</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/tmp/selinux regexp=&#x27;^SELINUX=&#x27; line=&#x27;SELINUX=disabled&#x27; &quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;cat /tmp/selinux&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/ff41c79a4849ffafdc9c6cc72a4b5209697559838.png" alt="image-20230919134315158"></p>
<p>2.增加文件内容：考虑两个问题，增加什么内容，增加在哪个位置（上一行或下一行）</p>
<p>在SELINUX开头的行，在下一行加个注释，并且应用生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/tmp/selinux insertafter=&#x27;^SELINUX=&#x27; line=&#x27;##Disabled SELINUX&#x27; &quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/001e419cf858d7c28354f565a2791a01697559838.png" alt="image-20230919134429117"></p>
<p>通过正则匹配查找/tmp/selinux文本,并在文本末尾插入一行##end</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &#x27;path=/tmp/selinux regexp=&quot;EOF&quot; line=&quot;#end&quot;&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/a47131b7c20e123dfee16dcde867fb21697559838.png" alt="image-20230919134600319"></p>
<p>3.删除文件内容:把刚才添加的“<font color='orange'>##disabled selinux</font>”注释去掉（删除所在行）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/tmp/selinux regexp=&#x27;^##Disa&#x27; state=absent&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;cat /tmp/selinux&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/8388d27ba2f82a7ac5c10deb1cd88c1d697559838.png" alt="image-20230919134741516"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/1538eecbf87fa1ebe7ae12f47572f272697559838.png" alt="image-20230919134748069"></p>
<ol start="4">
<li>备份文件:在SELINUX开头的行，前一行加个注释，并且生效，生成备份文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/tmp/selinux insertbefore=&#x27;^SELINUX=&#x27; line=&#x27;##Disabled SELINUX&#x27; backup=yes state=present&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;ls -l /tmp/selinux*&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/d0ae22dee29f7c9fedf16e8d93de70bb697559838.png" alt="image-20230919134951862"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/3ac6894ea15fb06f10ad21e6a0e48994697559838.png" alt="image-20230919135043656"></p>
<p>课堂练习：</p>
<p>修改192.168.48.101主机的/etc/hosts文件，</p>
<p>1、增加内容192.168.48.102 node03,验证增加成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/etc/hosts line=&#x27;192.168.48.102 node03&#x27; &quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;cat /etc/hosts&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/3480653ecbfb7b45c39bfe37641abe94697559838.png" alt="image-20230919143706370"></p>
<p>2、匹配以192开头的行，修改192.168.48.102 对应的 域名为node02，验证增加成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/etc/hosts regexp=&#x27;^192&#x27; line=&#x27;192.168.48.102 node02&#x27; &quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/82f79ccd0582587791246c164466ddfe697559838.png" alt="image-20230919143745061"></p>
<p>3、匹配以192开头的行之前增加 192.168.48.101 node01 ，验证增加成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/etc/hosts insertbefore=&#x27;^192&#x27; line=&#x27;192.168.48.101 node01&#x27; &quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/fbf2e090c6d8759eb5147754e3ef2e95697559838.png" alt="image-20230919143806128"></p>
<p>4、在文档结尾增加 192.168.48.100 controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &#x27;path=/etc/hosts regexp=&quot;EOF&quot; line=&quot;192.168.48.100 controller&quot;&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/fc1024bf695130888d3ec14f3358268e697559838.png" alt="image-20230919143820201"></p>
<p>5、删除步骤1-3加入的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m lineinfile -a &quot;path=/etc/hosts regexp=&#x27;^192.&#x27; state=absent&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &quot;cat /etc/hosts&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/85dcd9c0186a3eb51446a05cb9dc497c697559838.png" alt="image-20230919143831042"></p>
<h2 id="软件包模块">软件包模块</h2>
<h3 id="yum模块">yum模块</h3>
<p><em><strong>*常用参数*</strong></em></p>
<p>name：软件包名称（必填）</p>
<p>state：</p>
<p>latest（更新到最新）</p>
<p>present（安装）</p>
<p>version（版本）</p>
<p>absent（卸载）</p>
<p>查看是否安装了某个服务 rpm -qa|grep httpd</p>
<p><em><strong>*使用案例*</strong></em></p>
<p>给node01安装httpd服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m yum -a &#x27;name=httpd state=present&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/077acbe660f8d5467cead949a6261b86697559838.png" alt="image-20230919144212748"></p>
<p>验证安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m shell -a &#x27;rpm -qa|grep httpd&#x27;</span><br></pre></td></tr></table></figure>
<p>卸载 state=absent</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m yum -a &#x27;name=httpd state=absent&#x27;</span><br></pre></td></tr></table></figure>
<p>更新软件state=latest</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m yum -a &#x27;name=&#x27;httpd&#x27; state=latest&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="系统模块">系统模块</h2>
<h3 id="user模块">user模块</h3>
<p><font color='red'>常用参数</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">comment：注释信息</span><br><span class="line">group：主要组</span><br><span class="line">groups：附加组</span><br><span class="line">state：present/absent</span><br><span class="line">generate_ssh_key：生成SSH验证密钥</span><br><span class="line">name：用户名</span><br><span class="line">shell：Shell类型</span><br><span class="line">uid：UID</span><br></pre></td></tr></table></figure>
<p><font color='red'>使用案例</font></p>
<p>1、在node1上创建用户 test_user UID=1010</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m user -a &quot;name=test_user  uid=1010 comment=&#x27;ansible_test_user&#x27; shell=/bin/bash generate_ssh_key=yes  state=present&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m shell -a &#x27;id test_user&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/9fcc14b7641e8a2a1cbbc2c8f89b9ce4697559838.png" alt="image-20230920001519202"></p>
<p>2、删除用户test_user（userdel test_user）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m user -a &quot;name=test_user  state=absent force=yes&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &#x27;getent passwd |grep test_user&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/ecb24faf569f346c43de8b49d857ad39697559838.png" alt="image-20230920001533536"></p>
<h3 id="group组模块">group组模块</h3>
<p>1、创建组test_group (groupadd -g 1010 test_group）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m group -a &quot;name=test_group  gid=1010  state=present&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &#x27;getent group|grep test_group&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/f14a0dfa0cd30c96aa4d1d88602dbf29697559838.png" alt="image-20230920001545680"></p>
<p>2、删除组test_group （groupdel test_group）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m group -a &quot;name=test_group   state=absent&quot;</span><br><span class="line">ansible 192.168.48.101 -m shell -a &#x27;getent group|grep test_group&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/984c33ed39dd849a2495d5bfce57835b697559838.png" alt="image-20230920001557200"></p>
<h3 id="service模块">service模块</h3>
<p>启用/启动/停止指定的服务</p>
<p><font color='red'>常用参数</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name：服务名（确定服务存在）（必选项）</span><br><span class="line">state：服务目标状态</span><br><span class="line">	（state=started/stopped/restarted/...）（必选项）</span><br><span class="line">enabled：是否开机启动(yes/no)</span><br></pre></td></tr></table></figure>
<p>1、在node01上安装和启用httpd服务（相当于systemctl enable --now httpd）</p>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m yum -a &#x27;name=httpd state=present&#x27;</span><br></pre></td></tr></table></figure>
<p>启用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m service -a &quot;name=httpd state=started  enabled=yes&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m shell -a &#x27;systemctl status httpd&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/ebf18d1d264fdb90968c717a86e6888d697559838.png" alt="image-20230920001809879"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/b42ddf38524dddc14e86d4c710d97922697559838.png" alt="image-20230920001826386"></p>
<p>2、停止服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m service -a &#x27;name=httpd state=stopped&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/7ddf22463363605d6f0e87cf6ff1e725697559838.png" alt="image-20230920001941649"></p>
<p>3、重启服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m service -a &#x27;name=httpd state=restarted&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/d80886bd03e975c2b785a9498f3376a3697559838.png" alt="image-20230920002005593"></p>
<h3 id="firewalld模块">firewalld模块</h3>
<p><font color='red'>常见参数</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">source：数据源（相当于--add-source）</span><br><span class="line">interface：端口（相当于--add-port）</span><br><span class="line">service：服务（相当于--add-service）</span><br><span class="line">zone：关联区域（相当于--zone）</span><br><span class="line">permanent：永久生效（相当于--permanent）</span><br><span class="line">immediate：立即生效（相当于执行了firewall-cmd --reload）</span><br><span class="line">state：防火墙规则状态（enabled | disabled）（必填项）</span><br><span class="line">rich_rule：富规则（相当于--add-rich-rule=&#x27;&#x27;）</span><br></pre></td></tr></table></figure>
<p><font color='red'>使用案例</font></p>
<p>1、添加基本规则</p>
<p>在node1中将http服务进行放行，并关联到public区域中，立即生效且永久生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.48.101 -m firewalld -a &#x27;zone=public service=http permanent=yes immediate=yes state=enabled&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="综合练习">综合练习</h2>
<p>（1）在node01上创建一个用户devops：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible node01 -m user -a &quot;name=devops state=present&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/43311590cf4293eebf8e6c6e4525fe7f697559838.png" alt="image-20230919211657605"></p>
<p>（2）在node01上创建一个目录 /devops，设置所属组、权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible node01 -m file -a &quot;path=/devops state=directory owner=devops group=devops mode=0755&quot;</span><br><span class="line"> ansible node01 -m shell -a &quot;ls -l /&quot;  </span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/c070db8ae1c1081b3afa5ce73bfd475c697559838.png" alt="image-20230919211756676"></p>
<p>（3）安装httpd服务，设定开机自启动，验证服务状态为启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible node01 -m yum -a &quot;name=httpd state=present&quot;</span><br><span class="line">ansible node01 -m service -a &quot;name=httpd state=started enabled=yes&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/e161fc889e76fee81d98bb5f76ab6b4f697559838.png" alt="image-20230912173234830"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/2945a200e016c4bdc2785f2b5616d9e5697559838.png" alt="image-20230912173228899"></p>
<p>（4）创建一个文件 /devops/index.html 包含一行内容：DevOps：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible node01 -m copy -a &quot;content=&#x27;DevOps\n&#x27; dest=/devops/index.html&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/e5ca64b7e2b60729b8f77919d2cbe9fd697559838.png" alt="image-20230919211916628"></p>
<p>（5）创建软链接：/var/www/html/index.html 到 /devops/index.html：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible node01 -m file -a &quot;src=/devops/index.html dest=/var/www/html/index.html state=link force=true&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/1459bab864fc683648b370727a50ab0e697559838.png" alt="image-20230919211928515"></p>
<p>（6）验证软链接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible node01 -m shell -a &quot;ls -l  /var/www/html/index.html&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/6a902872ae6c3a772f771257ad5ebdca697559838.png" alt="image-20230919211941716"></p>
<p>（7）取消软链接，新建/var/www/html/index.html 文档，访问网页：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible node01 -m file -a &quot;path=/var/www/html/index.html state=absent&quot;</span><br><span class="line">ansible node01 -m copy -a &quot;content=&#x27;Hello World&#x27; dest=/var/www/html/index.html&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/942dcfaf88048644ec1383c6aaf454c5697559838.png" alt="image-20230919212000893"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/25c4d54e6951d50a51ae34425952395e697559838.png" alt="image-20230919212022836"></p>
<p>使用浏览器访问<a target="_blank" rel="noopener" href="http://192.168.48.xn--101-j88dk9es35b6g1emivarfe">http://192.168.48.101验证主页信息</a></p>
<h1 id="Ansible-Playbook">Ansible-Playbook</h1>
<h2 id="介绍">介绍</h2>
<blockquote>
<p>playbook是由一个或多个&quot;play&quot;组成的列表<br>
play的主要功能在于将预定义的一组主机，装扮成事先通过ansible中的task定义好的角色。<br>
Task实际是调用ansible的一个module，将多个play组织在一个playbook中，<br>
即可以让它们联合起来，按事先编排的机制执行预定义的动作<br>
Playbook采用YAML语言编写</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用户通过ansible命令直接调用yml语言写好的playbook,playbook由多条play组成</span><br><span class="line">每条play都有一个任务(task)相对应的操作,然后调用模块modules，应用在主机清单上,通过ssh远程连接</span><br><span class="line">从而控制远程主机或者网络设备</span><br></pre></td></tr></table></figure>
<h2 id="YAML语法">YAML语法</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; 在单一档案中，可用连续三个连字号（---）区分多个档案。</span><br><span class="line">  另外，还有选择性的连续三个点号( ... )用来表示档案结尾</span><br><span class="line">&gt; 次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</span><br><span class="line">&gt; 使用#号注释代码</span><br><span class="line">&gt; 缩进必须是统一的，不能空格和tab混用，一般缩进2个空格</span><br><span class="line">&gt; 缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</span><br><span class="line">&gt; YAML文件内容是区别大小写的，key/value的值均需大小写敏感</span><br><span class="line">&gt; 多个key/value可同行写也可换行写，同行使用:分隔，同一行使用 , 逗号分隔</span><br><span class="line">&gt; value可以是个字符串，也可是另一个列表[]</span><br><span class="line">&gt; 一个完整的代码块功能需最少元素需包括 name 和 task</span><br><span class="line">&gt; 一个name只能包括一个task</span><br><span class="line">&gt; YAML中不允许在双引号中出现转义符号，所以都是以单引号来避免转义符错误</span><br><span class="line">&gt; 使用 | 和 &gt; 来分隔多行，实际上这只是一行。 </span><br><span class="line">&gt; YAML文件扩展名通常为yml或yaml</span><br></pre></td></tr></table></figure>
<p>三种常见的数据交换格式</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/0b09dccd30360520c75ca7cf06f2027a697559838.png" alt="7"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构。</span><br><span class="line">序列（Sequence）里的项用&quot;-&quot;来代表，Map里的键值对（字典）用&quot;:&quot;分隔</span><br><span class="line">示例</span><br><span class="line">    name: John Smith</span><br><span class="line">    age: 41</span><br><span class="line">    gender: Male</span><br><span class="line">    spouse:</span><br><span class="line">      name: Jane Smith</span><br><span class="line">      age: 37</span><br><span class="line">      gender: Female</span><br><span class="line">    children:</span><br><span class="line">      - name: Jimmy Smith</span><br><span class="line">        age: 17</span><br><span class="line">        gender: Male</span><br><span class="line">      - name: Jenny Smith</span><br><span class="line">        age 13</span><br><span class="line">        gender: Female</span><br></pre></td></tr></table></figure>
<h2 id="修改vim">修改vim</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.vimrc</span><br><span class="line">set nu       </span><br><span class="line">set paste    </span><br><span class="line">set cursorline </span><br><span class="line">set cursorcolumn </span><br><span class="line">autocmd FileType yaml setlocal ai et ts=2 sw=2 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set nu       #显示行号</span><br><span class="line">set paste    #黏贴内容保留格式</span><br><span class="line">set cursorline #行定位</span><br><span class="line">set cursorcolumn #列定位</span><br><span class="line">autocmd FileType yaml setlocal ai et ts=2 sw=2 </span><br><span class="line">#FileType 代表文件类型,后边跟参数yaml，就是这个作用于yaml文件，编写其他文件时不起作用</span><br><span class="line">#ts=2是tabstop=2的缩写，表示使用2个空格自动代替tab键</span><br><span class="line">#et=expandtab 表示tab键的缩写</span><br><span class="line">#sw=2 是shiftwidth=2的缩写，表示开启自动缩进对齐，缩进宽度为2个空格</span><br><span class="line">#ai=auto indent   自动退格对齐\</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将这段代码添加到 <code>~/.vimrc</code> 文件中，以使 Vim 在启动时自动应用这些设置</p>
<h2 id="playbook基础组件">playbook基础组件</h2>
<p>一个简单的剧本模型（YAML语言）</p>
<p>1&gt; 缩进：用两个空格缩进</p>
<p>2&gt; 列表：用 -</p>
<p>3&gt; 字典：key: value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">--- </span><br><span class="line">- hosts: YYY          #待操作主机集，可以不写，执行时通过 -i 调用host文件</span><br><span class="line">  remote_user： root  #在远端使用哪个用户执行</span><br><span class="line">  tasks:              #任务集（必须）</span><br><span class="line">  - name: task1       #只是一个文本提示，执行时会输出其中内容（例如输出Install httpd）</span><br><span class="line">    module1:          #真正干活的部分，其实就是前面讲过的ansible各种模块</span><br><span class="line">      argument1 : value1 </span><br><span class="line">      argument2 : value2 </span><br><span class="line">  - name: task2 </span><br><span class="line">    module2:</span><br><span class="line">      argument1 : value1 </span><br><span class="line">      argument2 : value2 </span><br><span class="line">... </span><br></pre></td></tr></table></figure>
<p>解释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hosts：</span><br><span class="line">    &gt; playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。</span><br><span class="line">      hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">remote_user: </span><br><span class="line">    可用于Host和task中。</span><br><span class="line">    也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；</span><br><span class="line">    此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</span><br><span class="line">    - hosts: all</span><br><span class="line">      remote_user: root   (可省略,默认为root)  以root身份连接</span><br><span class="line">      tasks:    指定任务</span><br><span class="line">      - name: test connection</span><br><span class="line">        ping:</span><br><span class="line">          remote_user: magedu</span><br><span class="line">          sudo: yes           默认sudo为root</span><br><span class="line">          sudo_user:wang      sudo为wang</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">task列表和action</span><br><span class="line">    任务列表task:由多个动作,多个任务组合起来的,每个任务都调用的模块,一个模块一个模块执行</span><br><span class="line">    1&gt; play的主体部分是task list，task list中的各任务按次序逐个在hosts中指定的所有主机上执行，</span><br><span class="line">       即在所有主机上完成第一个任务后，再开始第二个任务</span><br><span class="line"></span><br><span class="line">    2&gt; task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。</span><br><span class="line">   模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</span><br><span class="line"></span><br><span class="line">    3&gt; 每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。</span><br><span class="line">   如果未提供name，则action的结果将用于输出</span><br></pre></td></tr></table></figure>
<h2 id="playbook书写风格">playbook书写风格</h2>
<p>简单案例：</p>
<p>编写echo.yaml文件，内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim echo.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: 192.168.48.102</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 输出1</span><br><span class="line">    shell: echo &quot;1&quot;</span><br><span class="line">  - name: 输出2</span><br><span class="line">    shell: echo &quot;2&quot;</span><br><span class="line">...</span><br><span class="line">#执行该剧本文件：</span><br><span class="line">ansible-playbook echo.yaml  </span><br></pre></td></tr></table></figure>
<p>命令执行返回的结果:</p>
<p>第一行PLAY表示执行的主机或者主机组。<br>
第二行TASK[Gathering Facts]，在 Playbook 中并没有定义，这是Ansible自带的task 收集主机的信息，此功能非常实用，后面的任务中会详细讲解。这里仅需知晓task为Ansible自带的功能，可以通过Playbook中添加 gather_facts: no 进行关闭。<br>
下面两个task是自行编辑的task，可以发现没有返回结果，但是当出现黄色的changed时代表执行或者修改成功。changed代表前后状态发生改变,例如使用copy模块，拷贝同一个东西，第一次执行成功的时候是changed状态，第二次再执行的时候就是ok状态。ok状态代表:Ansible检查了需要更改的内容发现前后没有变化，所以直接返回ok状态，实际上 Ansible并没有去执行该操作。最后代表状态,即 Playbook的执行结果。ok表示检查了但不需要操作的任务量。failed表示执行失败的数量，changRed代表状unreachable表示不可达的主机数态更改的数量，ok+changed 才代表执行完成的任务数量。</p>
<h2 id="编写playbook">编写playbook</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">httpd.yaml</span></span><br><span class="line"><span class="string">---</span> <span class="comment">##列出第一个play </span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span> <span class="string">package</span> <span class="string">and</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">service</span> <span class="comment">##标明 该play的用途 </span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="number">192.168</span><span class="number">.142</span><span class="number">.101</span> <span class="comment">##指定对其运行play中任务的主机（必填项，指定多台主机可以使用分组，或者 , 分隔） </span></span><br><span class="line">  <span class="attr">tasks:</span> <span class="comment">##play的任务列表 </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span> <span class="string">package</span> <span class="comment">##任务1的描述 </span></span><br><span class="line">    <span class="attr">yum:</span> <span class="comment">##任务1调用yum模块，模块内容往下写 </span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span> <span class="comment">##参数1：yum模块需要使用的软件包 </span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span> <span class="comment">##参数2：安装软件包#以上任务等同于 ansible 192.168.142.101 -m yum -a &quot;name=httpd state=present&quot; </span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">httpd</span> <span class="string">service</span> <span class="comment">##任务2的描述 </span></span><br><span class="line">    <span class="attr">service:</span> <span class="comment">##任务2调用服务模块 </span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span> <span class="comment">##参数1：service调用的服务名称 </span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span> <span class="comment">##参数2：service调用服务要达到的目标状态 </span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span> <span class="comment">##参数3：调用的服务开机启动 </span></span><br><span class="line"><span class="comment">#以上任务等同于 ansible 192.168.142.101 -m service -a &quot;name=httpd state=started enabled=yes&quot; </span></span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/d3e9b9147d35e3d3f3456b1054e3fafa697559838.png" alt="image-20221114191416282"></p>
<h2 id="运行playbook">运行playbook</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">运行playbook的方式</span><br><span class="line">    ansible-playbook &lt;filename.yaml&gt; ... [options]</span><br><span class="line"></span><br><span class="line">常见选项</span><br><span class="line">    --check -C       只检测可能会发生的改变，但不真正执行操作 </span><br><span class="line">                     (只检查语法,如果执行过程中出现问题,-C无法检测出来)</span><br><span class="line">                     (执行playbook生成的文件不存在,后面的程序如果依赖这些文件,也会导致检测失败)</span><br><span class="line">    --list-hosts     列出运行任务的主机</span><br><span class="line">    --list-tags      列出tag  (列出标签)</span><br><span class="line">    --list-tasks     列出task (列出任务)</span><br><span class="line">    --limit 主机列表 只针对主机列表中的主机执行</span><br><span class="line">    -v -vv -vvv      显示过程</span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line">    ansible-playbook hello.yaml --check 只检测</span><br><span class="line">    ansible-playbook hello.yaml --list-hosts  显示运行任务的主机</span><br><span class="line">    ansible-playbook hello.yaml --limit 192.168.142.101  限制主机</span><br><span class="line">    ansible-playbook hello.yaml --list-tasks  显示运行任务的主机</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>1、在ansible工作目录运行</strong> 完整剧本：httpd.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">执行剧本</span><br><span class="line">ansible-playbook playbooks/httpd.yaml</span><br><span class="line">验证服务</span><br><span class="line">ansible 192.168.142.101 -m shell -a &#x27;rpm -qa |grep httpd&#x27;</span><br><span class="line">ansible 192.168.142.101 -m shell -a &#x27;netstat -ntulp |grep 80&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/7f7fc00f8a894e4ae4cd203a40586c6f697559838.png" alt="image-20221025160724333"></p>
<p><strong>2.提高输出的详细程度</strong></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/fd3bad2b52a5e7a286d566f404cd32c3697559838.png" alt="image-20221025160900182"></p>
<p>注：通常使用 ansible-playbook -v 即可。</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/ebc8eb622e0c51ce411c8fc6e565b080697559838.png" alt="image-20221025160914676"></p>
<p><strong>3.执行空运行（冒烟运行）</strong></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/fa4468962ea4914e6af8862b73fc400c697559838.png" alt="image-20221025160948414"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/8dc2f2b09e7590c3e41c6707c5e3cbcd697559838.png" alt="image-20221025160959873"></p>
<h2 id="handlers-notify">handlers+notify</h2>
<p>Handlers 实际上就是一个<font color='red'>触发</font>器，是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作。任务都有状态changed或者ok，只有在任务执行状态为change时，才执行该任务调用的handler。</p>
<p>Notify此action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也<font color='red'>即notify中调用handler中定义的操作</font></p>
<p><font color='red'>示例1：</font></p>
<ol>
<li>使用playbook安装httpd，并验证服务启动，查看httpd使用的端口</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim httpd3.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: Install httpd</span><br><span class="line">    yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: present</span><br><span class="line">  - name: ensure apache is running</span><br><span class="line">    service:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: started</span><br><span class="line">      enabled: yes</span><br><span class="line"></span><br><span class="line">ansible-playbook httpd3.yaml</span><br><span class="line">ansible all -m shell -a &#x27;systemctl status httpd&#x27;</span><br><span class="line">ansible all -m shell -a &#x27;netstat -tunlp|grep httpd&#x27;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在被控端（<font color='red'>两台机</font>）修改httpd的conf文件，监听端口改成8080</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/root/ansible/files</span></span><br><span class="line"><span class="string">cp</span> <span class="string">/etc/httpd/conf/httpd.conf</span>  <span class="string">/root/ansible/files</span></span><br><span class="line"><span class="comment">#如果前面httpd3运行成功，说明成功安装httpd，则httpd.conf会存在</span></span><br><span class="line"><span class="string">vim</span> <span class="string">/root/ansible/files/httpd.conf</span></span><br><span class="line"><span class="comment">#将Listen 80 修改为Listen 8080</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>修改剧本文件，增加拷贝配置文件的task，并重新执行剧本。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">httpd4.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span>   </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup</span> <span class="string">httpd.conf</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">cp</span> <span class="string">/etc/httpd/conf/httpd.conf&#123;,.bak&#125;</span></span><br><span class="line">  <span class="comment">#备份原文件</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> </span><br><span class="line">      <span class="attr">src:</span> <span class="string">/root/ansible/files/httpd.conf</span> </span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/httpd/conf/</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment">#第二步修改了8080端口，将文件移回原处覆盖源文件</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">httpd4.yaml</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;cat /etc/httpd/conf/httpd.conf|grep 8080&#x27;</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;systemctl status httpd&#x27;</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;netstat -tunlp|grep httpd&#x27;</span></span><br><span class="line"><span class="comment">#发现修改配置，但没有生效，因为没有重启httpd应用</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>增加handlers和notify</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">httpd4.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span>   </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> </span><br><span class="line">      <span class="attr">src:</span> <span class="string">/root/ansible/files/httpd.conf</span> </span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/httpd/conf/</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment">#调用触发列表里的 restart httpd任务，调用之后重启httpd，配置文件即刻生效</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="comment">#触发器列表</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">service:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span> </span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">httpd4.yaml</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;netstat -tunlp|grep httpd&#x27;</span></span><br><span class="line"><span class="string">发现端口是8080（即成功）</span></span><br></pre></td></tr></table></figure>
<p>修改/root/ansible/files/httpd.conf ，将端口修改为8081，重新执行httpd4.yaml，并验证服务端口已经改变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook httpd4.yaml</span><br><span class="line">ansible all -m shell -a &#x27;netstat -tunlp|grep httpd&#x27;</span><br></pre></td></tr></table></figure>
<p>发现端口变成8081，说明只有在任务执行状态为change时，才执行该任务调用的handler。</p>
<h2 id="TAGS">TAGS</h2>
<p><font color='red'>tage: 添加标签 </font><br>
<font color='orange'>可以指定某一个任务添加一个标签,添加标签以后,想执行某个动作可以做出挑选来执行,多个动作可以使用同一个标签</font></p>
<p>停止httpd服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m service -a &#x27;name=httpd  state=stopped&#x27;</span><br><span class="line">ansible all -m shell -a &#x27;ss -tln |grep :8081&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@controller</span> <span class="string">~</span>]<span class="comment"># vi httpd5.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">yum:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">install</span> <span class="comment">#install标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">listen8080</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/Listen 80/Listen 8080/g&quot;</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">set8080</span> <span class="comment">#设置8080标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup</span> <span class="string">cofing</span></span><br><span class="line">    <span class="attr">copy:</span></span><br><span class="line">      <span class="attr">src:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/etc/httpd/conf/httpd.conf</span></span><br><span class="line">      <span class="attr">backup:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">backup</span> <span class="comment">#备份标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">配置</span> <span class="string">httpd</span> <span class="string">服务</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">started</span> <span class="comment">#开启httpd服务标签</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">restart</span>  <span class="comment">#重启服务标签</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ansible-playbook</span> <span class="string">-tstarted</span> <span class="string">httpd5.yaml</span>   </span><br><span class="line"><span class="comment">#指定执行started 这个标签</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;ss -tln |grep :8080&#x27;</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">-t</span> <span class="string">install,conf</span> <span class="string">httpd.yaml</span>   </span><br><span class="line"><span class="comment">#指定执行install,backup 两个标签</span></span><br></pre></td></tr></table></figure>
<h2 id="管理变量">管理变量</h2>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/ae1d61c9756b2d4c0b078b277db79758697559838.png" alt="image-20221025165509586"></p>
<p>变量定义：key=value<br>
示例：http_port=80</p>
<p>变量调用方式：<br>
1&gt; 通过 调用变量，<font color='red'>且变量名前后必须有空格</font>，有时用&quot;&quot;才生效 (<font color='red'>引号</font>）</p>
<h3 id="在playbook中定义">在playbook中定义</h3>
<p>vars语句定义全局变量（该变量作用于整个Play）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">test_vars.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test_var</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">test_user1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">create</span> <span class="string">user</span> <span class="string">via</span> <span class="string">a</span> <span class="string">variable</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; username &#125;&#125;</span>&quot;</span>    </span><br><span class="line">      <span class="comment">#冒号后面不能以&#123;开头，不然会报语法错误，需要加上引号。</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="comment">#创建一个test_user1的用户</span></span><br><span class="line"> </span><br><span class="line"> <span class="string">ansible-playbook</span> <span class="string">-v</span> <span class="string">test_vars.yaml</span> </span><br><span class="line"> </span><br><span class="line"> <span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;getent passwd test_user1&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/474483b4ac7c6bae8c1f67e44e1488a2697559838.png" alt="image-20221025165757353"></p>
<p>执行结果：</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/6a81099b1493d280df6d9bc47ddc7034697559838.png" alt="image-20221025165815465"></p>
<h4 id="课堂练习-2">课堂练习</h4>
<p>通过playbook中定义用户名和组名，实现变量引用，创建用户和组。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">var.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">username:</span> <span class="string">user1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">groupname:</span> <span class="string">group1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line">    <span class="attr">group:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; groupname &#125;&#125;</span>&quot;</span> </span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">    <span class="attr">user:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; username &#125;&#125;</span>&quot;</span> </span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">-v</span> <span class="string">var.yaml</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;getent passwd user1&#x27;</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;getent group group1&#x27;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li></li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">开启防火墙</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;systemctl start firewalld&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">firewall.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">insert</span> <span class="string">firewalld</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">firewalld:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; http_port &#125;&#125;</span>/tcp&quot;</span> </span><br><span class="line">      <span class="attr">permanent:</span> <span class="literal">true</span> </span><br><span class="line">      <span class="attr">state:</span> <span class="string">enabled</span> </span><br><span class="line">      <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line">    </span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">-v</span> <span class="string">firewall.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;systemctl stop firewalld&#x27;</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;firewall-cmd --query-port=80/tcp&#x27;</span>  </span><br></pre></td></tr></table></figure>
<h3 id="在独立的变量YAML文件中定义">在独立的变量YAML文件中定义</h3>
<p>当变量较多的时候，或者变量需要多个playbook重用的时候，可以把变量放到独立的文件中，通过关键字&quot;var_files&quot;把文件中定义的变量引用到playbook中。</p>
<p>vars_files 引用变量文件（只能所用于Play全局，不能在某个task中单独被引用）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">var_file.yaml</span></span><br><span class="line"><span class="attr">username:</span> <span class="string">test_user3</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">test_var_file.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test_var_file</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/root/var_file.yaml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">create</span> <span class="string">user</span> <span class="string">via</span> <span class="string">a</span> <span class="string">variable</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; username &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"> </span><br><span class="line"> <span class="string">ansible-playbook</span> <span class="string">-v</span> <span class="string">test_var_file.yaml</span></span><br><span class="line"> </span><br><span class="line"> <span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;getent passwd test_user3&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>练习：将防火墙端口写入</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">将变量写进单独的配置文件中引用</span></span><br><span class="line"><span class="string">test_var_file.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/root/var_file.yaml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">insert</span> <span class="string">firewalld</span> <span class="string">rule</span> <span class="string">for</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">firewalld:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; http_port &#125;&#125;</span>/tcp&quot;</span> </span><br><span class="line">      <span class="attr">permanent:</span> <span class="literal">true</span> </span><br><span class="line">      <span class="attr">state:</span> <span class="string">enabled</span> </span><br><span class="line">      <span class="attr">immediate:</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">vim</span> <span class="string">var_file.yaml</span></span><br><span class="line"><span class="attr">http_port:</span> <span class="number">78</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">-v</span> <span class="string">test_var_file.yaml</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;firewall-cmd --query-port=78/tcp&#x27;</span>  </span><br></pre></td></tr></table></figure>
<h3 id="远程主机上的系统变量（Facts事实）">远程主机上的系统变量（Facts事实）</h3>
<p>ansible会通过setup模块来搜集主机的系统信息，这些搜集到的系统信息叫做Facts。</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/24c7b2090b6a9419a3aefc79545adba5697559838.png" alt="image-20221026102238684"></p>
<p>每个playbook在执行前都会默认执行setup模块，所以这些facts信息是可以以变量的形式被使用。</p>
<h4 id="查看Facts变量">查看Facts变量</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">setup</span> <span class="string">能查看到node节点的所有信息</span></span><br><span class="line"><span class="string">ansible</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.101</span> <span class="string">-m</span> <span class="string">setup</span> <span class="string">|grep</span> <span class="string">ansible_hostname</span></span><br><span class="line"><span class="string">或者可以使用filter过滤信息</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">setup</span> <span class="string">-a</span> <span class="string">&#x27;filter=&quot;ansible_hostname&quot;&#x27;</span>  <span class="string">查询主机名</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">setup</span> <span class="string">-a</span> <span class="string">&#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span>  <span class="string">查询ipv4地址</span></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">setup</span> <span class="string">-a</span> <span class="string">&quot;filter=ansible_memory_mb&quot;</span><span class="string">查询内存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">其他常用信息列出如下：</span></span><br><span class="line"><span class="string">ansible_all_ipv4_addresses：仅显示ipv4的信息。</span></span><br><span class="line"><span class="string">ansible_devices：仅显示磁盘设备信息。</span></span><br><span class="line"><span class="string">ansible_distribution：显示是什么系统，例：centos,suse等。</span></span><br><span class="line"><span class="string">ansible_distribution_major_version：显示是系统主版本。</span></span><br><span class="line"><span class="string">ansible_distribution_version：仅显示系统版本。</span></span><br><span class="line"><span class="string">ansible_machine：显示系统类型，例：32位，还是64位。</span></span><br><span class="line"><span class="string">ansible_eth0：仅显示eth0的信息。</span></span><br><span class="line"><span class="string">ansible_hostname：仅显示主机名。</span></span><br><span class="line"><span class="string">ansible_kernel：仅显示内核版本。</span></span><br><span class="line"><span class="string">ansible_lvm：显示lvm相关信息。</span></span><br><span class="line"><span class="string">ansible_memtotal_mb：显示系统总内存。</span></span><br><span class="line"><span class="string">ansible_memfree_mb：显示可用系统内存。</span></span><br><span class="line"><span class="string">ansible_memory_mb：详细显示内存情况。</span></span><br><span class="line"><span class="string">ansible_swaptotal_mb：显示总的swap内存。</span></span><br><span class="line"><span class="string">ansible_swapfree_mb：显示swap内存的可用内存。</span></span><br><span class="line"><span class="string">ansible_mounts：显示系统磁盘挂载情况。</span></span><br><span class="line"><span class="string">ansible_processor：显示cpu个数(具体显示每个cpu的型号)。</span></span><br><span class="line"><span class="string">ansible_processor_vcpus：显示cpu个数(只显示总的个数)。</span></span><br></pre></td></tr></table></figure>
<h4 id="使用Facts变量">使用Facts变量</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">var2.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">log</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">file:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">/root/&#123;&#123;</span> <span class="string">ansible_hostname</span> <span class="string">&#125;&#125;</span> </span><br><span class="line">      <span class="attr">state:</span> <span class="string">touch</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var2.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;ls /root|grep node*&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="复杂Facts变量的使用">复杂Facts变量的使用</h4>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/cd3caf0b2d86c1b4b3865e00a3b021b6697559838.png" alt="image-20231002194745624"></p>
<p>方式1：使用中括号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ansible_date_time[&quot;date&quot;] &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>方式2：使用点号（<font color='red'>推荐</font>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ansible_date_time.date &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">var2.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">22</span></span><br><span class="line">    <span class="attr">copy:</span></span><br><span class="line">      <span class="attr">content:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_date_time.date &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">dest:</span> <span class="string">/tmp/f1</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">var2.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">ansible</span> <span class="string">all</span> <span class="string">-m</span> <span class="string">shell</span> <span class="string">-a</span> <span class="string">&#x27;cat /tmp/f1&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="关闭Facts">关闭Facts</h4>
<p>搜集facts会消耗额外时间，可以在剧本中设置是否开启和关闭facts搜集。</p>
<p>开启gather_facts:yes，关闭gather_facts:no</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/56eb52bea0d5b4c256492463c0e30800697559838.png" alt="image-20221026112345723"></p>
<h3 id="在-etc-ansible-hosts-主机清单-中定义变量">在/etc/ansible/hosts(主机清单)中定义变量</h3>
<p><font color='red'>普通变量</font>：主机组中主机单独定义，优先级高于公共变量(单个主机 )<br>
<font color='red'>公共(组)变量</font>：针对主机组中所有主机定义统一变量(一组主机的同一类别)</p>
<p>可以是主机级别或者是主机组级别的</p>
<p><strong>定义主机级别变量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/ansible/hosts</span><br><span class="line">[all]</span><br><span class="line">192.168.48.101 username=test_user3   #主机级别变量</span><br><span class="line">192.168.48.102 username=test_user4  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>编辑剧本文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim test_vars2.yaml</span><br><span class="line">---</span><br><span class="line">- name: test inventory vars</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name:  create user via a variable file</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; username &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line"></span><br><span class="line">ansible-playbook -v test_vars2.yaml </span><br><span class="line"> </span><br><span class="line">ansible all -m shell -a &#x27;getent passwd test_user3&#x27;</span><br><span class="line">ansible all -m shell -a &#x27;getent passwd test_user4&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>主机组级别定义变量（相对于主机级别定义的变量，优先级较低）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/ansible/hosts</span><br><span class="line">[all]</span><br><span class="line">192.168.142.101 username=test_user3   #主机级别变量</span><br><span class="line">192.168.142.102   </span><br><span class="line"></span><br><span class="line">[all:vars]</span><br><span class="line">username=test_user5</span><br><span class="line"></span><br><span class="line">ansible-playbook -v test_vars2.yaml </span><br><span class="line">发现第一台主机不变，第二台主机创建新的用户test_user5,证明主机组变量比主机变量优先级低</span><br></pre></td></tr></table></figure>
<h3 id="通过命令行指定变量">通过命令行指定变量</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -e 变量 剧本（优先级最高）</span><br><span class="line"></span><br><span class="line">ansible-playbook -v -e username=test_user10 test_vars2.yaml </span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/263bfcf810cb6203d0f09bfc2cab051a697559838.png" alt="image-20231002210715495"></p>
<p>安装httpd服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">示例：test_vars3.yaml </span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install package</span><br><span class="line">    yum:</span><br><span class="line">      name: &quot;&#123;&#123; pkname &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line">  - name: start service</span><br><span class="line">    service:</span><br><span class="line">      name: &quot;&#123;&#123; pkname &#125;&#125;&quot;</span><br><span class="line">      state: started</span><br><span class="line">      enabled: yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ansible-playbook –e pkname=httpd test_vars3.yaml </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">示例：test_vars3.yaml </span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install package</span><br><span class="line">    yum: </span><br><span class="line">      name: &quot;&#123;&#123; pkname1 &#125;&#125;&quot; </span><br><span class="line">      state: present</span><br><span class="line">  - name: install package</span><br><span class="line">    yum: </span><br><span class="line">      name: &quot;&#123;&#123; pkname2 &#125;&#125;&quot; </span><br><span class="line">      state: present</span><br><span class="line">  </span><br><span class="line">ansible-playbook -e &#x27;pkname1=httpd pkname2=tree&#x27; -v test_vars3.yaml </span><br></pre></td></tr></table></figure>
<h3 id="复杂变量的使用">复杂变量的使用</h3>
<h4 id="数组"><strong>数组</strong></h4>
<p>如果我们定义变量，而这些值都属于同一类型的元素，那么我们必定要用数组。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim test_com_var.yaml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    user_name:</span><br><span class="line">    - test_user11</span><br><span class="line">    - test_user12</span><br><span class="line">    - test_user13</span><br><span class="line">    - test_user14</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create users</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; user_name[1] &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/6f57de99c88237b43b4ccbc3a67c02d4697559838.png" alt="image-20221115081508398"></p>
<p>验证：ansible-playbook -v test_com_var.yaml</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/b254ba1554853d1d124698f5bdd079cd697559838.png" alt="image-20221026101059249"></p>
<p>注意：在用user模块建用户的时候，只能调用数组中的某一个值，不能全部调用，否则报错“用户名不合法”</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/2bc27ba298e15057aac6e29976c63050697559838.png" alt="image-20221026101118216"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/ed1ae8495f0953b23e7e6a5944652254697559838.png" alt="image-20221115081951322"></p>
<h4 id="字典（dictionary）">字典（dictionary）</h4>
<p>如果我们的变量信息中具备多种不同的元素时，采用字典。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim test_com_var.yaml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- name: test_dict</span><br><span class="line">  hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    user_info:</span><br><span class="line">      test_user20:</span><br><span class="line">        name: test_user20</span><br><span class="line">        shell: /bin/bash</span><br><span class="line">        comment: test_user20</span><br><span class="line">      test_user21:</span><br><span class="line">        name: test_user21</span><br><span class="line">        shell: /bin/bash</span><br><span class="line">        comment: test_user21</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create users via dict</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; user_info[&#x27;test_user20&#x27;][&#x27;name&#x27;] &#125;&#125;&quot;</span><br><span class="line">      shell: &quot;&#123;&#123; user_info[&#x27;test_user20&#x27;][&#x27;shell&#x27;] &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/2c0f83a584a0de9b2f45259771a498c7697559838.png" alt="image-20221026101138894"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/28bbd22e9a70bfe446654d04e842304e697559838.png" alt="image-20221115083012804"></p>
<p>变量引用的另一种写法：引用对象写法（python语法）</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/0cb84cd54a577813a2f32a666c2f2721697559838.png" alt="image-20221026101222577"></p>
<p>注意：以点作为分隔（引用对象）这种方式，可能会和python本身的语义引起冲突，所以不建议使用这种方式</p>
<h3 id="注册变量">注册变量</h3>
<p>注册变量是指将一个任务（task）的输出结果定义到一个变量中，这个变量就可以在随后的任务中像普通变量一样使用。<br>
很多情况下，注册变量用来收集shell的执行结果，结果中包含标准输入和标准输出。接下来使用shell模块执行命令将命令结果传入名为var_echo 的变量并使用debug进行检测。<br>
register 的使用形如 register: varname，即 register模块后直接加变量名即可，而register这一行仅仅需要写在需要收集输出的那一行下即可。</p>
<p>案例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim test_com_var.yaml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- name: test_dict</span><br><span class="line">  hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    user_info:</span><br><span class="line">      test_user20:</span><br><span class="line">        name: test_user20</span><br><span class="line">        shell: /bin/bash</span><br><span class="line">        comment: test_user20</span><br><span class="line">      test_user21:</span><br><span class="line">        name: test_user21</span><br><span class="line">        shell: /bin/bash</span><br><span class="line">        comment: test_user21</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create users via dict</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; user_info.test_user21.name &#125;&#125;&quot;</span><br><span class="line">      shell: &quot;&#123;&#123; user_info.test_user21.shell &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line"></span><br><span class="line">ansible-playbook test_com_var.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/6211a906fd3492c7c9a38e99578b03ba697559838.png" alt="image-20221115083847092"></p>
<p>修改剧本文件，加入debug模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vim test_com_var.yaml</span><br><span class="line"></span><br><span class="line">- name: test_dict</span><br><span class="line">  hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    user_info:</span><br><span class="line">      test_user20:</span><br><span class="line">        name: test_user20</span><br><span class="line">        shell: /sbin/nologin</span><br><span class="line">        comment: test_user20</span><br><span class="line">      test_user21:</span><br><span class="line">        name: test_user21</span><br><span class="line">        shell: /sbin/nologin</span><br><span class="line">        comment: test_user21</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create users via dict</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; user_info.test_user21.name &#125;&#125;&quot;</span><br><span class="line">      shell: &quot;&#123;&#123; user_info.test_user21.shell &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line">    register: user_result</span><br><span class="line"></span><br><span class="line">  - name: debug result of user creation</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; user_result &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">ansible-playbook test_com_var.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/2a24783539db1e28f3235517339f1677697559838.png" alt="image-20221115084502083"></p>
<p>可以引用结果中的部分元素（user_result[‘uid’] / user_result.uid）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vim test_com_var.yaml</span><br><span class="line"></span><br><span class="line">- name: test_dict</span><br><span class="line">  hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    user_info:</span><br><span class="line">      test_user20:</span><br><span class="line">        name: test_user20</span><br><span class="line">        shell: /sbin/nologin</span><br><span class="line">        comment: test_user20</span><br><span class="line">      test_user21:</span><br><span class="line">        name: test_user21</span><br><span class="line">        shell: /sbin/nologin</span><br><span class="line">        comment: test_user21</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create users via dict</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; user_info.test_user21.name &#125;&#125;&quot;</span><br><span class="line">      shell: &quot;&#123;&#123; user_info.test_user21.shell &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line">    register: user_result</span><br><span class="line"></span><br><span class="line">  - name: debug result of user creation</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; user_result.uid &#125;&#125;&quot;</span><br><span class="line">      </span><br><span class="line">  ansible-playbook test_com_var.yaml    </span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/03f435628b2b8c8482455bb564e6bcb1697559838.png" alt="image-20221115084642928"></p>
<p>可以对输出结果进行迭代引用（用register存在多个变量中）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim test_com_var.yaml</span><br><span class="line">---</span><br><span class="line">- name: test_dict</span><br><span class="line">  hosts: all</span><br><span class="line">  vars:</span><br><span class="line">    user_info:</span><br><span class="line">      test_user20:</span><br><span class="line">        name: test_user20</span><br><span class="line">        shell: /sbin/nologin</span><br><span class="line">        comment: test_user20</span><br><span class="line">      test_user21:</span><br><span class="line">        name: test_user21</span><br><span class="line">        shell: /sbin/nologin</span><br><span class="line">        comment: test_user21</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create users via dict</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; user_info.test_user21.name &#125;&#125;&quot;</span><br><span class="line">      shell: &quot;&#123;&#123; user_info.test_user21.shell &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line">    register: user_result</span><br><span class="line"></span><br><span class="line">  - name: debug result of user creation</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; user_result.uid &#125;&#125;&quot;</span><br><span class="line">    register: shell_result</span><br><span class="line">  </span><br><span class="line">  - name: debug result of shell</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; shell_result &#125;&#125;&quot;</span><br><span class="line">      </span><br><span class="line">  ansible-playbook test_com_var.yaml    </span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/afce8fc500c006fdc6c8a45e60ddfedf697559838.png" alt="image-20221026101500419"></p>
<h2 id="Ansible-Vault（Ansible-保管箱）">Ansible Vault（Ansible 保管箱）</h2>
<p>作用：加密敏感的数据、密码等信息，通常情况下都是定义在变量内的敏感信息。</p>
<p>应用的情景：</p>
<p>1&gt; 加密变量文件（敏感数据、密码信息等）</p>
<p>2&gt; 加密证书</p>
<p>命令：ansible-vault</p>
<p>命令用法：</p>
<h3 id="创建一个加密文件：">创建一个加密文件：</h3>
<p><strong>ansible-vault create sec.yaml</strong></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/7e575bfdbbc81080494e244fa61c97b1697559838.png" alt="image-20221026101756674"></p>
<p>使用vim sec.ym或者cat sec.yaml只能看到加密后的内容</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/9dfe8e950735a40ce3ba0c269e2308c4697559838.png" alt="image-20221115085325103"></p>
<h3 id="如何查看加密过的文件内容：">如何查看加密过的文件内容：</h3>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/8aae3bf08d3fcaa251077bcc3a4f3511697559838.png" alt="image-20221026101816806"></p>
<h3 id="如何在剧本中调用加密文件">如何在剧本中调用加密文件</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim test_vault.yaml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- name: Create users via vault</span><br><span class="line">  hosts: all</span><br><span class="line">  vars_files:</span><br><span class="line">  - /root/sec.yaml</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Create users</span><br><span class="line">    user:</span><br><span class="line">      name: &quot;&#123;&#123; username &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行剧本时报错</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/025f933f2f98e83475e47b50a770d61d697559838.png" alt="image-20221115090123132"></p>
<p>解决方法：</p>
<p>方法一：ansible-playbook 命令时候添加–ask-vault-pass参数</p>
<p>ansible-playbook --ask-vault-pass test_vault.yaml</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/82a563fff0f7f621f16ca3d89d291984697559838.png" alt="image-20221115090305979"></p>
<p>方法二：ansible-playbook --vault-id @prompt test_vault.yaml（2.3之后使用，建议）</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/80a2a5817cb83a38d6b390b6527dce2b697559838.png" alt="image-20221115090343892"></p>
<p>方法三：ansible-playbook --vault-password-file=pass.yaml  test_vault.yaml</p>
<p>（纯文本形式的密码存放在文件中，只能单行写一个密码，需要对该密码文件加强安全措施）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 123456 &gt; pass.yaml</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/a4679558621742cc1686f226db97fa95697559838.png" alt="image-20221115090537834"></p>
<h3 id="解密">解密</h3>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/5d1b2c41b8ab4d90c396d5152562751b697559838.png" alt="image-20221115090755579"></p>
<h3 id="加密一个已存在的文件">加密一个已存在的文件</h3>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/4013570bd030a34a9106c8076dc20fb9697559838.png" alt="image-20221115090808908"></p>
<h3 id="重置加密文件的密码">重置加密文件的密码</h3>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/caf0c57add1d5190b8257e56dce85667697559838.png" alt="image-20221115090908211"></p>
<h3 id="编辑已存在的加密文件">编辑已存在的加密文件</h3>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/89af0166415695c89a5711c014ca410f697559838.png" alt="image-20221115090956109"></p>
<p>Tips：如果我们使用加密文件保存变量、密码等敏感数据，最好采用隐藏文件来存放，增强安全性。</p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/c691ac4b1c29f213060409edcc3de254697559838.png" alt="image-20221115091217928"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/498cf7e4e15fe6dfe844f225b30b41ba697559838.png" alt="image-20221115091252760"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --vault-password-file=.pass.yaml  test_vault.yaml</span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/4f45d34d83e8abd8fb954cd8389cc991697559838.png" alt="image-20221115091403345"></p>
<h2 id="综合实践">综合实践</h2>
<p>编辑剧本文件实现以下功能：</p>
<p>0、设置主机组 all</p>
<p>1、设置变量 定义nginx服务端口为8081</p>
<p>2、关闭facts</p>
<p>3、调用service模块，卸载受控端的httpd</p>
<p>4、调用SELinux模块，关闭selinux</p>
<p>5、调用yum模块安装epel源</p>
<p>6、调用yum模块安装nginx</p>
<p>7、调用lineinfile模块修改nginx配置文件中的监听端口，使用自定义的服务端口变量，并将结果注册到 port_result</p>
<p>8、调用service模块启动nginx，并设置为开机自启动</p>
<p>9、调用debug模块，msg信息为port_result</p>
<p>10、验证受控端服务及端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: no</span><br><span class="line">  vars: </span><br><span class="line">    nginx_port: &quot;8081&quot;</span><br><span class="line">  tasks:   </span><br><span class="line">  - name: uninstall httpd</span><br><span class="line">    yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: absent</span><br><span class="line">  - name: stop selinux</span><br><span class="line">    selinux:</span><br><span class="line">      state: disabled</span><br><span class="line">  - name: install epel</span><br><span class="line">    yum:</span><br><span class="line">      name: epel-release</span><br><span class="line">      state: present</span><br><span class="line">  - name: </span><br><span class="line">    yum:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: present</span><br><span class="line">  - name: set nginx_port</span><br><span class="line">    lineinfile:</span><br><span class="line">      path: /etc/nginx/nginx.conf</span><br><span class="line">      regexp: &quot;        listen       80;&quot;</span><br><span class="line">      line: &quot;        listen       &#123;&#123; nginx_port &#125;&#125;;&quot;</span><br><span class="line">    register: port_result   </span><br><span class="line">  - name: start nginx</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: started</span><br><span class="line">      enabled: yes</span><br><span class="line">  - name: debug msg</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; port_result &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ansible-playbook  install_nginx.yaml -C</span><br><span class="line"></span><br><span class="line">ansible-playbook install_nginx.yaml  </span><br><span class="line"></span><br><span class="line">ansible all -m shell -a  &quot;ps aux |grep nginx &quot;  </span><br><span class="line"></span><br><span class="line">ansible all -m shell -a  &quot;netstat -lntp |grep nginx &quot; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/aa4e8fcbb552d3e8d48e4e3e14619f90697559838.png" alt="image-20230926165830835"></p>
<p><img src="/../img/Ansible-%E6%80%BB%E6%89%8B%E5%86%8C.assets/0c68702617a92029f20139bba48637ad697559838.png" alt="image-20230926165852495"></p>
<h1 id="Ansible-templates">Ansible-templates</h1>
<h2 id="JINJA2语法简要介绍">JINJA2语法简要介绍</h2>
<p>Jinja2语言，支持的数据类型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">字符串：使用单引号或双引号</span><br><span class="line">数字：整数，浮点数</span><br><span class="line">列表：[item1, item2, ...]</span><br><span class="line">元组：(item1, item2, ...)</span><br><span class="line">字典：&#123;key1:value1, key2:value2, ...&#125;</span><br><span class="line">布尔型：true/false</span><br></pre></td></tr></table></figure>
<p>支持的运算及操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">算术运算：+, -, *, /, //, %, **</span><br><span class="line">比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=</span><br><span class="line">逻辑运算：and，or，not</span><br><span class="line">流表达式：For，If，When</span><br></pre></td></tr></table></figure>
<h2 id="Playbook的进阶应用">Playbook的进阶应用</h2>
<h3 id="使用when实现条件判断">使用when实现条件判断</h3>
<p>条件测试:如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试。<strong>剧本中不能使用if判断，需要使用when判断。</strong></p>
<p>when语句：在task后添加when子句即可使用条件测试，可以使用facts或playbook中定义的变量，支持Jinja2表达式语法</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - name: &quot;shutdown RedHat flavored systems&quot;</span><br><span class="line">    command: /sbin/shutdown -h now</span><br><span class="line">    when: ansible_os_family == &quot;RedHat&quot;  当系统属于红帽系列,执行command模块，注意：&#x27;所有变量&#x27;都可以直接在条件语句中使用，而无需使用双大括号</span><br></pre></td></tr></table></figure>
<p>也可以使用多个when进行多条件判断，等效于and。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim test_when.yml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: copy file</span><br><span class="line">    copy:</span><br><span class="line">      src: /etc/hosts</span><br><span class="line">      dest: /root/hosts_when</span><br><span class="line">    when: ansible_hostname is match &quot;node1&quot;		#when支持通配符</span><br><span class="line"></span><br><span class="line">ansible all --list</span><br><span class="line">ansible-playbook  test_when.yml</span><br><span class="line">ansible all -m shell -a &quot;ls -l /root/hosts_when&quot;</span><br></pre></td></tr></table></figure>
<h3 id="使用with-items实现迭代">使用with_items实现迭代</h3>
<p>迭代：当有需要重复性执行的任务时，可以使用迭代机制<br>
&gt; 对迭代项的引用，固定变量名为&quot;item&quot;</p>
<blockquote>
<p>要在task中使用with_items给定要迭代的元素列表，<br>
&gt; 列表格式：<br>
字符串<br>
字典</p>
</blockquote>
<h3 id="示例：打印1、2、3"><strong>示例：打印1、2、3</strong></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim test_items.yml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- name: add serveral users</span><br><span class="line">  gather_facts: no</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: test loop</span><br><span class="line">    debug: </span><br><span class="line">      msg: &quot;name --- &#123;&#123; item &#125;&#125;&quot; #&#123;&#123; item &#125;&#125; 系统自定义变量</span><br><span class="line">    with_items:   ##with_items定义&#123;&#123; item &#125;&#125; 的值和个数,      一般放到模块的末尾，与模块同一缩进级别    </span><br><span class="line">    - one</span><br><span class="line">    - two</span><br><span class="line">    - three</span><br></pre></td></tr></table></figure>
<h3 id="示例：创建用户">示例：创建用户</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim test_items.yml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- name: add serveral users</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - user:</span><br><span class="line">      name: &quot;&#123;&#123; item  &#125;&#125;&quot;  #&#123;&#123; item &#125;&#125; 系统自定义变量</span><br><span class="line">      state: present</span><br><span class="line">    with_items:           ##with_items定义&#123;&#123; item &#125;&#125; 的值和个数,一般放到模块的末尾，与模块同一缩进级别    </span><br><span class="line">    - testuser1</span><br><span class="line">    - testuser2</span><br><span class="line"></span><br><span class="line">ansible all --list</span><br><span class="line">ansible-playbook  test_items.yml</span><br><span class="line">ansible all -m shell -a &quot;getent passwd testuser1&quot;</span><br><span class="line"></span><br><span class="line">上面语句的功能等同于下面的语句：</span><br><span class="line">- name: add user testuser1</span><br><span class="line">  user: name=testuser1 state=present </span><br><span class="line">- name: add user testuser2</span><br><span class="line">  user: name=testuser2 state=present </span><br></pre></td></tr></table></figure>
<h3 id="示例：拷贝多个文件">示例：拷贝多个文件</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">touch /root/1.txt /root/2.txt</span><br><span class="line"></span><br><span class="line">vim test_items2.yml</span><br><span class="line">---</span><br><span class="line">- name: copy serveral files</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - copy:</span><br><span class="line">      src: /root/&#123;&#123; item  &#125;&#125;</span><br><span class="line">      dest: /etc/&#123;&#123; item &#125;&#125;</span><br><span class="line">    with_items:          </span><br><span class="line">    - 1.txt</span><br><span class="line">    - 2.txt</span><br><span class="line"></span><br><span class="line">ansible-playbook  test_items2.yml</span><br><span class="line">ansible all -m shell -a &quot;ls -l /etc/*.txt&quot;</span><br></pre></td></tr></table></figure>
<h3 id="示例：迭代字典">示例：迭代字典</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">with_items中可以使用元素还可为hashes</span><br><span class="line">示例：</span><br><span class="line">vim test_items3.yml</span><br><span class="line">---</span><br><span class="line">- name: add several users</span><br><span class="line">  gather_facts: no</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - user:</span><br><span class="line">      name: &quot;&#123;&#123; item.name &#125;&#125;&quot;</span><br><span class="line">      state: present</span><br><span class="line">      groups: &quot; &#123;&#123; item.groups &#125;&#125;&quot;</span><br><span class="line">    with_items:</span><br><span class="line">    - &#123; name: &#x27;testuser3&#x27;, groups: &#x27;wheel&#x27; &#125;</span><br><span class="line">    - &#123; name: &#x27;testuser4&#x27;, groups: &#x27;root&#x27; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ansible-playbook  test_items3.yml</span><br><span class="line">ansible all -m shell -a &quot;getent passwd testuser3&quot;</span><br><span class="line">ansible all -m shell -a &quot;id testuser3&quot;</span><br><span class="line">ansible all -m shell -a &quot;getent passwd testuser4&quot;</span><br><span class="line">ansible all -m shell -a &quot;id testuser4&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="课堂作业：使用with—items拷贝多个文件">课堂作业：使用with—items拷贝多个文件</h3>
<p>要求：item列表条目为字典类型，包含src、dest、mode3个键值对，使用with_items实现多个文件的拷贝，并赋予设定的权限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">touch /root/3.txt /root/4.txt</span><br><span class="line">vim test_items4.yml</span><br><span class="line">---</span><br><span class="line">- name: copy several files</span><br><span class="line">  hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - copy:</span><br><span class="line">      src: &quot;&#123;&#123; item.src &#125;&#125;&quot;</span><br><span class="line">      dest: &quot;&#123;&#123; item.dest &#125;&#125;&quot;</span><br><span class="line">      mode: &quot;&#123;&#123; item.mode &#125;&#125;&quot;</span><br><span class="line">    with_items:          </span><br><span class="line">    - &#123; src: &quot;/root/3.txt&quot;, dest: &quot;/root/&quot;, mode: &quot;0644&quot; &#125;</span><br><span class="line">    - &#123; src: &quot;/root/4.txt&quot;, dest: &quot;/root/&quot;, mode: &quot;0644&quot; &#125;</span><br><span class="line"></span><br><span class="line">ansible-playbook  test_items4.yml</span><br><span class="line">ansible all -m shell -a &quot;ls -l /root/*.txt&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="when和with-items组合使用">when和with items组合使用</h4>
<p>当when和with_items一起使用的时候，每个项都会单独被when语句处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim test_when_items.yml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - command: echo &#123;&#123; item &#125;&#125;</span><br><span class="line">    with_items: [ 1,2,3,4,5,6,8,10]</span><br><span class="line">    when: item &gt; 5</span><br><span class="line">         </span><br><span class="line"> ansible-playbook test_when_items.yml</span><br></pre></td></tr></table></figure>
<h2 id="templates-模板">templates 模板</h2>
<p>templates功能：根据模板文件动态生成对应的配置文件，命名必须以.j2结尾，支持jinja2语法。</p>
<p>在呈现 JINJA2模板时，文件中引用的变量和表达式被替换为对应的值。模板中使用的变量可以在 Playbook 的 vars 部分中指定。可以将受管主机的事实用作模板中的变量。</p>
<p>分隔符使用规范：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% EXPR %&#125;：用于表达式或逻辑（如循环、判断等）</span><br><span class="line"></span><br><span class="line">&#123;&#123; EXPR &#125;&#125;：用于向最终用户输出表达式或变量的结果。在呈现时将被替换为一个或多个值，对最终用户可见。</span><br><span class="line"></span><br><span class="line">&#123;# COMMENT #&#125;，用于注释，不会出现在最终文件中。</span><br></pre></td></tr></table></figure>
<h3 id="templates的使用场景">templates的使用场景</h3>
<p>在实际的工作中由于每台服务器的环境配置都可能不同，但是往往很多服务的配置文件都需要根据服务器环境进行不同的配置，比如Nginx最大进程数、Redis最大内存等。</p>
<p>为了解决这个问题可以使用Ansible的template模块，该模块和copy模块作用基本一样，都是把管理端的文件复制到客户端主机上，但是区别在于template模块可以通过变量来获取配置值，支持多种判断、循环、逻辑运算等，而copy只能原封不动的把文件内容复制过去。</p>
<h4 id="示例：httpd-conf的templates模板">示例：httpd.conf的templates模板</h4>
<p>创建并编辑httpd.conf.j2文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">rpm -qa httpd</span><br><span class="line"> </span><br><span class="line">cp /etc/httpd/conf/httpd.conf /root/httpd.conf.j2</span><br><span class="line"> </span><br><span class="line">vim /root/httpd.conf.j2</span><br><span class="line"> </span><br><span class="line">---------42行----------</span><br><span class="line">Listen &#123;&#123;port&#125;&#125;</span><br><span class="line"> </span><br><span class="line">----------95行---------</span><br><span class="line">ServerName &#123;&#123;domain&#125;&#125;</span><br><span class="line"> </span><br><span class="line">vim /etc/ansible/hosts</span><br><span class="line"> </span><br><span class="line">[websrvs]</span><br><span class="line">192.168.142.101 port=80 domain=www.node1.com</span><br><span class="line">192.168.142.102 port=81 domain=www.node2.com</span><br></pre></td></tr></table></figure>
<p>卸载受控机上的httpd服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible websrvs -m shell -a &#x27;yum remove -y httpd&#x27;</span><br><span class="line">ansible websrvs -m shell -a &#x27;yum remove -y nginx&#x27;</span><br></pre></td></tr></table></figure>
<p>新建yaml文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cd /root</span><br><span class="line">vim a.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">  - package: httpd</span><br><span class="line">  - service: httpd</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install service</span><br><span class="line">    yum:</span><br><span class="line">      name: &quot;&#123;&#123; package &#125;&#125;&quot;</span><br><span class="line">      state: latest</span><br><span class="line"></span><br><span class="line">  - name: httpd.conf</span><br><span class="line">    template:</span><br><span class="line">      src: /root/httpd.conf.j2</span><br><span class="line">      dest: /etc/httpd/conf/httpd.conf</span><br><span class="line">    notify: restart service</span><br><span class="line"></span><br><span class="line">  - name: start service</span><br><span class="line">    service:</span><br><span class="line">      name: &quot;&#123;&#123; service &#125;&#125;&quot;</span><br><span class="line">      state: started</span><br><span class="line">      enabled: true</span><br><span class="line"> </span><br><span class="line"> handlers:</span><br><span class="line">  - name: restart service</span><br><span class="line">    service:</span><br><span class="line">      name: &quot;&#123;&#123; service &#125;&#125;&quot;</span><br><span class="line">      state: restarted</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行yaml文件并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook a.yaml --syntax-check</span><br><span class="line">ansible-playbook a.yaml</span><br><span class="line">ansible websrvs -a &#x27;systemctl status httpd&#x27;</span><br><span class="line">ansible websrvs -m shell -a &#x27;ss -ntl&#x27;</span><br><span class="line">ansible websrvs -m shell -a &#x27;netstat -ntlp |grep httpd&#x27;</span><br><span class="line">ansible websrvs -m shell -a &#x27;lsof -i:80&#x27;</span><br><span class="line">ansible websrvs -m shell -a &#x27;lsof -i:81&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="tamplates-for-循环">tamplates-for(循环)</h4>
<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for 变量 in 列表 %&#125;</span><br><span class="line">&#123;&#123; 文本内容调用变量 &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>示例：使用for循环遍历调用users列表变量的元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;%  for user in users %&#125;</span><br><span class="line">&#123;&#123;  user &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例：yaml文件中变量的调用">示例：yaml文件中变量的调用</h3>
<p>编写yaml文件 jinja2_for.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim jinja2_for.yml</span><br><span class="line">---</span><br><span class="line">- name: jinja2_for example</span><br><span class="line">  hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    users:</span><br><span class="line">    - user1</span><br><span class="line">    - user2</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Copy template</span><br><span class="line">    template: </span><br><span class="line">      src: /root/users.j2</span><br><span class="line">      dest: /root/users </span><br></pre></td></tr></table></figure>
<p>编写/root/users.j2文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /root/users.j2</span><br><span class="line">&#123;% for user in users %&#125;</span><br><span class="line">username: &#123;&#123; user &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>执行并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook jinjia2_for.yml --syntax-check</span><br><span class="line">ansible-playbook jinjia2_for.yml</span><br><span class="line">ansible all -m shell -a &quot;cat /root/users&quot;</span><br></pre></td></tr></table></figure>
<p><strong>扩展示例：</strong></p>
<p>以下示例模板使用for语句逐一运行users变量中的所有值，将user替换为各个值，但值为root时除外。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim users.j2</span><br><span class="line"></span><br><span class="line">&#123;# for statement #&#125;</span><br><span class="line">&#123;% for user in users if not user ==&quot;root&quot; %&#125;</span><br><span class="line">User number &#123;&#123; loop.index &#125;&#125;- &#123;&#123; user &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>loop.index变量扩展至循环当前所处的索引号。它在循环第一次执行时值为1，每一次迭代递增1.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook jinjia2_for.yml --syntax-check</span><br><span class="line">ansible-playbook jinjia2_for.yml</span><br><span class="line"></span><br><span class="line">ansible all -m shell -a &quot;cat /root/users&quot;</span><br></pre></td></tr></table></figure>
<h3 id="示例：事实变量的调用">示例：事实变量的调用</h3>
<p>编写yaml文件  jinja2_for2.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim jinja2_for2.yml</span><br><span class="line">---</span><br><span class="line">- name: jinja2_for example2</span><br><span class="line">  hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    users:</span><br><span class="line">    - user1</span><br><span class="line">    - user2</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Copy template</span><br><span class="line">    template: </span><br><span class="line">      src: /root/host.j2</span><br><span class="line">      dest: /root/hosts </span><br></pre></td></tr></table></figure>
<p>编写/root/host.j2文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /root/host.j2</span><br><span class="line">&#123;% for host in groups[&#x27;websrvs&#x27;] %&#125;</span><br><span class="line">&#123;&#123; ansible_facts.default_ipv4.address &#125;&#125;&#123;&#123; ansible_facts.fqdn &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>执行并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook jinjia2_for2.yml --syntax-check</span><br><span class="line">ansible-playbook jinjia2_for2.yml</span><br><span class="line"></span><br><span class="line">ansible websrvs -m shell -a &quot;cat /root/hosts&quot;</span><br></pre></td></tr></table></figure>
<h4 id="tamplates-if（判断）">tamplates-if（判断）</h4>
<p>Jinja2使用 if 语句来提供条件控制。如果满足条件，允许在文件中添加一行内容。</p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if 条件 %&#125;</span><br><span class="line">&#123;&#123; 语句 &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例：">示例：</h3>
<p>编写yaml文件 jinja2_if.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim jinja2_if.yml</span><br><span class="line">---</span><br><span class="line">- name: jinja2_if example</span><br><span class="line">  hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: Copy template</span><br><span class="line">    template: </span><br><span class="line">      src: /root/host2.j2</span><br><span class="line">      dest: /root/hosts2 </span><br></pre></td></tr></table></figure>
<p>编辑host2.j2文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /root/host2.j2</span><br><span class="line"></span><br><span class="line">&#123;% if ansible_facts.default_ipv4.address ==&#x27;192.168.142.101&#x27; %&#125;</span><br><span class="line">&#123;&#123; ansible_facts.default_ipv4.address &#125;&#125;&#123;&#123; ansible_facts.fqdn &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>执行并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook jinja2_if.yml --syntax-check</span><br><span class="line">ansible-playbook jinja2_if.yml</span><br><span class="line">ansible all -m shell -a &quot;cat /root/hosts2&quot;</span><br></pre></td></tr></table></figure>
<h2 id="综合案例：nginx-templates">综合案例：nginx templates</h2>
<p>0、编辑主机清单，组websrvs，包含2台受控主机</p>
<p>1、主控端安装ngxin、拷贝nginx配置文件为nginx.conf.j2模板文件。创建nginx首页模版，命名为html.j2,引用实事变量：主机名，文件内容格式如： Welcome to </p>
<p>2、编写test_template.yaml文件，要求tasks</p>
<p>​      1）安装epel源 2）安装nginx 3）拷贝nginx.conf.j2模板文件为受控主机的nginx配置文件4）拷贝html.j2模板文件为受控主机的nginx首页文件4）开启服务</p>
<p>3、校验playbook语法并执行，验证受控主机的nginx进程数\服务端口\首页</p>
<p>4、修改nginx.conf.j2模板文件，配置 worker_processes数量为实事变量：受控主机处理器vcpu个数的两倍，保存</p>
<p>5、修改test_template.yaml文件，添加notify和handlers，在配置文件变化时，重启nginx</p>
<p>6、校验playbook语法并执行，验证受控主机的nginx进程数</p>
<p>7、修改hosts文件为每台主机定义服务端口变量 第一台 8082，第二台8083</p>
<p>8、修改test_template.yaml文件，修改监听端口行，增加主机端口变量的引用</p>
<p>9、校验playbook语法并执行，验证受控主机的nginx服务端口</p>
<p>10、修改test_template.yaml，增加端口变量定义，端口88</p>
<p>11、校验playbook语法并执行，验证受控主机的nginx服务端口</p>
<p>1、主控端安装ngxin、拷贝nginx配置文件为nginx.conf.j2模板文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nginx</span><br><span class="line">cp /etc/nginx/nginx.conf /root/nginx.conf.j2</span><br><span class="line">echo &quot;welcome to &#123;&#123; ansible_hostname  &#125;&#125;&quot; &gt; html.j2</span><br><span class="line"></span><br><span class="line">ansible all -m setup |grep hostname</span><br><span class="line">ansible all -m setup |grep vcpu</span><br></pre></td></tr></table></figure>
<p>2、创建nginx首页模版，命名为html.j2,引用实事变量：主机名</p>
<p>内容格式如： Welcome to </p>
<p>2、编写test_template.yaml文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">vim test_template.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install epel</span><br><span class="line">    yum:</span><br><span class="line">      name: epel-release</span><br><span class="line">  - name: install package</span><br><span class="line">    yum:</span><br><span class="line">      name: nginx</span><br><span class="line">  - name: copy template</span><br><span class="line">    template:</span><br><span class="line">      src: /root/nginx.conf.j2</span><br><span class="line">      dest: /etc/nginx/nginx.conf</span><br><span class="line">  - name: copy template</span><br><span class="line">    template:</span><br><span class="line">      src: /root/html.j2</span><br><span class="line">      dest: /usr/share/nginx/html</span><br><span class="line">  - name: copy html</span><br><span class="line">    template:</span><br><span class="line">      src: /root/html.j2</span><br><span class="line">      dest: /usr/share/nginx/html/index.html    </span><br><span class="line">  - name: start service</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: started</span><br><span class="line">      enabled: yes</span><br></pre></td></tr></table></figure>
<p>执行并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook test_template.yaml  --syntax-check</span><br><span class="line">ansible-playbook test_template.yaml  </span><br><span class="line">ansible all -m shell -a &#x27;systemctl status nginx&#x27;</span><br><span class="line">ansible all -m shell -a &#x27;ss -ntpl|grep nginx&#x27;</span><br><span class="line">#可以查看到进程，每个cpu一个</span><br><span class="line">ansible all -m shell -a &#x27;ps aux|grep nginx&#x27;</span><br></pre></td></tr></table></figure>
<p>3、修改template文件，修改进程数为cpu内核的2倍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible websrvs -m setup|grep &quot;cpu&quot;</span><br><span class="line"></span><br><span class="line">vim nginx.conf.j2</span><br><span class="line">修改第6行</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus*2  &#125;&#125;    #worker_processes auto</span><br></pre></td></tr></table></figure>
<p>修改test_template.yaml文件，添加notify和handlers，在配置文件变化时，重启nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">vim test_template.yaml</span><br><span class="line">---</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install package</span><br><span class="line">    yum:</span><br><span class="line">      name: nginx</span><br><span class="line">  - name: copy template</span><br><span class="line">    template:</span><br><span class="line">      src: /root/nginx.conf.j2</span><br><span class="line">      dest: /etc/nginx/nginx.conf</span><br><span class="line">    notify:</span><br><span class="line">    - restart service</span><br><span class="line">  - name: copy html</span><br><span class="line">    template:</span><br><span class="line">      src: /root/html.j2</span><br><span class="line">      dest: /usr/share/nginx/html/index.html    </span><br><span class="line">  - name: start service</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: started</span><br><span class="line">      enabled: yes</span><br><span class="line">  handlers:</span><br><span class="line">  - name: restart service</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: restarted</span><br></pre></td></tr></table></figure>
<p>执行并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook test_template.yaml</span><br><span class="line">#可以查看到进程，</span><br><span class="line">ansible all -m shell -a &#x27;ps aux|grep nginx&#x27; #查看nginx进程数为cpu核数的2倍</span><br></pre></td></tr></table></figure>
<p>检验nginx配置文件是否存在语法错误</p>
<p>nginx -t</p>
<p>nginx和httpd服务，web服务保证只有一个运行。</p>
<p>4、使用主机变量，修改服务端口</p>
<p>修改hosts文件增加端口变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#使用主机变量</span><br><span class="line">#修改nginx对应的端口</span><br><span class="line">vim /etc/ansible/hosts</span><br><span class="line">[websrvs]</span><br><span class="line">192.168.142.101 http_port=8083</span><br><span class="line">192.168.142.102 http_port=8084</span><br></pre></td></tr></table></figure>
<p>修改模板文件，增加端口引用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf.j2</span><br><span class="line">修改39、40行</span><br><span class="line">server&#123;</span><br><span class="line">    listen   &#123;&#123; http_port &#125;&#125; ;</span><br><span class="line">    listen   [::]:&#123;&#123;  http_port  &#125;&#125; ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook test_template.yaml</span><br><span class="line">ansible websrvs -m shell -a &#x27;ss -ntpl|grep nginx&#x27;</span><br></pre></td></tr></table></figure>
<p>5、使用playbook变量</p>
<p>修改test_template.yaml，增加端口信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim test_template.yaml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars：</span><br><span class="line">  - http_port: 88</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install package</span><br><span class="line">    yum:</span><br><span class="line">      name: nginx</span><br><span class="line">  - name: copy template</span><br><span class="line">    template:</span><br><span class="line">      src: /root/nginx.conf.j2</span><br><span class="line">      dest: /etc/nginx/nginx.conf</span><br><span class="line">    notify:</span><br><span class="line">    - restart service</span><br><span class="line">  - name: copy html</span><br><span class="line">    template:</span><br><span class="line">      src: /root/html.j2</span><br><span class="line">      dest: /usr/share/nginx/html/index.html   </span><br><span class="line">  - name: start service</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: started</span><br><span class="line">      enabled: yes</span><br><span class="line">  handlers:</span><br><span class="line">  - name: restart service</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: restarted</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行并验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook test_template.yaml</span><br><span class="line">ansible websrvs -m shell -a &#x27;ss -ntpl|grep nginx&#x27;</span><br><span class="line">#发现端口变成88</span><br></pre></td></tr></table></figure>
<p>6、使用命令行变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -e &quot;http_port=99&quot;  test_template.yaml</span><br><span class="line">ansible websrvs -m shell -a &#x27;ss -ntpl|grep nginx&#x27;</span><br><span class="line">#发现端口变成99</span><br></pre></td></tr></table></figure>
<h1 id="Roles">Roles</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">·由来: ansible自动化运行，基础由AD-Hoc命令来完成，在命令变多时，产生了playbook进行管理任务，简单任务使用playcook可以轻松处理，但是有复杂任务时单个playbook不可以胜任了，这时需要把多个playbook进行组合，少量用include将剧本中任务互相关联即可完成，但是playbook还在增多的情况时就不方便管理了，这时引入roles对playbook进行有效组织就十分必要了</span><br><span class="line">· Roles:角色，是ansible自1.2版本开始引入的新特性</span><br><span class="line">·目的:用于层次性，结构化地组织playbook, roles能够根据层次型结构自动装载变量、文件、任务、模块及触发器·方法: roles通过分别将放置于变量、文件、任务、模块及触发器单独的目录中，并可以便捷地include它们的一种机制·应用:角色一般用于基于主机构建服务的场景中、但也可以是用于构建守护进程等场景中</span><br></pre></td></tr></table></figure>
<h2 id="roles默认路径设置">roles默认路径设置</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/ansible.cfg</span><br><span class="line">roles_path= /etc/ansible/roles</span><br></pre></td></tr></table></figure>
<h2 id="Roles各目录结构及作用">Roles各目录结构及作用</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">每个角色，以特定的层级目录结构进行组织</span><br><span class="line">roles目录结构：</span><br><span class="line">playbook.yml  调用角色</span><br><span class="line">roles/</span><br><span class="line">  project/ (角色名称)</span><br><span class="line">    tasks/</span><br><span class="line">    files/</span><br><span class="line">    vars/</span><br><span class="line">    templates/</span><br><span class="line">    handlers/</span><br><span class="line">    default/ 不常用，设定默认变量时使用此目录中的main.yml文件</span><br><span class="line">    meta/    不常用，定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件；其它文件需在此文件中通过include进行包含</span><br><span class="line">各目录的作用：</span><br><span class="line">/roles/project/ :项目名称,有以下子目录，project可以是mysql\httpd\nginx\memcached等</span><br><span class="line">    files/ ：存放由copy或script模块等调用的文件</span><br><span class="line">    templates/：template模块查找所需要模板文件的目录</span><br><span class="line">    tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件, 其定义了此角色的任务列表.</span><br><span class="line">             在handler中使用include包含的其它的handler文件也应该位于此目录中；</span><br><span class="line">    handlers/：至少应该包含一个名为main.yml的文件；用于定义此角色用到的各handler；</span><br><span class="line">               其它的文件需要在此文件中通过include进行包含</span><br><span class="line">    vars/：定义变量，至少应该包含一个名为main.yml的文件,；</span><br><span class="line">           其它的文件需要在此文件中通过include进行包含</span><br><span class="line">    meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，</span><br><span class="line">           其它文件需在此文件中通过include进行包含, ansible1.3及其以后的版本才支持；</span><br><span class="line">    defaults/：为当前角色设定默认变量时使用此目录；应当包含一个main.yml文件</span><br></pre></td></tr></table></figure>
<h3 id="创建role框架">创建role框架</h3>
<p>您可以使用标准Linux命令创建新角色所需的所有子目录和文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/ansible/roles/</span><br><span class="line">mkdir  httpd</span><br><span class="line">cd httpd</span><br><span class="line">mkdir  tasks  handlers  vars  meta  defaults templates files </span><br></pre></td></tr></table></figure>
<p>或者可以运行ansible-galaxy init来创建新角色的目录结构。指定角色的名称作为命令的参数，该命令在当前工作目录中为新角色创建子目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/ansible/roles</span><br><span class="line">ansible-galaxy init httpd</span><br><span class="line">tree httpd</span><br><span class="line">[root@controller roles]# tree httpd</span><br><span class="line">httpd      #具体的⾓⾊项⽬名称，   ⽐如nginx、tomcat、php  (⾃由设置)</span><br><span class="line">├── defaults  #⽤于为当前⾓⾊设定默认变量，  此⽬录应当包含⼀个main.yml⽂件</span><br><span class="line">│   └── main.yml  #类似代码中的主函数，  进⾏统⼀管理</span><br><span class="line">├── files      #⽤来存放由copy模块或script模块等模块调⽤的⽂件</span><br><span class="line">├── handlers    #⽤于定义此⾓⾊中触发条件时执⾏的动作，  此⽬录应当包含⼀个main.yml⽂件</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── meta      #⽤于定义此⾓⾊的特殊设定及其依赖关系，  此⽬录应当包含⼀个main.yml⽂件</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── README.md   #说明⽂件</span><br><span class="line">├── tasks       #⽤于定义当前⾓⾊的任务列表，  此⽬录应当包含⼀个main.yml⽂件</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates  #⽤来存放jinjia2模板，template模块会⾃动在此⽬录中寻找jinjia2模板⽂件</span><br><span class="line">├── tests   #⽤于存放测试role本⾝功能的playbook和主机定义⽂件，  在开发测试阶段⽐较常⽤ ,此⽬录应当包含⼀个main.yml⽂件和⾃⾝资源设定invetory</span><br><span class="line">│   ├── inventory</span><br><span class="line">│   └── test.yml</span><br><span class="line">└── vars    #⽤于定义此⾓⾊⽤到的变量，  此⽬录应当包含⼀个main.yml⽂件</span><br><span class="line">    └── main.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="实验任务：安装httpd服务">实验任务：安装httpd服务</h1>
<p>原始的playbook版本</p>
<p>1、制作主页</p>
<p>echo hi &gt; index.html</p>
<p>2、拷贝本机httpd的配置文件为httpd.conf.j2模版，并修改</p>
<p>cp /etc/httpd/conf/httpd.conf  httpd.conf.j2</p>
<p>vim  httpd.j2   #42行 修改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if http_port is defined %&#125;</span><br><span class="line">Listen &#123;&#123; ansible_facts.default_ipv4.address &#125;&#125;:&#123;&#123; http_port &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>3、编写playbook文件，</p>
<p>创建变量http_port: 8080</p>
<p>执行任务：</p>
<p>1)安装httpd</p>
<p>2)拷贝主页</p>
<p>3)拷贝配置（做触发器）</p>
<p>4)防火墙放通自定义的端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: firewalld configuration</span><br><span class="line">  firewalld:  </span><br><span class="line">    port: &quot;&#123;&#123;  http_port &#125;&#125;/tcp&quot;</span><br><span class="line">    permanent: yes </span><br><span class="line">    immediate: yes </span><br><span class="line">    state: enabled</span><br><span class="line">  when: http_port is defined</span><br></pre></td></tr></table></figure>
<p>5)开启服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">---                                                                                                                                                                           </span><br><span class="line">- hosts: all </span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    http_port: 8080</span><br><span class="line">  tasks:</span><br><span class="line">  - name: install httpd package</span><br><span class="line">    yum:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: present</span><br><span class="line">  - name: create a web content</span><br><span class="line">    copy:</span><br><span class="line">      src: index.html</span><br><span class="line">      dest: /var/www/html/index.html</span><br><span class="line">  - name: config file</span><br><span class="line">    template:</span><br><span class="line">      src: httpd.conf.j2</span><br><span class="line">      dest: /etc/httpd/conf/httpd.conf</span><br><span class="line">    notify: restart_httpd</span><br><span class="line">    when: http_port is defined                                                                                                                                                </span><br><span class="line">  - name: firewalld configuration</span><br><span class="line">    firewalld:                                                                   </span><br><span class="line">      port: &quot;&#123;&#123;  http_port &#125;&#125;/tcp&quot;</span><br><span class="line">      permanent: yes </span><br><span class="line">      immediate: yes </span><br><span class="line">      state: enabled</span><br><span class="line">    when: http_port is defined</span><br><span class="line">  - name: start service</span><br><span class="line">    service: </span><br><span class="line">      name: httpd </span><br><span class="line">      state: started </span><br><span class="line">      enabled: yes</span><br><span class="line">  handlers:</span><br><span class="line">  - name: restart_httpd</span><br><span class="line">    service:</span><br><span class="line">      name: httpd</span><br><span class="line">      state: restarted</span><br></pre></td></tr></table></figure>
<p>验证端口及主页</p>
<p>ansible all -m shell -a “ss -tunlp|grep httpd”</p>
<h2 id="任务分析：">任务分析：</h2>
<p>1.配置 httpd 的时候，可能存在配置文件，配置文件可能含有变量</p>
<p>2.必要变量的定义</p>
<p>3.源码文件的定义</p>
<h2 id="创建httpd角色框架">创建httpd角色框架</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-galaxy init httpd</span><br></pre></td></tr></table></figure>
<p>查看目录结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@controller roles]# tree httpd</span><br><span class="line">httpd</span><br><span class="line">├── defaults</span><br><span class="line">│  └── main.yml</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">├── tests</span><br><span class="line">│   ├── inventory</span><br><span class="line">│   └── test.yml</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br></pre></td></tr></table></figure>
<h2 id="部署完善httpd角色框架">部署完善httpd角色框架</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd roles/httpd/tasks/</span><br><span class="line">touch install.yml conf_template.yml service.yml index.yml   httpd_firewalld.yml</span><br></pre></td></tr></table></figure>
<h2 id="定义分任务-tasks-中存放">定义分任务(tasks/中存放)</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vim install.yml</span><br><span class="line">- name: install httpd package</span><br><span class="line">  yum: </span><br><span class="line">    name: httpd</span><br><span class="line">    state: present</span><br><span class="line">     </span><br><span class="line">vim conf_template.yml</span><br><span class="line">- name: config file</span><br><span class="line">  template: </span><br><span class="line">    src: httpd.conf.j2 </span><br><span class="line">    dest: /etc/httpd/conf/httpd.conf </span><br><span class="line">  notify: restart_httpd</span><br><span class="line">  when: http_port is defined</span><br><span class="line">         </span><br><span class="line">vim service.yml</span><br><span class="line">- name: start service</span><br><span class="line">  service: </span><br><span class="line">    name: httpd </span><br><span class="line">    state: started </span><br><span class="line">    enabled: yes</span><br><span class="line">    </span><br><span class="line">vim  index.yml</span><br><span class="line">- name: create a web content</span><br><span class="line">  copy:</span><br><span class="line">    src: index.html</span><br><span class="line">    dest: /var/www/html/index.html</span><br><span class="line"></span><br><span class="line">vim httpd_firewalld.yml</span><br><span class="line">- name: firewalld configuration</span><br><span class="line">  firewalld:</span><br><span class="line">    port: &quot;&#123;&#123;  http_port &#125;&#125;/tcp&quot;</span><br><span class="line">    permanent: yes</span><br><span class="line">    immediate: yes</span><br><span class="line">    state: enabled</span><br><span class="line">  when: http_port is defined</span><br></pre></td></tr></table></figure>
<h2 id="定义主任务-tasks-main-yml">定义主任务(tasks/main.yml)</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">创建main.yml主控文件,调用以上单独的yml文件,main.yml定义了谁先执行谁后执行的顺序</span><br><span class="line">vim main.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: index.yml</span><br><span class="line">- include: conf_template.yml</span><br><span class="line">- include: httpd_firewalld.yml</span><br><span class="line">- include: service.yml</span><br></pre></td></tr></table></figure>
<h2 id="定义变量（vars-main-yml）">定义变量（vars/main.yml）</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ansible/roles/httpd/vars/main.yml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">#vars file for httpd</span><br><span class="line">http_port: 8080</span><br></pre></td></tr></table></figure>
<h2 id="定义首页文件（files-index-html）">定义首页文件（files/index.html）</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd    /etc/ansible/roles/httpd/files/</span><br><span class="line">vim index.html</span><br><span class="line">&lt;h1&gt; welcome to wd home &lt;\h1&gt;</span><br></pre></td></tr></table></figure>
<h2 id="定义模板-templates-httpd-conf-j2">定义模板(templates/httpd.conf.j2 )</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line"></span><br><span class="line">cp /etc/httpd/conf/httpd.conf  /etc/ansible/roles/httpd/templates/httpd.conf.j2 </span><br><span class="line"></span><br><span class="line">vim templates/httpd.conf.j2</span><br><span class="line">将LISTEN 80 行修改为以下内容</span><br><span class="line">&#123;% if http_port is defined %&#125;</span><br><span class="line">Listen &#123;&#123; ansible_facts.default_ipv4.address &#125;&#125;:&#123;&#123; http_port &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="定义角色处理程序（handlers-mail-yml）">定义角色处理程序（handlers/mail.yml）</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ansible/roles/httpd/handlers/main.yml</span><br><span class="line">- name: restart_httpd</span><br><span class="line">  service: </span><br><span class="line">    name: httpd </span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure>
<h2 id="调用角色，配置httpd服务（roles-role-httpd-yml）">调用角色，配置httpd服务（roles/role_httpd.yml）</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/ansidle/roles</span><br><span class="line">vim role_httpd.yml</span><br><span class="line">---</span><br><span class="line"># httpd role</span><br><span class="line">- name: httpd deployment</span><br><span class="line">  hosts: websrvs</span><br><span class="line">  remote_user: root    </span><br><span class="line">  </span><br><span class="line">  roles:       #调用角色</span><br><span class="line">  - httpd   </span><br></pre></td></tr></table></figure>
<h2 id="检查语法及冒烟运行">检查语法及冒烟运行</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook role_httpd.yml -C</span><br></pre></td></tr></table></figure>
<h2 id="正式执行">正式执行</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook role_httpd.yml</span><br></pre></td></tr></table></figure>
<h2 id="验证服务">验证服务</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a &quot;ss -tunlp |grep httpd&quot;</span><br><span class="line">curl 192.168.142.101:8080</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<div class="tbsm" style="margin-top:54px;">
<div class="tbsm-top"><span><svg t="1674654360507" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="987" data-spm-anchor-id="a313x.7781069.0.i0" width="35" height="35"><path d="M410.49 97.74H155.08a56.74 56.74 0 0 0-56.84 56.73V410a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 410V154.58a56.83 56.83 0 0 0-56.83-56.84zM410.49 558.74H155.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#66EEFF" p-id="988"></path><path d="M410.49 558.74h-4.14A475 475 0 0 0 299.52 859.6a481.16 481.16 0 0 0 4.84 68.22h106.13A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#C2F8FF" p-id="989"></path></svg></span><span style="font-size:30px;"> 特别声明</span></div>
<div class="tbsm-wz">千屹博客旗下的所有文章，是通过本人课堂学习和课外自学所精心整理的知识巨著<br/>难免会有出错的地方<br/>如果细心的你发现了小失误，可以在下方评论区告诉我，或者私信我！<br />非常感谢大家的热烈支持！</div>
</div>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.qianyios.top">严千屹</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.qianyios.top/posts/27532/">https://blog.qianyios.top/posts/27532/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.qianyios.top" target="_blank">严千屹博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Centos-7/">Centos 7</a><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a></div><div class="post-share"><div class="social-share" data-image="https://article.biliimg.com/bfs/article/ac1131395d7a2b36ca5fb6d28c8017662fb8697a.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxzf.png" target="_blank"><img class="post-qr-code-img" src="/img/wxzf.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/zfb.png" target="_blank"><img class="post-qr-code-img" src="/img/zfb.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/28626/" title="Python-总手册"><img class="cover" src="https://article.biliimg.com/bfs/article/d84b0e6fb4cc10b6122bfb0326b7206ee81e9099.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Python-总手册</div></div><div class="info-2"><div class="info-item-1">Python-总手册，先看这个哦</div></div></div></a><a class="pagination-related" href="/posts/52877/" title="先电IaaS2.2部署OpenStack"><img class="cover" src="/../img/xiandian-openstack/62d99025ddef2fe788c2f582959cda640cd25815.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">先电IaaS2.2部署OpenStack</div></div><div class="info-2"><div class="info-item-1">企业私有云平台部署</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible-%E6%80%BB%E6%89%8B%E5%86%8C"><span class="toc-number">1.</span> <span class="toc-text">Ansible-总手册</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible%E4%B8%89%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">Ansible三机部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E"><span class="toc-number">2.1.</span> <span class="toc-text">关于</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%88%86%E5%B8%83"><span class="toc-number">2.2.</span> <span class="toc-text">主机分布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">2.3.</span> <span class="toc-text">修改主机名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%98%BF%E9%87%8Cyum"><span class="toc-number">2.4.</span> <span class="toc-text">设置阿里yum</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85python"><span class="toc-number">2.5.</span> <span class="toc-text">安装python</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Ansible"><span class="toc-number">2.6.</span> <span class="toc-text">安装Ansible</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.7.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%B8%BB%E6%9C%BA%E6%98%AF%E5%90%A6%E5%AD%98%E6%B4%BB"><span class="toc-number">2.7.1.</span> <span class="toc-text">测试主机是否存活</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSH%E5%85%8D%E5%AF%86%E9%85%8D%E7%BD%AE"><span class="toc-number">2.8.</span> <span class="toc-text">SSH免密配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible%E9%85%8D%E7%BD%AE%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">Ansible配置及相关指令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">ansible 程序结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE%E9%A1%BA%E5%BA%8F"><span class="toc-number">3.2.</span> <span class="toc-text">ansible配置文件查找顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">ansible配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%86%E7%B1%BB%E4%B8%8E%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">3.3.1.</span> <span class="toc-text">配置文件的分类与优先级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%80%89%E9%A1%B9"><span class="toc-number">3.3.2.</span> <span class="toc-text">配置文件选项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansuble%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95"><span class="toc-number">3.4.</span> <span class="toc-text">ansuble主机清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">3.5.</span> <span class="toc-text">ansible 常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible-%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.5.1.</span> <span class="toc-text">ansible 命令详解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-%E9%85%8D%E7%BD%AE%E5%85%AC%E7%A7%81%E9%92%A5"><span class="toc-number">3.6.</span> <span class="toc-text">ansible 配置公私钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-ping%E6%A8%A1%E5%9D%97"><span class="toc-number">3.7.</span> <span class="toc-text">ansible ping模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E8%BF%9E%E9%80%9A%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="toc-number">3.7.1.</span> <span class="toc-text">主机连通性测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BA%A7ansible%E7%8E%AF%E5%A2%83%E6%9E%84%E5%BB%BA"><span class="toc-number">4.</span> <span class="toc-text">用户级ansible环境构建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%88%86%E5%B8%83-2"><span class="toc-number">4.1.</span> <span class="toc-text">主机分布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAstudent%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.</span> <span class="toc-text">创建student用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller%E5%88%9B%E5%BB%BAstudent%E7%94%A8%E6%88%B7%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><span class="toc-number">4.3.</span> <span class="toc-text">controller创建student用户工作目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#controller%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6ansible-cfg"><span class="toc-number">4.4.</span> <span class="toc-text">controller编辑配置文件ansible.cfg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%B8%85%E5%8D%95%E4%B8%BB%E6%9C%BA%E5%AD%98%E6%B4%BB%EF%BC%88%E6%8C%87%E5%AE%9Aroot%EF%BC%89"><span class="toc-number">4.5.</span> <span class="toc-text">验证清单主机存活（指定root）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%EF%BC%88%E6%8C%87%E5%AE%9Astudent%EF%BC%89"><span class="toc-number">4.6.</span> <span class="toc-text">实例（指定student）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%8F%90%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">4.7.</span> <span class="toc-text">测试提取文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">5.</span> <span class="toc-text">Ansible-常用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#command%E6%A8%A1%E5%9D%97"><span class="toc-number">5.1.</span> <span class="toc-text">command模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shell%E6%A8%A1%E5%9D%97"><span class="toc-number">5.2.</span> <span class="toc-text">shell模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.</span> <span class="toc-text">文件模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#copy%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.1.</span> <span class="toc-text">copy模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">5.3.1.1.</span> <span class="toc-text">使用案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0"><span class="toc-number">5.3.1.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#script%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.2.</span> <span class="toc-text">script模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fetch%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.3.</span> <span class="toc-text">fetch模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.4.</span> <span class="toc-text">file模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BE%E5%A0%82%E7%BB%83%E4%B9%A0"><span class="toc-number">5.3.4.1.</span> <span class="toc-text">课堂练习</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lineinfile%E6%A8%A1%E5%9D%97"><span class="toc-number">5.3.5.</span> <span class="toc-text">lineinfile模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%8C%85%E6%A8%A1%E5%9D%97"><span class="toc-number">5.4.</span> <span class="toc-text">软件包模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yum%E6%A8%A1%E5%9D%97"><span class="toc-number">5.4.1.</span> <span class="toc-text">yum模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97"><span class="toc-number">5.5.</span> <span class="toc-text">系统模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#user%E6%A8%A1%E5%9D%97"><span class="toc-number">5.5.1.</span> <span class="toc-text">user模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#group%E7%BB%84%E6%A8%A1%E5%9D%97"><span class="toc-number">5.5.2.</span> <span class="toc-text">group组模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service%E6%A8%A1%E5%9D%97"><span class="toc-number">5.5.3.</span> <span class="toc-text">service模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#firewalld%E6%A8%A1%E5%9D%97"><span class="toc-number">5.5.4.</span> <span class="toc-text">firewalld模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E7%BB%83%E4%B9%A0"><span class="toc-number">5.6.</span> <span class="toc-text">综合练习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible-Playbook"><span class="toc-number">6.</span> <span class="toc-text">Ansible-Playbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YAML%E8%AF%AD%E6%B3%95"><span class="toc-number">6.2.</span> <span class="toc-text">YAML语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9vim"><span class="toc-number">6.3.</span> <span class="toc-text">修改vim</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#playbook%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6"><span class="toc-number">6.4.</span> <span class="toc-text">playbook基础组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#playbook%E4%B9%A6%E5%86%99%E9%A3%8E%E6%A0%BC"><span class="toc-number">6.5.</span> <span class="toc-text">playbook书写风格</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99playbook"><span class="toc-number">6.6.</span> <span class="toc-text">编写playbook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8Cplaybook"><span class="toc-number">6.7.</span> <span class="toc-text">运行playbook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#handlers-notify"><span class="toc-number">6.8.</span> <span class="toc-text">handlers+notify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TAGS"><span class="toc-number">6.9.</span> <span class="toc-text">TAGS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%8F%98%E9%87%8F"><span class="toc-number">6.10.</span> <span class="toc-text">管理变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8playbook%E4%B8%AD%E5%AE%9A%E4%B9%89"><span class="toc-number">6.10.1.</span> <span class="toc-text">在playbook中定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BE%E5%A0%82%E7%BB%83%E4%B9%A0-2"><span class="toc-number">6.10.1.1.</span> <span class="toc-text">课堂练习</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%8B%AC%E7%AB%8B%E7%9A%84%E5%8F%98%E9%87%8FYAML%E6%96%87%E4%BB%B6%E4%B8%AD%E5%AE%9A%E4%B9%89"><span class="toc-number">6.10.2.</span> <span class="toc-text">在独立的变量YAML文件中定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F%EF%BC%88Facts%E4%BA%8B%E5%AE%9E%EF%BC%89"><span class="toc-number">6.10.3.</span> <span class="toc-text">远程主机上的系统变量（Facts事实）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BFacts%E5%8F%98%E9%87%8F"><span class="toc-number">6.10.3.1.</span> <span class="toc-text">查看Facts变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Facts%E5%8F%98%E9%87%8F"><span class="toc-number">6.10.3.2.</span> <span class="toc-text">使用Facts变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82Facts%E5%8F%98%E9%87%8F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">6.10.3.3.</span> <span class="toc-text">复杂Facts变量的使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%ADFacts"><span class="toc-number">6.10.3.4.</span> <span class="toc-text">关闭Facts</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-etc-ansible-hosts-%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95-%E4%B8%AD%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">6.10.4.</span> <span class="toc-text">在&#x2F;etc&#x2F;ansible&#x2F;hosts(主机清单)中定义变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8C%87%E5%AE%9A%E5%8F%98%E9%87%8F"><span class="toc-number">6.10.5.</span> <span class="toc-text">通过命令行指定变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%8F%98%E9%87%8F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">6.10.6.</span> <span class="toc-text">复杂变量的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E7%BB%84"><span class="toc-number">6.10.6.1.</span> <span class="toc-text">数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E5%85%B8%EF%BC%88dictionary%EF%BC%89"><span class="toc-number">6.10.6.2.</span> <span class="toc-text">字典（dictionary）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%8F%98%E9%87%8F"><span class="toc-number">6.10.7.</span> <span class="toc-text">注册变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ansible-Vault%EF%BC%88Ansible-%E4%BF%9D%E7%AE%A1%E7%AE%B1%EF%BC%89"><span class="toc-number">6.11.</span> <span class="toc-text">Ansible Vault（Ansible 保管箱）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">6.11.1.</span> <span class="toc-text">创建一个加密文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E5%8A%A0%E5%AF%86%E8%BF%87%E7%9A%84%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%EF%BC%9A"><span class="toc-number">6.11.2.</span> <span class="toc-text">如何查看加密过的文件内容：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8%E5%89%A7%E6%9C%AC%E4%B8%AD%E8%B0%83%E7%94%A8%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6"><span class="toc-number">6.11.3.</span> <span class="toc-text">如何在剧本中调用加密文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86"><span class="toc-number">6.11.4.</span> <span class="toc-text">解密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E4%B8%80%E4%B8%AA%E5%B7%B2%E5%AD%98%E5%9C%A8%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">6.11.5.</span> <span class="toc-text">加密一个已存在的文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6%E7%9A%84%E5%AF%86%E7%A0%81"><span class="toc-number">6.11.6.</span> <span class="toc-text">重置加密文件的密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E5%B7%B2%E5%AD%98%E5%9C%A8%E7%9A%84%E5%8A%A0%E5%AF%86%E6%96%87%E4%BB%B6"><span class="toc-number">6.11.7.</span> <span class="toc-text">编辑已存在的加密文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5"><span class="toc-number">6.12.</span> <span class="toc-text">综合实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible-templates"><span class="toc-number">7.</span> <span class="toc-text">Ansible-templates</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JINJA2%E8%AF%AD%E6%B3%95%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.1.</span> <span class="toc-text">JINJA2语法简要介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Playbook%E7%9A%84%E8%BF%9B%E9%98%B6%E5%BA%94%E7%94%A8"><span class="toc-number">7.2.</span> <span class="toc-text">Playbook的进阶应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8when%E5%AE%9E%E7%8E%B0%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="toc-number">7.2.1.</span> <span class="toc-text">使用when实现条件判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8with-items%E5%AE%9E%E7%8E%B0%E8%BF%AD%E4%BB%A3"><span class="toc-number">7.2.2.</span> <span class="toc-text">使用with_items实现迭代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%89%93%E5%8D%B01%E3%80%812%E3%80%813"><span class="toc-number">7.2.3.</span> <span class="toc-text">示例：打印1、2、3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-number">7.2.4.</span> <span class="toc-text">示例：创建用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%8B%B7%E8%B4%9D%E5%A4%9A%E4%B8%AA%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.5.</span> <span class="toc-text">示例：拷贝多个文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E8%BF%AD%E4%BB%A3%E5%AD%97%E5%85%B8"><span class="toc-number">7.2.6.</span> <span class="toc-text">示例：迭代字典</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E5%A0%82%E4%BD%9C%E4%B8%9A%EF%BC%9A%E4%BD%BF%E7%94%A8with%E2%80%94items%E6%8B%B7%E8%B4%9D%E5%A4%9A%E4%B8%AA%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.7.</span> <span class="toc-text">课堂作业：使用with—items拷贝多个文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#when%E5%92%8Cwith-items%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-number">7.2.7.1.</span> <span class="toc-text">when和with items组合使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#templates-%E6%A8%A1%E6%9D%BF"><span class="toc-number">7.3.</span> <span class="toc-text">templates 模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#templates%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">7.3.1.</span> <span class="toc-text">templates的使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Ahttpd-conf%E7%9A%84templates%E6%A8%A1%E6%9D%BF"><span class="toc-number">7.3.1.1.</span> <span class="toc-text">示例：httpd.conf的templates模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tamplates-for-%E5%BE%AA%E7%8E%AF"><span class="toc-number">7.3.1.2.</span> <span class="toc-text">tamplates-for(循环)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Ayaml%E6%96%87%E4%BB%B6%E4%B8%AD%E5%8F%98%E9%87%8F%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">7.3.2.</span> <span class="toc-text">示例：yaml文件中变量的调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E4%BA%8B%E5%AE%9E%E5%8F%98%E9%87%8F%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">7.3.3.</span> <span class="toc-text">示例：事实变量的调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tamplates-if%EF%BC%88%E5%88%A4%E6%96%AD%EF%BC%89"><span class="toc-number">7.3.3.1.</span> <span class="toc-text">tamplates-if（判断）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-number">7.3.4.</span> <span class="toc-text">示例：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B%EF%BC%9Anginx-templates"><span class="toc-number">7.4.</span> <span class="toc-text">综合案例：nginx templates</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Roles"><span class="toc-number">8.</span> <span class="toc-text">Roles</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#roles%E9%BB%98%E8%AE%A4%E8%B7%AF%E5%BE%84%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.1.</span> <span class="toc-text">roles默认路径设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Roles%E5%90%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%8F%8A%E4%BD%9C%E7%94%A8"><span class="toc-number">8.2.</span> <span class="toc-text">Roles各目录结构及作用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BArole%E6%A1%86%E6%9E%B6"><span class="toc-number">8.2.1.</span> <span class="toc-text">创建role框架</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%EF%BC%9A%E5%AE%89%E8%A3%85httpd%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.</span> <span class="toc-text">实验任务：安装httpd服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">9.1.</span> <span class="toc-text">任务分析：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAhttpd%E8%A7%92%E8%89%B2%E6%A1%86%E6%9E%B6"><span class="toc-number">9.2.</span> <span class="toc-text">创建httpd角色框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%8C%E5%96%84httpd%E8%A7%92%E8%89%B2%E6%A1%86%E6%9E%B6"><span class="toc-number">9.3.</span> <span class="toc-text">部署完善httpd角色框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%88%86%E4%BB%BB%E5%8A%A1-tasks-%E4%B8%AD%E5%AD%98%E6%94%BE"><span class="toc-number">9.4.</span> <span class="toc-text">定义分任务(tasks&#x2F;中存放)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%BB%E4%BB%BB%E5%8A%A1-tasks-main-yml"><span class="toc-number">9.5.</span> <span class="toc-text">定义主任务(tasks&#x2F;main.yml)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F%EF%BC%88vars-main-yml%EF%BC%89"><span class="toc-number">9.6.</span> <span class="toc-text">定义变量（vars&#x2F;main.yml）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E9%A6%96%E9%A1%B5%E6%96%87%E4%BB%B6%EF%BC%88files-index-html%EF%BC%89"><span class="toc-number">9.7.</span> <span class="toc-text">定义首页文件（files&#x2F;index.html）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%A8%A1%E6%9D%BF-templates-httpd-conf-j2"><span class="toc-number">9.8.</span> <span class="toc-text">定义模板(templates&#x2F;httpd.conf.j2 )</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%A7%92%E8%89%B2%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%EF%BC%88handlers-mail-yml%EF%BC%89"><span class="toc-number">9.9.</span> <span class="toc-text">定义角色处理程序（handlers&#x2F;mail.yml）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E8%A7%92%E8%89%B2%EF%BC%8C%E9%85%8D%E7%BD%AEhttpd%E6%9C%8D%E5%8A%A1%EF%BC%88roles-role-httpd-yml%EF%BC%89"><span class="toc-number">9.10.</span> <span class="toc-text">调用角色，配置httpd服务（roles&#x2F;role_httpd.yml）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%AF%AD%E6%B3%95%E5%8F%8A%E5%86%92%E7%83%9F%E8%BF%90%E8%A1%8C"><span class="toc-number">9.11.</span> <span class="toc-text">检查语法及冒烟运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%BC%8F%E6%89%A7%E8%A1%8C"><span class="toc-number">9.12.</span> <span class="toc-text">正式执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.13.</span> <span class="toc-text">验证服务</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(/img/bg.png);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2024 - 2025 By 严千屹</span></div><div class="footer_custom_text"><span style="display: block; text-align: center; color: white;">严千屹博客</span>
<a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener" style="display: block; text-align: center; color: white; text-decoration: none; cursor: pointer; position: relative; z-index: 9999;">
  ICP备案号:粤ICP备2024250479号
</a>
<div class="post-reward" style="margin-top:0px;margin-bottom:20px"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wxzf.png" target="_blank"><img class="post-qr-code-img" src="/img/wxzf.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/zfb.png" target="_blank"><img class="post-qr-code-img" src="/img/zfb.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div>
</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/instant.page/instantpage.js" type="module"></script><script src="/pluginsSrc/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.qianyios.top',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.qianyios.top',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://s4.zstatic.net/ajax/libs/twikoo/1.6.39/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="/pluginsSrc/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/pluginsSrc/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>